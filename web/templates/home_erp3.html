<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{Id_empresa}}</title>


    <!-- bootstrap-wysiwyg -->
    <link href="/static/vendors/google-code-prettify/bin/prettify.min.css" rel="stylesheet">
    <link href="/static/vendors/select2/dist/css/select2.min.css" rel="stylesheet">
    <link href="/static/vendors/switchery/dist/switchery.min.css" rel="stylesheet">
    <link href="/static/vendors/starrr/dist/starrr.css" rel="stylesheet">
    <link href="/static/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="/static/vendors/nprogress/nprogress.css" rel="stylesheet">
    <link href="/static/vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <link href="/static/vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
    <link href="/static/vendors/jqvmap/dist/jqvmap.min.css" rel="stylesheet"/>
    <link href="/static/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <link href="/static/vendors/dropzone/dist/min/dropzone.min.css" rel="stylesheet">
    <link href="/static/build/css/custom.min.css" rel="stylesheet">
    <script src="/static/vendors/jquery/dist/jquery.min.js"></script>
    <script src="/static/numeroALetras.js" type="text/javascript"></script> 
    <script src="/static/charts/Chart.min.js"></script> 
    <script src="/static/charts/utils.js"></script> 
    <script type="text/javascript" src="/static/echarts/echarts-all-english-v2.js"></script>
    <script src="/static/jspdf.debug.js"></script>
    <script src="/static/buffer.js"></script>
    <script src="/static/forge.min.js"></script>
    <script src="/static/moment.min.js"></script>
    <script async="" src="/static/analytics.js"></script>
    <!--<script src="/static/Chart.min.js"></script>-->
    <!--<script src="/static/utils.js"></script> -->

  <style>
  canvas{
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
  }
  </style>


<style type="text/css">/* Chart.js */
@keyframes chartjs-render-animation{from{opacity:.99}to{opacity:1}}.chartjs-render-monitor{animation:chartjs-render-animation 1ms}.chartjs-size-monitor,.chartjs-size-monitor-expand,.chartjs-size-monitor-shrink{position:absolute;direction:ltr;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1}.chartjs-size-monitor-expand>div{position:absolute;width:1000000px;height:1000000px;left:0;top:0}.chartjs-size-monitor-shrink>div{position:absolute;width:200%;height:200%;left:0;top:0}</style>

<script type="text/javascript">
var pestalla = 1;


window.cambio_img = 0

//url ='{{certi}}'

//var oReq = new XMLHttpRequest();
//oReq.open("GET", url, true);
//oReq.responseType = "arraybuffer";

//oReq.onload = function (oEvent) {
//  var arrayBuffer = oReq.response; // Note: not oReq.responseText
//  if (arrayBuffer) {
//    window.contenido_p12 = arrayBuffer

//  }

//};

//oReq.send(null);



function pre_ejecutados(){

          $.ajax({
            type: 'POST',
            url: '/pre_ejecutados',
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}'},
            beforeSend: function () {},
            success: function(Response){
              for (var i = 0; i < Response["pre_valores"].length; i++) {
                reporte_ejecutar_directo(Response["pre_valores"][i])
              };

            }
          });

}

function reporte_ejecutar_directo(datos){
    pestalla = pestalla  +1  

    $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">' + datos['nombre'] + ' <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a> </li>');

    $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> <div style="padding-top: 15px;"> Procesando </div></div>');

  senten = []
  str1 = []
  str2 = []
  str3 = []
  str4 = []
  str5 = []

  label = {}
  varref = {}
  varvar = {}

    for (x2 = 0; x2 < datos["senten"][0].length; x2++) {
      str1.push(datos["senten"][0][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < datos["senten"][1].length; x2++) {
      str2.push(datos["senten"][1][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < datos["senten"][2].length; x2++) {
      str3.push(datos["senten"][2][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < datos["senten"][3].length; x2++) {
      str4.push(datos["senten"][3][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < datos["senten"][4].length; x2++) {
      str5.push(datos["senten"][4][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < str1.length; x2++) {
      senten.push(str1[x2] + str2[x2] + str3[x2] + str4[x2] + str5[x2])
    }

    for (x = 0; x < datos["ref"].length; x++) {
      //id_tem =  "rpzz" + tem_pestalla + "zz"+ x + "zz" + Response["referencias_reprotes"][x]["id"]
      //varref[Response["referencias_reprotes"][x]["id_rep"]] = String(document.getElementById(id_tem).value)  
      //label[Response["referencias_reprotes"][x]["id_rep"]] = Response["referencias_reprotes"][x]["glosa"]
    }

    for (x = 0; x < datos["var"].length; x++) {
      //id_tem =  "var-"+ tem_pestalla + "-"+ Response["variables_reprotes"][x]["id"]
      //varvar[Response["variables_reprotes"][x]["id_rep"]] = String(document.getElementById(id_tem).value)    
      //label[Response["variables_reprotes"][x]["id_rep"]] = Response["variables_reprotes"][x]["glosa"]
  
    }
  $.ajax({
          type: 'POST',
          url: '/reporte_ejecutar',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','senten': JSON.stringify(senten), 'usuario':'{{usuario}}', 'label':JSON.stringify(label), 'varref':JSON.stringify(varref),'varvar':JSON.stringify(varvar), 'pestalla':pestalla, 'id':datos["pk"], 'nombre_rep':Response["nombre_rep"]},
          beforeSend: function () {
             
            data_int = '<div class="col-md-12" style="padding-top: 15px;"><div class="col-middle"><button type="button" onclick="cerrar_elemento(' + pestalla +')" class="btn btn-warning"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button><div class="text-center text-center"><h1 class="error-number"></h1><h2>{{idioma_html.espere}}</h2><p>{{idioma_html.carga}}.</p><div class="weather-icon"><span><canvas height="84" width="84" id="partly-cloudy-day"></canvas></span></div></div></div></div>'
            $('#rr' +pestalla).html(data_int);            


            },
          success: function(Response){

            dict_pestalla['p-'+Response["pestalla"]] = Response
            dict_pestalla['p-'+Response["pestalla"]]["vinculacion"] = {}
            reppuesta_rep = Response["resutado"]

            data_int =  '<div style="padding-top: 15px;"><div class="panel-body" style="overflow: auto;"><div class="row"><button class="btn btn-primary" id="reporteejecutar" name="reporteejecutar" type="submit" value="4" onclick="reejecutar_reprote(' + Response["id"] + ')">{{idioma_html.nuevo}}</button><button type="button" onclick="cerrar_elemento(' + Response["pestalla"] + ')" class="btn btn-warning"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button><button type="button" data-toggle="tooltip" data-placement="top" title="Pdf" onclick="pdf_reporte(' + Response["pestalla"] + ')" class="btn btn-info"><span class="fa fa-file-pdf-o" aria-hidden="true"></span></button><button type="button" data-toggle="tooltip" data-placement="top" title="Excell" onclick="excell_reporte(' + Response["pestalla"] + ')" class="btn btn-info"><span class="fa fa-file-excel-o" aria-hidden="true"></span></button>filtrar: <input type="text" id="fil_rep-' + Response["pestalla"] + '" onkeypress="return runScript_rep_filtro(event, ' + Response["pestalla"] + ')"></div>'
            data_int = data_int + '<div style="overflow: auto;height: 600px;">'

            data_int = data_int + html_rep(reppuesta_rep, Response["pestalla"]) + '</div>'


            $('#rr' +Response["pestalla"]).html(data_int);  



          } 
    });

}



function solo_abrir_subrep(temp_pest, fila, nivel){
    tr = document.getElementById('dr-' + temp_pest +'-'+ fila +'-'+ nivel)
    btn = document.getElementById('btn-' + temp_pest +'-'+ fila +'-'+ nivel)
    tr.hidden = false
    btn.innerHTML = '<span class="fa fa-minus" aria-hidden="true"></span>'
    btn.style.backgroundColor = "cornflowerblue"

}


          

function runScript_rep_filtro(e, pestana_int) {
    if (e.keyCode == 13) {
        filtrar_reporte(pestana_int)
    }
}          
          
function cerrar_subrep(temp_pest, fila, nivel){
    tr = document.getElementById('dr-' + temp_pest +'-'+ fila +'-'+ nivel)
    btn = document.getElementById('btn-' + temp_pest +'-'+ fila +'-'+ nivel)
    tr.hidden = true
    btn.innerHTML = '<span class="fa fa-plus" aria-hidden="true"></span>'
    btn.style.backgroundColor = "darkblue"
}


function abrir_subrep_arbol(temp_pest, nivel, fila){
    tr = document.getElementById('dr-' + temp_pest +'-'+ base["vinculacion"][nivel +'-'+ fila] +'-'+ (nivel-1))

    //if(tr.hidden != false){
        btn = document.getElementById('btn-' + temp_pest +'-'+ base["vinculacion"][nivel +'-'+ fila] +'-'+ (nivel-1))
        tr.hidden = false
        btn.innerHTML = '<span class="fa fa-minus" aria-hidden="true"></span>'
        btn.style.backgroundColor = "cornflowerblue"

        if(nivel >1 ){
            abrir_subrep_arbol(temp_pest, (nivel-1), base["vinculacion"][nivel +'-'+ fila])
        }
    //}
}
   


function filtrar_reporte(pestana_int){
    base = dict_pestalla['p-'+ pestana_int]
    if(base["resutado"].length > 1){
        v_filtro = document.getElementById('fil_rep-' + pestana_int ).value
        if(v_filtro != ''){
            x=  base["resutado"].length-1
            for (x2 = 0; x2 < base["resutado"][x][1].length; x2++) {
                for (x3 = 0; x3 < base["resutado"][x][1][x2].length; x3++) {
                    if(base["resutado"][x][1][x2][x3].toString().toLowerCase().includes(v_filtro.toString().toLowerCase()) == true){
                        //cab = dict_pestalla['p-'+Response["pestalla"]]["vinculacion"]['1-'+ x] 
                        tr = document.getElementById('dr-' + pestana_int +'-'+ base["vinculacion"][x +'-'+ x2] +'-'+ (x-1))
                        //if(tr.hidden != false){
                        abrir_subrep_arbol(pestana_int, x, x2)
                        //}
                    }
                }
            }
        }
    }
}

function ConsultaContribuyente(){   
numeroruc = document.getElementById("val_ruc").value
        
        $.ajax({
        type:'POST',
        url: 'http://datosec.com/app/datosfiscales/consultaDeDatos.php?wsdl',
        data: {
            func:'consultaDeDatos',
            ruc:numeroruc
        }, 
        success: function(data){
            if(data!=null)
            {
               
                    
                
            }
        },
        error : function(XMLHttpRequest, textStatus, errorThrown) {
            var xdata='';
        },
        });  
}


function cargarContenidoP12(evt){
    var file = evt.target.files[0];
    reader = new FileReader();
    
    reader.addEventListener("loadend", function (event) {
        window.contenido_p12 = event.target.result;

    }, false);
    
    //reader.readAsDataURL(file);
    reader.readAsArrayBuffer(file);
}



function devolver_clave_acceso(int_pestalla, nom_campo, datos_cab, datos_det){
    respu = dict_pestalla['p-'+int_pestalla]
    datos_elec = respu["func_cab"][nom_campo]
    if(datos_elec[0][0]["Cond_campo"] != ""){
      if(datos_cab[0][datos_elec[0][0]["Cond_campo"]] != datos_elec[0][0]["Cond_valor"]){
        return 'Sin AutorizaciÃ³n'
      }
    }
    return traer_clave(moment(), datos_elec[1][0], datos_cab[0][datos_elec[1][0]["secuencial"]] ,datos_cab[0][datos_elec[1][0]["estab"]], datos_cab[0][datos_elec[1][0]["ptoEmi"]])
}


function firma_electronica(int_pestalla, nom_campo, datos_cab, datos_det) {
    respu = dict_pestalla['p-'+int_pestalla]
    datos_elec = respu["func_cab"][nom_campo]
    if(datos_elec[0][0]["Cond_campo"] != ""){
      if(datos_cab[0][datos_elec[0][0]["Cond_campo"]] != datos_elec[0][0]["Cond_valor"]){
        return 0
      }
    }
    xml_str_sin_frm = []
    if(datos_elec[0][0]["Tipo"] == "Factura"){
      xml_str_sin_frm = hacer_xml_factura(datos_elec, datos_cab, datos_det)
    }
    if(datos_elec[0][0]["Tipo"] == "Retencion"){
      xml_str_sin_frm = hacer_xml_retencion(datos_elec, datos_cab, datos_det)
    }
    if(datos_elec[0][0]["Tipo"] == "Nota credito"){
      xml_str_sin_frm = hacer_xml_nota_credito(datos_elec, datos_cab, datos_det)
    }
    if(datos_elec[0][0]["Tipo"] == "Nota debito"){
      xml_str_sin_frm = hacer_xml_nota_debito(datos_elec, datos_cab, datos_det)
    }
    if(datos_elec[0][0]["Tipo"] == "Guia remision"){
      xml_str_sin_frm = hacer_xml_guiaremision(datos_elec, datos_cab, datos_det)
    }
    xml_str_firmado = firmarComprobante(window.contenido_p12, datos_elec[0][0]["Clave"], xml_str_sin_frm[1]) 
    return ([xml_str_firmado, xml_str_sin_frm[0]])
   

}


function firmarComprobante(mi_contenido_p12, mi_pwd_p12, comprobante) {
   
    var arrayUint8 = new Uint8Array(mi_contenido_p12);
    var p12B64 = forge.util.binary.base64.encode(arrayUint8);
    var p12Der = forge.util.decode64(p12B64);
    var p12Asn1 = forge.asn1.fromDer(p12Der);

    var p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, mi_pwd_p12);

    var certBags = p12.getBags({bagType:forge.pki.oids.certBag})
    var cert = certBags[forge.oids.certBag][0].cert;
    var pkcs8bags = p12.getBags({bagType:forge.pki.oids.pkcs8ShroudedKeyBag});
    var pkcs8 = pkcs8bags[forge.oids.pkcs8ShroudedKeyBag][0];
    var key = pkcs8.key;

    if( key == null ) {
        key = pkcs8.asn1;
    }

    certificateX509_pem = forge.pki.certificateToPem(cert);

    certificateX509 = certificateX509_pem;
    certificateX509 = certificateX509.substr( certificateX509.indexOf('\n') );
    certificateX509 = certificateX509.substr( 0, certificateX509.indexOf('\n-----END CERTIFICATE-----') );

    certificateX509 = certificateX509.replace(/\r?\n|\r/g, '').replace(/([^\0]{76})/g, '$1\n');

    //Pasar certificado a formato DER y sacar su hash:
    certificateX509_asn1 = forge.pki.certificateToAsn1(cert);
    certificateX509_der = forge.asn1.toDer(certificateX509_asn1).getBytes();
    certificateX509_der_hash = sha1_base64(certificateX509_der);

    //Serial Number
    var X509SerialNumber = parseInt(cert.serialNumber, 16);

    exponent = hexToBase64(key.e.data[0].toString(16));            
    modulus = bigint2base64(key.n);


    //var sha1_comprobante = sha1_base64(comprobante.replace('<?xml version="1.0" encoding="UTF-8"?>\n', ''), 'utf8');
    var sha1_comprobante = sha1_base64(comprobante, 'utf8');

    var xmlns = 'xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:etsi="http://uri.etsi.org/01903/v1.3.2#"';


    //numeros involucrados en los hash:
    
    //var Certificate_number = 1217155;//p_obtener_aleatorio(); //1562780 en el ejemplo del SRI
    var Certificate_number = p_obtener_aleatorio(); //1562780 en el ejemplo del SRI
    
    //var Signature_number = 1021879;//p_obtener_aleatorio(); //620397 en el ejemplo del SRI
    var Signature_number = p_obtener_aleatorio(); //620397 en el ejemplo del SRI
    
    //var SignedProperties_number = 1006287;//p_obtener_aleatorio(); //24123 en el ejemplo del SRI
    var SignedProperties_number = p_obtener_aleatorio(); //24123 en el ejemplo del SRI

    //numeros fuera de los hash:
    
    //var SignedInfo_number = 696603;//p_obtener_aleatorio(); //814463 en el ejemplo del SRI
    var SignedInfo_number = p_obtener_aleatorio(); //814463 en el ejemplo del SRI
    
    //var SignedPropertiesID_number = 77625;//p_obtener_aleatorio(); //157683 en el ejemplo del SRI
    var SignedPropertiesID_number = p_obtener_aleatorio(); //157683 en el ejemplo del SRI
    
    //var Reference_ID_number = 235824;//p_obtener_aleatorio(); //363558 en el ejemplo del SRI
    var Reference_ID_number = p_obtener_aleatorio(); //363558 en el ejemplo del SRI
    
    //var SignatureValue_number = 844709;//p_obtener_aleatorio(); //398963 en el ejemplo del SRI
    var SignatureValue_number = p_obtener_aleatorio(); //398963 en el ejemplo del SRI
    
    //var Object_number = 621794;//p_obtener_aleatorio(); //231987 en el ejemplo del SRI
    var Object_number = p_obtener_aleatorio(); //231987 en el ejemplo del SRI



    var SignedProperties = '';

    SignedProperties += '<etsi:SignedProperties Id="Signature' + Signature_number + '-SignedProperties' + SignedProperties_number + '">';  //SignedProperties
        SignedProperties += '<etsi:SignedSignatureProperties>';
            SignedProperties += '<etsi:SigningTime>';

                //SignedProperties += '2016-12-24T13:46:43-05:00';//moment().format('YYYY-MM-DD\THH:mm:ssZ');
                SignedProperties += moment().format('YYYY-MM-DD\THH:mm:ssZ');

            SignedProperties += '</etsi:SigningTime>';
            SignedProperties += '<etsi:SigningCertificate>';
                SignedProperties += '<etsi:Cert>';
                    SignedProperties += '<etsi:CertDigest>';
                        SignedProperties += '<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1">';
                        SignedProperties += '</ds:DigestMethod>';
                        SignedProperties += '<ds:DigestValue>';

                            SignedProperties += certificateX509_der_hash;

                        SignedProperties += '</ds:DigestValue>';
                    SignedProperties += '</etsi:CertDigest>';
                    SignedProperties += '<etsi:IssuerSerial>';
                        SignedProperties += '<ds:X509IssuerName>';
                            SignedProperties += 'CN=AC BANCO CENTRAL DEL ECUADOR,L=QUITO,OU=ENTIDAD DE CERTIFICACION DE INFORMACION-ECIBCE,O=BANCO CENTRAL DEL ECUADOR,C=EC';
                        SignedProperties += '</ds:X509IssuerName>';
                    SignedProperties += '<ds:X509SerialNumber>';

                        SignedProperties += X509SerialNumber;

                    SignedProperties += '</ds:X509SerialNumber>';
                    SignedProperties += '</etsi:IssuerSerial>';
                SignedProperties += '</etsi:Cert>';
            SignedProperties += '</etsi:SigningCertificate>';
        SignedProperties += '</etsi:SignedSignatureProperties>';
        SignedProperties += '<etsi:SignedDataObjectProperties>';
            SignedProperties += '<etsi:DataObjectFormat ObjectReference="#Reference-ID-' + Reference_ID_number + '">';
                SignedProperties += '<etsi:Description>';

                    SignedProperties += 'contenido comprobante';                        

                SignedProperties += '</etsi:Description>';
                SignedProperties += '<etsi:MimeType>';
                    SignedProperties += 'text/xml';
                SignedProperties += '</etsi:MimeType>';
            SignedProperties += '</etsi:DataObjectFormat>';
        SignedProperties += '</etsi:SignedDataObjectProperties>';
    SignedProperties += '</etsi:SignedProperties>'; //fin SignedProperties

    SignedProperties_para_hash = SignedProperties.replace('<etsi:SignedProperties', '<etsi:SignedProperties ' + xmlns);

    var sha1_SignedProperties = sha1_base64(SignedProperties_para_hash);        


    var KeyInfo = '';

    KeyInfo += '<ds:KeyInfo Id="Certificate' + Certificate_number + '">';
        KeyInfo += '\n<ds:X509Data>';
            KeyInfo += '\n<ds:X509Certificate>\n';

                //CERTIFICADO X509 CODIFICADO EN Base64 
                KeyInfo += certificateX509;

            KeyInfo += '\n</ds:X509Certificate>';
        KeyInfo += '\n</ds:X509Data>';
        KeyInfo += '\n<ds:KeyValue>';
            KeyInfo += '\n<ds:RSAKeyValue>';
                KeyInfo += '\n<ds:Modulus>\n';

                    //MODULO DEL CERTIFICADO X509
                    KeyInfo += modulus;

                KeyInfo += '\n</ds:Modulus>';
                KeyInfo += '\n<ds:Exponent>';

                    //KeyInfo += 'AQAB';
                    KeyInfo += exponent;

                KeyInfo += '</ds:Exponent>';
            KeyInfo += '\n</ds:RSAKeyValue>';
        KeyInfo += '\n</ds:KeyValue>';
    KeyInfo += '\n</ds:KeyInfo>';

    KeyInfo_para_hash = KeyInfo.replace('<ds:KeyInfo', '<ds:KeyInfo ' + xmlns);

    var sha1_certificado = sha1_base64(KeyInfo_para_hash);


    var SignedInfo = '';

    SignedInfo += '<ds:SignedInfo Id="Signature-SignedInfo' + SignedInfo_number + '">';
        SignedInfo += '\n<ds:CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315">';
        SignedInfo += '</ds:CanonicalizationMethod>';
        SignedInfo += '\n<ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1">';
        SignedInfo += '</ds:SignatureMethod>';
        SignedInfo += '\n<ds:Reference Id="SignedPropertiesID' + SignedPropertiesID_number + '" Type="http://uri.etsi.org/01903#SignedProperties" URI="#Signature' + Signature_number + '-SignedProperties' + SignedProperties_number + '">';
            SignedInfo += '\n<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1">';
            SignedInfo += '</ds:DigestMethod>';
            SignedInfo += '\n<ds:DigestValue>';

                //HASH O DIGEST DEL ELEMENTO <etsi:SignedProperties>';
                SignedInfo += sha1_SignedProperties;

            SignedInfo += '</ds:DigestValue>';
        SignedInfo += '\n</ds:Reference>';
        SignedInfo += '\n<ds:Reference URI="#Certificate' + Certificate_number + '">';
            SignedInfo += '\n<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1">';
            SignedInfo += '</ds:DigestMethod>';
            SignedInfo += '\n<ds:DigestValue>';

                //HASH O DIGEST DEL CERTIFICADO X509
                SignedInfo += sha1_certificado;

            SignedInfo += '</ds:DigestValue>';
        SignedInfo += '\n</ds:Reference>';
        SignedInfo += '\n<ds:Reference Id="Reference-ID-' + Reference_ID_number + '" URI="#comprobante">';
            SignedInfo += '\n<ds:Transforms>';
                SignedInfo += '\n<ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature">';
                SignedInfo += '</ds:Transform>';
            SignedInfo += '\n</ds:Transforms>';
            SignedInfo += '\n<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1">';
            SignedInfo += '</ds:DigestMethod>';
            SignedInfo += '\n<ds:DigestValue>';

                //HASH O DIGEST DE TODO EL ARCHIVO XML IDENTIFICADO POR EL id="comprobante" 
                SignedInfo += sha1_comprobante;

            SignedInfo += '</ds:DigestValue>';
        SignedInfo += '\n</ds:Reference>';
    SignedInfo += '\n</ds:SignedInfo>';

    SignedInfo_para_firma = SignedInfo.replace('<ds:SignedInfo', '<ds:SignedInfo ' + xmlns);

    var md = forge.md.sha1.create();
    md.update(SignedInfo_para_firma, 'utf8');

    var signature = btoa(key.sign(md)).match(/.{1,76}/g).join("\n");


    var xades_bes = '';

    //INICIO DE LA FIRMA DIGITAL 
    xades_bes += '<ds:Signature ' + xmlns + ' Id="Signature' + Signature_number + '">';
        xades_bes += '\n' + SignedInfo;

        xades_bes += '\n<ds:SignatureValue Id="SignatureValue' + SignatureValue_number + '">\n';

            //VALOR DE LA FIRMA (ENCRIPTADO CON LA LLAVE PRIVADA DEL CERTIFICADO DIGITAL) 
            xades_bes += signature;

        xades_bes += '\n</ds:SignatureValue>';

        xades_bes += '\n' + KeyInfo;

        xades_bes += '\n<ds:Object Id="Signature' + Signature_number + '-Object' + Object_number + '">';
            xades_bes += '<etsi:QualifyingProperties Target="#Signature' + Signature_number + '">';

                //ELEMENTO <etsi:SignedProperties>';
                xades_bes += SignedProperties;

            xades_bes += '</etsi:QualifyingProperties>';
        xades_bes += '</ds:Object>';
    xades_bes += '</ds:Signature>';

    //FIN DE LA FIRMA DIGITAL 

    return  comprobante.replace(/(<[^<]+)$/, xades_bes + '$1');
}

function hacer_xml_factura(datos_elec, datos_cab, datos_det) {
    temp_claveAcceso = traer_clave(moment(), datos_elec[1][0], datos_cab[0][datos_elec[1][0]["secuencial"]] ,datos_cab[0][datos_elec[1][0]["estab"]], datos_cab[0][datos_elec[1][0]["ptoEmi"]])
    xml = '<factura id="comprobante" version="1.1.0">'
    xml = xml + '<infoTributaria>'
    xml = xml + '<ambiente>' + datos_elec[1][0]["ambiente"] + '</ambiente>'
    xml = xml + '<tipoEmision>' + datos_elec[1][0]["tipoEmision"] + '</tipoEmision>'
    xml = xml + '<razonSocial>' + datos_elec[1][0]["razonSocial"] + '</razonSocial>'
    xml = xml + '<nombreComercial>' + datos_elec[1][0]["nombreComercial"] + '</nombreComercial>'
    xml = xml + '<ruc>'+ datos_elec[1][0]["ruc"] + '</ruc>'
    xml = xml + '<claveAcceso>'+ temp_claveAcceso + '</claveAcceso>'
    xml = xml + '<codDoc>' + datos_elec[1][0]["codDoc"] + '</codDoc>'
    xml = xml + '<estab>' + datos_cab[0][datos_elec[1][0]["estab"]] + '</estab>'
    xml = xml + '<ptoEmi>' + datos_cab[0][datos_elec[1][0]["ptoEmi"]] + '</ptoEmi>'
    xml = xml + '<secuencial>' + pad(datos_cab[0][datos_elec[1][0]["secuencial"]],9) + '</secuencial>'
    xml = xml + '<dirMatriz>' + datos_elec[1][0]["dirMatriz"]+ '</dirMatriz>'
    xml = xml + '</infoTributaria>'

    xml = xml + '<infoFactura>'


    xml = xml + '<fechaEmision>' + moment().format('DD/MM/YYYY') + '</fechaEmision>'
    xml = xml + '<dirEstablecimiento>' + datos_elec[3][0]["dirEstablecimiento"] + '</dirEstablecimiento>'
    if(datos_elec[3][0]["contribuyenteEspecial"] != "No"){
        xml = xml + '<contribuyenteEspecial>' + datos_elec[3][0]["contribuyenteEspecial"] + '</contribuyenteEspecial>'
    }
    xml = xml + '<obligadoContabilidad>' + datos_elec[3][0]["obligadoContabilidad"] + '</obligadoContabilidad>'
    xml = xml + '<tipoIdentificacionComprador>' + datos_cab[0][datos_elec[3][0]["tipoIdentificacionComprador"]] + '</tipoIdentificacionComprador>'
    xml = xml + '<razonSocialComprador>' + datos_cab[0][datos_elec[3][0]["razonSocialComprador"]] + '</razonSocialComprador>'
    xml = xml + '<identificacionComprador>' + datos_cab[0][datos_elec[3][0]["identificacionComprador"]] + '</identificacionComprador>'
    xml = xml + '<totalSinImpuestos>' + datos_cab[0][datos_elec[3][0]["totalSinImpuestos"]] + '</totalSinImpuestos>'
    xml = xml + '<totalDescuento>' + datos_cab[0][datos_elec[3][0]["totalDescuento"]] + '</totalDescuento>'
    xml = xml + '<totalConImpuestos>'

    if (datos_elec[3][0]["codigo1"] != "9"){
        xml = xml + '<totalImpuesto>'
        xml = xml + '<codigo>' + datos_elec[3][0]["codigo1"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[3][0]["codigoPorcentaje1"] + '</codigoPorcentaje>'
        xml = xml + '<descuentoAdicional>' + datos_cab[0][datos_elec[3][0]["descuento_adicional1"]] + '</descuentoAdicional>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[3][0]["baseImponible1"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[3][0]["valor1"]] + '</valor>'
        xml = xml + '</totalImpuesto>'
    }
    if (datos_elec[3][0]["codigo2"] != "9"){
        xml = xml + '<totalImpuesto>'
        xml = xml + '<codigo>' + datos_elec[3][0]["codigo2"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[3][0]["codigoPorcentaje2"] + '</codigoPorcentaje>'
        xml = xml + '<descuentoAdicional>' + datos_cab[0][datos_elec[3][0]["descuento_adicional2"]] + '</descuentoAdicional>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[3][0]["baseImponible2"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[3][0]["valor2"]] + '</valor>'
        xml = xml + '</totalImpuesto>'
    }

    if (datos_elec[3][0]["codigo3"] != "9"){
        xml = xml + '<totalImpuesto>'
        xml = xml + '<codigo>' + datos_elec[3][0]["codigo3"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[3][0]["codigoPorcentaje3"] + '</codigoPorcentaje>'
        xml = xml + '<descuentoAdicional>' + datos_cab[0][datos_elec[3][0]["descuento_adicional3"]] + '</descuentoAdicional>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[3][0]["baseImponible3"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[3][0]["valor3"]] + '</valor>'
        xml = xml + '</totalImpuesto>'
    }

    xml = xml + '</totalConImpuestos>'

    
    xml = xml + '<propina>' + datos_cab[0][datos_elec[3][0]["propina"]] + '</propina>'
    xml = xml + '<importeTotal>' + datos_cab[0][datos_elec[3][0]["importeTotal"]] + '</importeTotal>'
    xml = xml + '<moneda>' + datos_elec[3][0]["moneda"] + '</moneda>'

    xml = xml + '<pagos>'
    xml = xml + '<pago>'
    xml = xml + '<formaPago>' + datos_cab[0][datos_elec[3][0]["formaPago"]] + '</formaPago>'
    xml = xml + '<total>' + datos_cab[0][datos_elec[3][0]["total"]] + '</total>'
    xml = xml + '<plazo>' + datos_cab[0][datos_elec[3][0]["plazo"]] + '</plazo>'
    xml = xml + '<unidadTiempo>' + datos_cab[0][datos_elec[3][0]["unidadTiempo"]] + '</unidadTiempo>'
    xml = xml + '</pago>'
    xml = xml + '</pagos>'
    xml = xml + '</infoFactura>'
  
    xml = xml + '<detalles>'

    for (y = 0; y < datos_det.length; y++){
        if(isNaN(datos_det[y][datos_elec[4][0]["cantidad"]]) == false){
            if(datos_det[y][datos_elec[4][0]["cantidad"]] > 0){
            
            xml = xml + '<detalle>'
            xml = xml + '<codigoPrincipal>' + datos_det[y][datos_elec[4][0]["codigoPrincipal"]] + '</codigoPrincipal>'
            xml = xml + '<codigoAuxiliar>' +  datos_det[y][datos_elec[4][0]["codigoAuxiliar"]]  + '</codigoAuxiliar>'
            xml = xml + '<descripcion>' +  datos_det[y][datos_elec[4][0]["descripcion"]]  + '</descripcion>'
            xml = xml + '<cantidad>' +  datos_det[y][datos_elec[4][0]["cantidad"]]  + '</cantidad>'
            xml = xml + '<precioUnitario>' +  datos_det[y][datos_elec[4][0]["precioUnitario"]]  + '</precioUnitario>'
            xml = xml + '<descuento>' +  datos_det[y][datos_elec[4][0]["descuento"]]  + '</descuento>'
            xml = xml + '<precioTotalSinImpuesto>' +  datos_det[y][datos_elec[4][0]["precioTotalSinImpuesto"]]  + '</precioTotalSinImpuesto>'
            xml = xml + '<impuestos>'
            xml = xml + '<impuesto>'
            xml = xml + '<codigo>' + datos_det[y][datos_elec[4][0]["codigo"]] + '</codigo>'
            xml = xml + '<codigoPorcentaje>' + datos_det[y][datos_elec[4][0]["codigoPorcentaje"]] + '</codigoPorcentaje>'
            xml = xml + '<tarifa>' + datos_det[y][datos_elec[4][0]["tarifa"]] + '</tarifa>'
            xml = xml + '<baseImponible>' + datos_det[y][datos_elec[4][0]["baseImponible"]] + '</baseImponible>'
            xml = xml + '<valor>' + datos_det[y][datos_elec[4][0]["valor"]] + '</valor>'
            xml = xml + '</impuesto>'
            xml = xml + '</impuestos>'
            xml = xml + '</detalle>'
            }
        }
    }
    xml = xml + '</detalles>'
    xml_adicional  = '<infoAdicional>'

    if(datos_elec[2].length > 0){
        for (y = 0; y < datos_elec[2].length; y++){
            if(datos_cab[0][datos_elec[2][y]["valor"]] != ''){
                xml_adicional = xml_adicional + '<campoAdicional nombre="' + datos_elec[2][y]["nombre"] + '">' + datos_cab[0][datos_elec[2][y]["valor"]] + '</campoAdicional>'
            }

        }
    }
    

    if(xml_adicional != '<infoAdicional>'){
        xml = xml + xml_adicional + '</infoAdicional></factura>'
    }else{
        xml = xml + '</factura>'
    }
    return [temp_claveAcceso, xml]
}

function hacer_xml_retencion(datos_elec, datos_cab, datos_det) {
    temp_claveAcceso = traer_clave(moment(), datos_elec[1][0], datos_cab[0][datos_elec[1][0]["secuencial"]] ,datos_cab[0][datos_elec[1][0]["estab"]], datos_cab[0][datos_elec[1][0]["ptoEmi"]])
    xml = '<comprobanteRetencion id="comprobante" version="1.0.0">'
    xml = xml + '<infoTributaria>'
    xml = xml + '<ambiente>' + datos_elec[1][0]["ambiente"] + '</ambiente>'
    xml = xml + '<tipoEmision>' + datos_elec[1][0]["tipoEmision"] + '</tipoEmision>'
    xml = xml + '<razonSocial>' + datos_elec[1][0]["razonSocial"] + '</razonSocial>'
    xml = xml + '<nombreComercial>' + datos_elec[1][0]["nombreComercial"] + '</nombreComercial>'
    xml = xml + '<ruc>'+ datos_elec[1][0]["ruc"] + '</ruc>'
    xml = xml + '<claveAcceso>'+ temp_claveAcceso + '</claveAcceso>'
    xml = xml + '<codDoc>' + datos_elec[1][0]["codDoc"] + '</codDoc>'
    xml = xml + '<estab>' + datos_cab[0][datos_elec[1][0]["estab"]] + '</estab>'
    xml = xml + '<ptoEmi>' + datos_cab[0][datos_elec[1][0]["ptoEmi"]] + '</ptoEmi>'
    xml = xml + '<secuencial>' + pad(datos_cab[0][datos_elec[1][0]["secuencial"]],9) + '</secuencial>'
    xml = xml + '<dirMatriz>' + datos_elec[1][0]["dirMatriz"]+ '</dirMatriz>'
    xml = xml + '</infoTributaria>'

    xml = xml + '<infoCompRetencion>'


    xml = xml + '<fechaEmision>' + moment().format('DD/MM/YYYY') + '</fechaEmision>'
    xml = xml + '<dirEstablecimiento>' + datos_elec[4][0]["dirEstablecimiento"] + '</dirEstablecimiento>'
    if (datos_elec[4][0]["contribuyenteEspecial"] != "No"){
        xml = xml + '<contribuyenteEspecial>' + datos_elec[4][0]["contribuyenteEspecial"] + '</contribuyenteEspecial>'
    }
    xml = xml + '<obligadoContabilidad>' + datos_elec[4][0]["obligadoContabilidad"] + '</obligadoContabilidad>'
    xml = xml + '<tipoIdentificacionSujetoRetenido>' + datos_cab[0][datos_elec[4][0]["tipoIdentificacionSujetoRetenido"]] + '</tipoIdentificacionSujetoRetenido>'
    xml = xml + '<razonSocialSujetoRetenido>' + datos_cab[0][datos_elec[4][0]["razonSocialSujetoRetenido"]] + '</razonSocialSujetoRetenido>'
    xml = xml + '<identificacionSujetoRetenido>' + datos_cab[0][datos_elec[4][0]["identificacionSujetoRetenido"]] + '</identificacionSujetoRetenido>'
    

    var mydate = new Date(datos_cab[0][datos_elec[4][0]["periodoFiscal"]]);

    xml = xml + '<periodoFiscal>' + mydate.format('m/Y') + '</periodoFiscal>'



    xml = xml + '</infoCompRetencion>'

    xml = xml + '<impuestos>'

    codigos= {}
    codigos_iva= {}

    for (y = 0; y < datos_det.length; y++){
        cod_t = datos_det[y][datos_elec[3][0]["det_codigoRetencion"]]
        if (null == codigos[cod_t]){
            codigos[cod_t] = {'codigoRetencion':cod_t,'baseImponible':datos_det[y][datos_elec[3][0]["det_baseImponible"]],'porcentajeRetener':datos_det[y][datos_elec[3][0]["det_porcentajeRetener"]],'valorRetenido':datos_det[y][datos_elec[3][0]["det_valorRetenido"]]}
        }else{
            codigos[cod_t]['baseImponible'] = parseFloat(codigos[cod_t]['baseImponible']) + parseFloat(datos_det[y][datos_elec[3][0]["det_baseImponible"]]) 
            codigos[cod_t]['valorRetenido'] = parseFloat(codigos[cod_t]['valorRetenido']) +  parseFloat(datos_det[y][datos_elec[3][0]["det_valorRetenido"]])
        }
    }
    for (y = 0; y < datos_det.length; y++){
        cod_t = datos_det[y][datos_elec[3][0]["det_codigoRetencion2"]]
        if (null == codigos_iva[cod_t]){
            codigos_iva[cod_t] = {'codigoRetencion':cod_t,'baseImponible':datos_det[y][datos_elec[3][0]["det_baseImponible2"]],'porcentajeRetener':datos_det[y][datos_elec[3][0]["det_porcentajeRetener2"]],'valorRetenido':datos_det[y][datos_elec[3][0]["det_valorRetenido2"]]}
        }else{
            codigos_iva[cod_t]['baseImponible'] = parseFloat(codigos_iva[cod_t]['baseImponible']) +  parseFloat(datos_det[y][datos_elec[3][0]["det_baseImponible2"]])
            codigos_iva[cod_t]['valorRetenido'] = parseFloat(codigos_iva[cod_t]['valorRetenido']) +  parseFloat(datos_det[y][datos_elec[3][0]["det_valorRetenido2"]])
        }
    }
            

    for (y = 0; y < Object.keys(codigos).length; y++){
        xml = xml + '<impuesto>'
        xml = xml + '<codigo>1</codigo>'
        xml = xml + '<codigoRetencion>' + codigos[Object.keys(codigos)[y]]['codigoRetencion'] + '</codigoRetencion>'
        xml = xml + '<baseImponible>' + codigos[Object.keys(codigos)[y]]['baseImponible'] + '</baseImponible>'
        xml = xml + '<porcentajeRetener>' + codigos[Object.keys(codigos)[y]]['porcentajeRetener'] + '</porcentajeRetener>'
        xml = xml + '<valorRetenido>' + codigos[Object.keys(codigos)[y]]['valorRetenido'] + '</valorRetenido>'

        xml = xml + '<codDocSustento>' + datos_cab[0][datos_elec[3][0]["codDocSustento"]] + '</codDocSustento>'
        numDocSustento = datos_cab[0][datos_elec[3][0]["numDocSustento_est"]] + datos_cab[0][datos_elec[3][0]["numDocSustento_punto"]] + pad(datos_cab[0][datos_elec[3][0]["numDocSustento_punto"]], 9)
        xml = xml + '<numDocSustento>' + numDocSustento + '</numDocSustento>'
        var mydate = new Date(datos_cab[0][datos_elec[3][0]["fechaEmisionDocSustento"]]);

        xml = xml + '<fechaEmisionDocSustento>' + mydate.format('d/m/Y') + '</fechaEmisionDocSustento>'
        xml = xml + '</impuesto>'
        
    }

  for (y = 0; y < Object.keys(codigos_iva).length; y++){
        xml = xml + '<impuesto>'
        xml = xml + '<codigo>2</codigo>'
        xml = xml + '<codigoRetencion>' + codigos_iva[Object.keys(codigos_iva)[y]]['codigoRetencion'] + '</codigoRetencion>'
        xml = xml + '<baseImponible>' + codigos_iva[Object.keys(codigos_iva)[y]]['baseImponible'] + '</baseImponible>'
        xml = xml + '<porcentajeRetener>' + codigos_iva[Object.keys(codigos_iva)[y]]['porcentajeRetener'] + '</porcentajeRetener>'
        xml = xml + '<valorRetenido>' + codigos_iva[Object.keys(codigos_iva)[y]]['valorRetenido'] + '</valorRetenido>'

        xml = xml + '<codDocSustento>' + datos_cab[0][datos_elec[3][0]["codDocSustento"]] + '</codDocSustento>'
        numDocSustento = datos_cab[0][datos_elec[3][0]["numDocSustento_est"]] + datos_cab[0][datos_elec[3][0]["numDocSustento_punto"]] + pad(datos_cab[0][datos_elec[3][0]["numDocSustento_punto"]], 9)
        xml = xml + '<numDocSustento>' + numDocSustento + '</numDocSustento>'
        var mydate = new Date(datos_cab[0][datos_elec[3][0]["fechaEmisionDocSustento"]]);

        xml = xml + '<fechaEmisionDocSustento>' + mydate.format('d/m/Y') + '</fechaEmisionDocSustento>'
        xml = xml + '</impuesto>'
        
    }



    xml = xml + '</impuestos>'


    xml_adicional  = '<infoAdicional>'

    if(datos_elec[2].length > 0){
        for (y = 0; y < datos_elec[2].length; y++){
            if(datos_cab[0][datos_elec[2][y]["valor"]] != ''){
                xml_adicional = xml_adicional + '<campoAdicional nombre="' + datos_elec[2][y]["nombre"] + '">' + datos_cab[0][datos_elec[2][y]["valor"]] + '</campoAdicional>'
            }
        }
    }
    

    if(xml_adicional != '<infoAdicional>'){
        xml = xml + xml_adicional + '</infoAdicional></comprobanteRetencion>'
    }else{
        xml = xml + '</comprobanteRetencion>'
    }
    return [temp_claveAcceso, xml]
}

function hacer_xml_nota_credito(datos_elec, datos_cab, datos_det) {
    temp_claveAcceso = traer_clave(moment(), datos_elec[1][0], datos_cab[0][datos_elec[1][0]["secuencial"]] ,datos_cab[0][datos_elec[1][0]["estab"]], datos_cab[0][datos_elec[1][0]["ptoEmi"]])
    xml = '<notaCredito id="comprobante" version="1.0.0">'
    xml = xml + '<infoTributaria>'
    xml = xml + '<ambiente>' + datos_elec[1][0]["ambiente"] + '</ambiente>'
    xml = xml + '<tipoEmision>' + datos_elec[1][0]["tipoEmision"] + '</tipoEmision>'
    xml = xml + '<razonSocial>' + datos_elec[1][0]["razonSocial"] + '</razonSocial>'
    xml = xml + '<nombreComercial>' + datos_elec[1][0]["nombreComercial"] + '</nombreComercial>'
    xml = xml + '<ruc>'+ datos_elec[1][0]["ruc"] + '</ruc>'
    xml = xml + '<claveAcceso>'+ temp_claveAcceso + '</claveAcceso>'
    xml = xml + '<codDoc>' + datos_elec[1][0]["codDoc"] + '</codDoc>'
    xml = xml + '<estab>' + datos_cab[0][datos_elec[1][0]["estab"]] + '</estab>'
    xml = xml + '<ptoEmi>' + datos_cab[0][datos_elec[1][0]["ptoEmi"]] + '</ptoEmi>'
    xml = xml + '<secuencial>' + pad(datos_cab[0][datos_elec[1][0]["secuencial"]],9) + '</secuencial>'
    xml = xml + '<dirMatriz>' + datos_elec[1][0]["dirMatriz"]+ '</dirMatriz>'
    xml = xml + '</infoTributaria>'

    xml = xml + '<infoNotaCredito>'


    xml = xml + '<fechaEmision>' + moment().format('DD/MM/YYYY') + '</fechaEmision>'
    xml = xml + '<dirEstablecimiento>' + datos_elec[4][0]["dirEstablecimiento"] + '</dirEstablecimiento>'
    xml = xml + '<tipoIdentificacionComprador>' + datos_cab[0][datos_elec[4][0]["tipoIdentificacionComprador"]] + '</tipoIdentificacionComprador>'
    xml = xml + '<razonSocialComprador>' + datos_cab[0][datos_elec[4][0]["razonSocialComprador"]] + '</razonSocialComprador>'
    xml = xml + '<identificacionComprador>' + datos_cab[0][datos_elec[4][0]["identificacionComprador"]] + '</identificacionComprador>'


    xml = xml + '<obligadoContabilidad>' + datos_elec[4][0]["obligadoContabilidad"] + '</obligadoContabilidad>'


    xml = xml + '<codDocModificado>' + datos_cab[0][datos_elec[4][0]["codDocModificado"]] + '</codDocModificado>'



    xml = xml + '<numDocModificado>' + datos_cab[0][datos_elec[4][0]["numDocModificado_est"]]  + "-" +  datos_cab[0][datos_elec[4][0]["numDocModificado_punto"]]  + "-" +  pad(datos_cab[0][datos_elec[4][0]["numDocModificado_sec"]],9) + '</numDocModificado>'

    var mydate = new Date(datos_cab[0][datos_elec[4][0]["fechaEmisionDocSustento"]]);

    xml = xml + '<fechaEmisionDocSustento>' + mydate.format('d/m/Y') + '</fechaEmisionDocSustento>'
    xml = xml + '<totalSinImpuestos>' + datos_cab[0][datos_elec[4][0]["totalSinImpuestos"]] + '</totalSinImpuestos>'
    xml = xml + '<valorModificacion>' + datos_cab[0][datos_elec[4][0]["valorModificacion"]] + '</valorModificacion>'
    xml = xml + '<moneda>' + datos_elec[4][0]["moneda"] + '</moneda>'



    xml = xml + '<totalConImpuestos>'

    if (parseFloat(datos_cab[0][datos_elec[4][0]["baseImponible1"]]) > 0 ){
        xml = xml + '<totalImpuesto>'
        xml = xml + '<codigo>' + datos_elec[4][0]["codigo1"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[4][0]["codigoPorcentaje1"] + '</codigoPorcentaje>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[4][0]["baseImponible1"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[4][0]["valor1"]] + '</valor>'
        xml = xml + '</totalImpuesto>'
    }
    if (parseFloat(datos_cab[0][datos_elec[4][0]["baseImponible2"]]) > 0 ){
        xml = xml + '<totalImpuesto>'
        xml = xml + '<codigo>' + datos_elec[4][0]["codigo2"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[4][0]["codigoPorcentaje2"] + '</codigoPorcentaje>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[4][0]["baseImponible2"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[4][0]["valor2"]] + '</valor>'
        xml = xml + '</totalImpuesto>'
    }
    if (parseFloat(datos_cab[0][datos_elec[4][0]["baseImponible3"]]) > 0 ){
        xml = xml + '<totalImpuesto>'
        xml = xml + '<codigo>' + datos_elec[4][0]["codigo3"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[4][0]["codigoPorcentaje3"] + '</codigoPorcentaje>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[4][0]["baseImponible3"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[4][0]["valor3"]] + '</valor>'
        xml = xml + '</totalImpuesto>'
    }

    xml = xml + '</totalConImpuestos>'

    
    xml = xml + '<motivo>' + datos_elec[4][0]["motivo"] + '</motivo>'
   
    xml = xml + '</infoNotaCredito>'
  
    xml = xml + '<detalles>'

    for (y = 0; y < datos_det.length; y++){
        if(isNaN(datos_det[y][datos_elec[3][0]["cantidad"]]) == false){
            if(datos_det[y][datos_elec[3][0]["cantidad"]] > 0){
            
            xml = xml + '<detalle>'
            xml = xml + '<codigoInterno>' + datos_det[y][datos_elec[3][0]["codigoInterno"]] + '</codigoInterno>'
            xml = xml + '<codigoAdicional>' +  datos_det[y][datos_elec[3][0]["codigoAdicional"]]  + '</codigoAdicional>'
            xml = xml + '<descripcion>' +  datos_det[y][datos_elec[3][0]["descripcion"]]  + '</descripcion>'
            xml = xml + '<cantidad>' +  datos_det[y][datos_elec[3][0]["cantidad"]]  + '</cantidad>'
            xml = xml + '<precioUnitario>' +  datos_det[y][datos_elec[3][0]["precioUnitario"]]  + '</precioUnitario>'
            xml = xml + '<descuento>' +  datos_det[y][datos_elec[3][0]["descuento"]]  + '</descuento>'
            xml = xml + '<precioTotalSinImpuesto>' +  datos_det[y][datos_elec[3][0]["precioTotalSinImpuesto"]]  + '</precioTotalSinImpuesto>'
            xml = xml + '<impuestos>'
            xml = xml + '<impuesto>'
            xml = xml + '<codigo>' + datos_det[y][datos_elec[3][0]["codigo"]] + '</codigo>'
            xml = xml + '<codigoPorcentaje>' + datos_det[y][datos_elec[3][0]["codigoPorcentaje"]] + '</codigoPorcentaje>'
            xml = xml + '<tarifa>' + datos_det[y][datos_elec[3][0]["tarifa"]] + '</tarifa>'
            xml = xml + '<baseImponible>' + datos_det[y][datos_elec[3][0]["baseImponible"]] + '</baseImponible>'
            xml = xml + '<valor>' + datos_det[y][datos_elec[3][0]["valor"]] + '</valor>'
            xml = xml + '</impuesto>'
            xml = xml + '</impuestos>'
            xml = xml + '</detalle>'
            }
        }
    }
    xml = xml + '</detalles>'
    xml_adicional  = '<infoAdicional>'

    if(datos_elec[2].length > 0){
        for (y = 0; y < datos_elec[2].length; y++){
            if(datos_cab[0][datos_elec[2][y]["valor"]] != ''){
                xml_adicional = xml_adicional + '<campoAdicional nombre="' + datos_elec[2][y]["nombre"] + '">' + datos_cab[0][datos_elec[2][y]["valor"]] + '</campoAdicional>'
            }
        }
    }
    

    if(xml_adicional != '<infoAdicional>'){
        xml = xml + xml_adicional + '</infoAdicional></notaCredito>'
    }else{
        xml = xml + '</notaCredito>'
    }
    return [temp_claveAcceso, xml]
}

function hacer_xml_nota_debito(datos_elec, datos_cab, datos_det) {
    temp_claveAcceso = traer_clave(moment(), datos_elec[1][0], datos_cab[0][datos_elec[1][0]["secuencial"]] ,datos_cab[0][datos_elec[1][0]["estab"]], datos_cab[0][datos_elec[1][0]["ptoEmi"]])
    xml = '<notaDebito id="comprobante" version="1.0.0">'
    xml = xml + '<infoTributaria>'
    xml = xml + '<ambiente>' + datos_elec[1][0]["ambiente"] + '</ambiente>'
    xml = xml + '<tipoEmision>' + datos_elec[1][0]["tipoEmision"] + '</tipoEmision>'
    xml = xml + '<razonSocial>' + datos_elec[1][0]["razonSocial"] + '</razonSocial>'
    xml = xml + '<nombreComercial>' + datos_elec[1][0]["nombreComercial"] + '</nombreComercial>'
    xml = xml + '<ruc>'+ datos_elec[1][0]["ruc"] + '</ruc>'
    xml = xml + '<claveAcceso>'+ temp_claveAcceso + '</claveAcceso>'
    xml = xml + '<codDoc>' + datos_elec[1][0]["codDoc"] + '</codDoc>'
    xml = xml + '<estab>' + datos_cab[0][datos_elec[1][0]["estab"]] + '</estab>'
    xml = xml + '<ptoEmi>' + datos_cab[0][datos_elec[1][0]["ptoEmi"]] + '</ptoEmi>'
    xml = xml + '<secuencial>' + pad(datos_cab[0][datos_elec[1][0]["secuencial"]],9) + '</secuencial>'
    xml = xml + '<dirMatriz>' + datos_elec[1][0]["dirMatriz"]+ '</dirMatriz>'
    xml = xml + '</infoTributaria>'

    xml = xml + '<infoNotaDebito>'


    xml = xml + '<fechaEmision>' + moment().format('DD/MM/YYYY') + '</fechaEmision>'
    xml = xml + '<dirEstablecimiento>' + datos_elec[3][0]["dirEstablecimiento"] + '</dirEstablecimiento>'


    xml = xml + '<tipoIdentificacionComprador>' + datos_cab[0][datos_elec[3][0]["tipoIdentificacionComprador"]] + '</tipoIdentificacionComprador>'
    xml = xml + '<razonSocialComprador>' + datos_cab[0][datos_elec[3][0]["razonSocialComprador"]] + '</razonSocialComprador>'
    xml = xml + '<identificacionComprador>' + datos_cab[0][datos_elec[3][0]["identificacionComprador"]] + '</identificacionComprador>'
    xml = xml + '<obligadoContabilidad>' + datos_elec[3][0]["obligadoContabilidad"] + '</obligadoContabilidad>'
    xml = xml + '<codDocModificado>' + datos_cab[0][datos_elec[3][0]["codDocModificado"]] + '</codDocModificado>'

    xml = xml + '<numDocModificado>' + datos_cab[0][datos_elec[3][0]["numDocModificado_est"]] + "-" + datos_cab[0][datos_elec[3][0]["numDocModificado_punt"]] + "-" + pad(datos_cab[0][datos_elec[3][0]["numDocModificado_sec"]],9) + '</numDocModificado>'

    var mydate = new Date(datos_cab[0][datos_elec[3][0]["fechaEmisionDocSustento"]]);

    xml = xml + '<fechaEmisionDocSustento>' + mydate.format('d/m/Y') + '</fechaEmisionDocSustento>'

    xml = xml + '<totalSinImpuestos>' + datos_cab[0][datos_elec[3][0]["totalSinImpuestos"]] + '</totalSinImpuestos>'

    xml = xml + '<impuestos>'

    if (parseFloat(datos_cab[0][datos_elec[3][0]["baseImponible1"]]) > 0 ){
        xml = xml + '<impuesto>'
        xml = xml + '<codigo>' + datos_elec[3][0]["codigo1"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[3][0]["codigoPorcentaje1"] + '</codigoPorcentaje>'
        xml = xml + '<tarifa>' + datos_elec[3][0]["tarifa1"] + '</tarifa>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[3][0]["baseImponible1"]] + '</baseImponible>'        

        xml = xml + '<valor>' + datos_cab[0][datos_elec[3][0]["valor1"]] + '</valor>'
        xml = xml + '</impuesto>'
    }
    if (parseFloat(datos_cab[0][datos_elec[3][0]["baseImponible2"]]) > 0 ){
        xml = xml + '<impuesto>'
        xml = xml + '<codigo>' + datos_elec[3][0]["codigo2"] + '</codigo>'
        xml = xml + '<codigoPorcentaje>' + datos_elec[3][0]["codigoPorcentaje2"] + '</codigoPorcentaje>'
        xml = xml + '<tarifa>' + datos_elec[3][0]["tarifa2"] + '</tarifa>'
        xml = xml + '<baseImponible>' + datos_cab[0][datos_elec[3][0]["baseImponible2"]] + '</baseImponible>'
        xml = xml + '<valor>' + datos_cab[0][datos_elec[3][0]["valor2"]] + '</valor>'
        xml = xml + '</impuesto>'
    }


    xml = xml + '</impuestos>'

    
    xml = xml + '<valorTotal>' + datos_cab[0][datos_elec[3][0]["valorTotal"]] + '</valorTotal>'

    xml = xml + '<pagos>'
    xml = xml + '<pago>'
    xml = xml + '<formaPago>' + datos_cab[0][datos_elec[3][0]["formaPago"]] + '</formaPago>'
    xml = xml + '<total>' + datos_cab[0][datos_elec[3][0]["total"]] + '</total>'
    xml = xml + '<plazo>' + datos_cab[0][datos_elec[3][0]["plazo"]] + '</plazo>'
    xml = xml + '<unidadTiempo>' + datos_cab[0][datos_elec[3][0]["unidadTiempo"]] + '</unidadTiempo>'
    xml = xml + '</pago>'
    xml = xml + '</pagos>'
    xml = xml + '</infoNotaDebito>'
  
    xml = xml + '<motivos>'

    for (y = 0; y < datos_det.length; y++){
        if(isNaN(datos_det[y][datos_elec[4][0]["valor"]]) == false){
            if(datos_det[y][datos_elec[4][0]["valor"]] > 0){
            xml = xml + '<motivo>'
            xml = xml + '<razon>' + datos_det[y][datos_elec[4][0]["razon"]] + '</razon>'
            xml = xml + '<valor>' +  datos_det[y][datos_elec[4][0]["valor"]]  + '</valor>'
            xml = xml + '</motivo>'
            }
        }
    }
    xml = xml + '</motivos>'
    xml_adicional  = '<infoAdicional>'

    if(datos_elec[2].length > 0){
        for (y = 0; y < datos_elec[2].length; y++){
            if(datos_cab[0][datos_elec[2][y]["valor"]] != ''){
                xml_adicional = xml_adicional + '<campoAdicional nombre="' + datos_elec[2][y]["nombre"] + '">' + datos_cab[0][datos_elec[2][y]["valor"]] + '</campoAdicional>'
            }

        }
    }
    

    if(xml_adicional != '<infoAdicional>'){
        xml = xml + xml_adicional + '</infoAdicional></notaDebito>'
    }else{
        xml = xml + '</notaDebito>'
    }
    return [temp_claveAcceso, xml]
}

function hacer_xml_guiaremision(datos_elec, datos_cab, datos_det) {
    temp_claveAcceso = traer_clave(datos_cab[0][datos_elec[1][0]["fecha"]], datos_elec[1][0], datos_cab[0][datos_elec[1][0]["secuencial"]] ,datos_cab[0][datos_elec[1][0]["estab"]], datos_cab[0][datos_elec[1][0]["ptoEmi"]])
    xml = '<guiaRemision id="comprobante" version="1.0.0">'
    xml = xml + '<infoTributaria>'
    xml = xml + '<ambiente>' + datos_elec[1][0]["ambiente"] + '</ambiente>'
    xml = xml + '<tipoEmision>' + datos_elec[1][0]["tipoEmision"] + '</tipoEmision>'
    xml = xml + '<razonSocial>' + datos_elec[1][0]["razonSocial"] + '</razonSocial>'
    xml = xml + '<nombreComercial>' + datos_elec[1][0]["nombreComercial"] + '</nombreComercial>'
    xml = xml + '<ruc>'+ datos_elec[1][0]["ruc"] + '</ruc>'
    xml = xml + '<claveAcceso>'+ temp_claveAcceso + '</claveAcceso>'
    xml = xml + '<codDoc>' + datos_elec[1][0]["codDoc"] + '</codDoc>'
    xml = xml + '<estab>' + datos_cab[0][datos_elec[1][0]["estab"]] + '</estab>'
    xml = xml + '<ptoEmi>' + datos_cab[0][datos_elec[1][0]["ptoEmi"]] + '</ptoEmi>'
    xml = xml + '<secuencial>' + pad(datos_cab[0][datos_elec[1][0]["secuencial"]],9) + '</secuencial>'
    xml = xml + '<dirMatriz>' + datos_elec[1][0]["dirMatriz"]+ '</dirMatriz>'
    xml = xml + '</infoTributaria>'

    xml = xml + '<infoGuiaRemision>'


    xml = xml + '<dirEstablecimiento>' + datos_elec[4][0]["dirEstablecimiento"] + '</dirEstablecimiento>'
    
    xml = xml + '<dirPartida>' + datos_elec[4][0]["dirPartida"] + '</dirPartida>'
    xml = xml + '<razonSocialTransportista>' + datos_cab[0][datos_elec[4][0]["razonSocialTransportista"]] + '</razonSocialTransportista>'
    xml = xml + '<tipoIdentificacionTransportista>' + datos_cab[0][datos_elec[4][0]["tipoIdentificacionTransportista"]] + '</tipoIdentificacionTransportista>'
    xml = xml + '<rucTransportista>' + datos_cab[0][datos_elec[4][0]["rucTransportista"]] + '</rucTransportista>'
    xml = xml + '<obligadoContabilidad>' + datos_elec[4][0]["obligadoContabilidad"] + '</obligadoContabilidad>'

    var mydate = new Date(datos_cab[0][datos_elec[4][0]["fechaIniTransporte"]]);

    xml = xml + '<fechaIniTransporte>' + mydate.format('d/m/Y') + '</fechaIniTransporte>'
               

    var mydate = new Date(datos_cab[0][datos_elec[4][0]["fechaFinTransporte"]]);

    xml = xml + '<fechaFinTransporte>' + mydate.format('d/m/Y') + '</fechaFinTransporte>'

    xml = xml + '<placa>' + datos_cab[0][datos_elec[4][0]["placa"]] + '</placa>'

    xml = xml + '</infoGuiaRemision>'

    xml = xml + '<destinatarios>'
    xml = xml + '<destinatario>'
        xml = xml + '<identificacionDestinatario>' + datos_cab[0][datos_elec[3][0]["identificacionDestinatario"]] + '</identificacionDestinatario>'
        xml = xml + '<razonSocialDestinatario>' + datos_cab[0][datos_elec[3][0]["razonSocialDestinatario"]] + '</razonSocialDestinatario>'
        xml = xml + '<dirDestinatario>' + datos_cab[0][datos_elec[3][0]["dirDestinatario"]] + '</dirDestinatario>'
        xml = xml + '<motivoTraslado>' + datos_cab[0][datos_elec[3][0]["motivoTraslado"]] + '</motivoTraslado>'
        if( datos_elec[3][0]["docAduaneroUnico"] !='No'){
            xml = xml + '<docAduaneroUnico>' + datos_cab[0][datos_elec[3][0]["docAduaneroUnico"]] + '</docAduaneroUnico>'
        }
        if( datos_elec[3][0]["codEstabDestino"] !='No'){
            xml = xml + '<codEstabDestino>' + datos_cab[0][datos_elec[3][0]["codEstabDestino"]] + '</codEstabDestino>'
        }
        if( datos_elec[3][0]["ruta"] !='No'){
            xml = xml + '<ruta>' + datos_cab[0][datos_elec[3][0]["ruta"]] + '</ruta>'
        }
        xml = xml + '<codDocSustento>' + datos_cab[0][datos_elec[3][0]["codDocSustento"]] + '</codDocSustento>'

        xml = xml + '<numDocSustento>' + datos_cab[0][datos_elec[3][0]["numDocSustento_est"]]  + "-" +  datos_cab[0][datos_elec[3][0]["numDocSustento_punto"]]  + "-" +  pad(datos_cab[0][datos_elec[3][0]["numDocSustento_sec"]],9) + '</numDocSustento>'


        xml = xml + '<numAutDocSustento>' + datos_cab[0][datos_elec[3][0]["numAutDocSustento"]] + '</numAutDocSustento>'
        var mydate = new Date(datos_cab[0][datos_elec[3][0]["fechaEmisionDocSustento"]]);

        xml = xml + '<fechaEmisionDocSustento>' + mydate.format('d/m/Y') + '</fechaEmisionDocSustento>'
           



    xml = xml + '<detalles>'

    for (y = 0; y < datos_det.length; y++){
        if(isNaN(datos_det[y][datos_elec[3][0]["cantidad"]]) == false){
            if(datos_det[y][datos_elec[3][0]["cantidad"]] > 0){
            
            xml = xml + '<detalle>'
            xml = xml + '<codigoInterno>' + datos_det[y][datos_elec[3][0]["codigoInterno"]] + '</codigoInterno>'
            xml = xml + '<codigoAdicional>' +  datos_det[y][datos_elec[3][0]["codigoAdicional"]]  + '</codigoAdicional>'
            xml = xml + '<descripcion>' +  datos_det[y][datos_elec[3][0]["descripcion"]]  + '</descripcion>'
            xml = xml + '<cantidad>' +  datos_det[y][datos_elec[3][0]["cantidad"]]  + '</cantidad>'

            xml = xml + '</detalle>'
            }
        }
    }
    xml = xml + '</detalles>'

    xml = xml + '</destinatario>'
    xml = xml + '</destinatarios>'


    xml_adicional  = '<infoAdicional>'

    if(datos_elec[2].length > 0){
        for (y = 0; y < datos_elec[2].length; y++){
            if(datos_cab[0][datos_elec[2][y]["valor"]] != ''){
                xml_adicional = xml_adicional + '<campoAdicional nombre="' + datos_elec[2][y]["nombre"] + '">' + datos_cab[0][datos_elec[2][y]["valor"]] + '</campoAdicional>'
            }

        }
    }
    

    if(xml_adicional != '<infoAdicional>'){
        xml = xml + xml_adicional + '</infoAdicional></guiaRemision>'
    }else{
        xml = xml + '</guiaRemision>'
    }
    return [temp_claveAcceso, xml]
}


function sha1_base64(txt, codificacion='') {
    var md = forge.md.sha1.create();
    md.update(txt,codificacion);
    //console.log('Buffer in: ', Buffer);
    //return new Buffer(md.digest().toHex(), 'hex').toString('base64');
    return new window.buffer.Buffer(md.digest().toHex(), 'hex').toString('base64');
}

function hexToBase64(str) {
    var hex = ('00' + str).slice(0 - str.length - str.length % 2);
    
    return btoa(String.fromCharCode.apply(null,
        hex.replace(/\r|\n/g, "").replace(/([\da-fA-F]{2}) ?/g, "0x$1 ").replace(/ +$/, "").split(" "))
    );
}

function bigint2base64(bigint){
    var base64 = '';
    base64 = btoa(bigint.toString(16).match(/\w{2}/g).map(function(a){return String.fromCharCode(parseInt(a, 16));} ).join(""));
    
    base64 = base64.match(/.{1,76}/g).join("\n");
    
    return base64;
}

function p_obtener_aleatorio() {
    return Math.floor(Math.random() * 999000) + 990;    
}

function traer_clave(fecha, datos_tribu, secuancial,estab, ptoEmi){
    var mydate = new Date(fecha);
     
    clave = mydate.format('d') + mydate.format('m') + mydate.format('Y') 
    clave = clave + datos_tribu["codDoc"]
    clave = clave + datos_tribu["ruc"]
    clave = clave + datos_tribu["ambiente"]
    clave = clave + estab
    clave = clave + ptoEmi
    clave = clave + pad(secuancial,9)
    clave = clave + "00000000"
    clave = clave + "1"
    clave = clave + p_calcular_digito_modulo11(clave)
    return clave    
}


function p_obtener_codigo_autorizacion(fechaEmision, tipoComprobante, ruc, ambiente, estab, ptoEmi, secuencial, codigo, tipoEmision) {
    fechaEmision = fechaEmision || new Date();
    tipoComprobante = tipoComprobante || 'factura'; //1 factura, 4 nota de crÃ©dito, 5 nota de dÃ©bito, 6 guÃ­a de remisiÃ³n, 7 retenciÃ³n
    ruc = ruc || '9999999999999';
    ambiente = ambiente || 1; // 1 pruebas, 2 produccion
    
    //serie = serie || 0;
    estab = estab || 1;
    ptoEmi = ptoEmi || 1;
    
    
    secuencial = secuencial || p_obtener_secuencial(tipoComprobante);
    codigo = codigo ||  (moment(fechaEmision).format('DDMM') + pad(secuencial, 4).slice(-3) + p_calcular_digito_modulo11(moment(fechaEmision).format('DDMM') + pad(secuencial, 3).slice(-3)));
    tipoEmision = tipoEmision ||  1; //1 emision normal
    
    var codigo_autorizacion = moment(fechaEmision).format('DDMMYYYY') 
                + pad(codDoc[tipoComprobante], 2) 
                + pad(ruc, 13) 
                + pad(ambiente, 1)
                + pad(estab, 3) + pad(ptoEmi, 3)
                + pad(secuencial, 9)
                + pad(codigo, 8)
                + pad(tipoEmision, 1);
                
    var digito_calculado = p_calcular_digito_modulo11(codigo_autorizacion);
    
    if (digito_calculado > -1) {
        return codigo_autorizacion + digito_calculado;
    }
}

function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

function p_calcular_digito_modulo11(numero) {
    var digito_calculado = -1;
    
    if (typeof(numero) == 'string' && /^\d+$/.test(numero)) {
        
        var digitos = numero.split('').map(Number); //arreglo con los dÃ­gitos del nÃºmero

        digito_calculado = 11 - digitos.reduce(function(valorPrevio, valorActual, indice) {
            return valorPrevio + (valorActual * (7 - indice % 6));
        }, 0) % 11;
        
        digito_calculado = (digito_calculado == 11) ? 0 : digito_calculado; //segÃºn ficha tÃ©cnica
        digito_calculado = (digito_calculado == 10) ? 1 : digito_calculado; //segÃºn ficha tÃ©cnica
    }
    return digito_calculado;
}

function cerrar_elemento(id_tab) {
  $('#' +'li' + id_tab).remove();
  $('#' +'rr' + id_tab).remove();
}

function cerrar_panel(id_tab) {
  $('#' +'id' + id_tab).remove();
  $('#' +'rr' + id_tab).remove();
}

  
var dict_pestalla = {}
var cc_porPesta = {}

var modulos = {}
var procesos = {}
var procesospk = {}

  {% for id in menu %}
  modulos["{{ id.Nombre }}"] = []{% endfor %}    

  {% for id in menu %}{% for pkmodulo in modulos %}{% if id.PkModGen == pkmodulo.PkModGen %}{% if pkmodulo.formtipo == "Registro" %}
            modulos["{{ id.Nombre }}"].push("{{ pkmodulo.mdesc }}")
            procesos["{{ pkmodulo.mdesc }}"]= "{{ pkmodulo.modulo }}"
            procesospk["{{ pkmodulo.mdesc }}"]= "{{ pkmodulo.id }}"{% endif %}{% endif %}{% endfor %}{% endfor %}


function nota_doc_filtrar() {
    var sel_menu = document.getElementById('nota_doc_menu_cbx');
    var sel_proc = document.getElementById('nota_doc_proceso_cbx');
    $("#nota_doc_proceso_cbx").empty();

    var length = sel_proc.options.length;
    for (i = 0; i < length; i++) {
      sel_proc.options[i] = null;
    }  
    for (x = 0; x < modulos[sel_menu.value].length; x++) {
      var opt = document.createElement('option');
      opt.appendChild( document.createTextNode(modulos[sel_menu.value][x]) );
      opt.value = modulos[sel_menu.value][x]; 
      sel_proc.appendChild(opt); 
    }
}


function nota_doc_grabar(){
               
    var not_pknota = document.getElementById("vpk_nota").value
    var not_modulo = document.getElementById("nota_doc_proceso_cbx").value
    var not_pkmodulo = procesospk[not_modulo]
    var not_pk = document.getElementById("nota_doc_proceso_pk").value
    var not_descripcion = document.getElementById("nota_doc_proceso_campoiden").value
    var not_identificador = document.getElementById("nota_doc_proceso_valoriden").value

  
      $.ajax({
        type: 'POST',
        url: '/nota_guardar_doc',
        data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','usuario':'{{usuario}}','pknota':not_pknota,'modulo':not_modulo,'pkmodulo':not_pkmodulo,'pk':not_pk,'descripcion':not_descripcion,'identificador':not_identificador },
        success: function(Response){

        
          var iDiv = document.createElement('button');
          iDiv.className = "btn btn-success"
          iDiv.setAttribute("data-dismiss", "modal")
          iDiv.setAttribute("onclick", "abrir_doc( "+ Response["pkmodulo"] +",  "+ Response["pk"] +")")
          iDiv.innerHTML =  Response["modulo"] +', '+ Response["descripcion"] +':'+ Response["identificador"] 

          //iDiv.innerHTML = '<button class="btn btn-success"  data-dismiss="modal" onclick="abrir_doc( '+ Response["pkmodulo"] +',  '+ Response["pk"] +')">'+  Response["modulo"] +', '+ Response["descripcion"] +':'+ Response["identificador"] +'</button>'
          var divcemaforo = document.getElementById('div_nota_doc');
          divcemaforo.appendChild(iDiv);
          //$('#divbusca_nota_doc').html('');

          alert("{{idioma_html.doc_save}}")
        }
      });
}


function selecctt_buscador_nota(x) {  
  var ss = document.getElementById("nota_doc_proceso_campoiden")

  document.getElementById("nota_doc_proceso_valoriden").value = document.getElementById("dataTables-example").rows[x.rowIndex].cells[ss.selectedIndex+1].innerHTML.trim();
  document.getElementById("nota_doc_proceso_pk").value = document.getElementById("dataTables-example").rows[x.rowIndex].cells[0].innerHTML.trim();

  
}

function filtrar_buscar_nota(){

  sentencia2 = "select * from (" + document.getElementById("buscador_senten").value + ") int_ress where "  + document.getElementById("busca_campo_nota").value + " like '" + document.getElementById("busca_valor_nota").value + "%'"


   $.ajax({
          type: 'POST',
          url: '/buscador',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': sentencia2, 'usuario':'{{usuario}}','A_Select': '', 'PkCampo':PkCampo,},
          success: function(Response){
            orden = Response["A_Select"].split(",")
            data_int = '<div class="panel-body" style="overflow: auto;"><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'

            for (x = 0; x < orden.length; x++) {
                data_int = data_int + '<th>' + orden[x] + '</th>'
            }
                            data_int = data_int + '</tr></thead><tbody>'
            for (x = 0; x < Response['cmpvalor'].length; x++) {
              data_int = data_int + '<tr class="odd gradeX" onclick="selecctt_buscador_nota(this)">'
              for (x2 = 0; x2 < orden.length; x2++) {
                data_int = data_int + '<td>' + Response['cmpvalor'][x][orden[x2]] + '</td>'
              }
              data_int = data_int + '</tr>'
            }
            data_int = data_int + '</tbody></table></div>'
            $('#buscador_int_nota').html(data_int);
          } 
        });
}

function limpiarnota_doc_buscar(){
  document.getElementById('nota_doc_proceso_valoriden').value = ""
  document.getElementById('nota_doc_proceso_pk').value = ""

}

function nota_doc_buscar(){

  var sel_proc = document.getElementById('nota_doc_proceso_cbx');
  var cmtsenten = 'select * from ' + procesos[sel_proc.value] + ' order by Pk' + procesos[sel_proc.value] + ' desc'

        $.ajax({
          type: 'POST',
          url: '/buscador_nota_doc',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten':cmtsenten, 'usuario':'{{usuario}}', 'tabla':procesos[sel_proc.value]},
          success: function(Response){
          buscador_resultado = Response['cmpvalor']


          var sel_proc = document.getElementById('nota_doc_proceso_campoiden');
          $("#nota_doc_proceso_campoiden").empty();

          data_int= '<div class="row"><div class="col-lg-12" ><select class="form-control" id="busca_campo_nota">'
          for (x = 0; x <   Response['campos'].length; x++) {
            data_int = data_int + '<option>' + Response['campos'][x]['Nombre'] + '</option>'
            var opt = document.createElement('option');
            opt.appendChild( document.createTextNode(Response['campos'][x]['Nombre']) );
            opt.value = Response['campos'][x]['Nombre']; 
            sel_proc.appendChild(opt); 
          } 

          

          document.getElementById("buscador_senten").value = 'select ' + Response['sente_campos'] +' from ' + Response['tabla']  + ' order by Pk' + Response['tabla']  + ' desc'

          data_int = data_int + '</select><input class="form-control" id="busca_valor_nota" placeholder="Escriba para filtrar"><button class="btn btn-primary" onclick="filtrar_buscar_nota()"><span aria-hidden="true">{{idioma_html.filtrar}}</button></div></div>'

          //data_int = data_int + '<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">cerrar</button><button type="button" class="btn btn-primary" data-dismiss="modal" onclick="poner_valor_buscar_nota_doc()">Traer</button></div>'
          data_int = data_int + '<div id="buscador_int_nota" style="overflow: auto;">'
          data_int = data_int + '<div class="panel-body"><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'

            data_int = data_int + '<th>PK'+ Response['tabla'] + '</th>'


          for (x = 0; x < Response['campos'].length; x++) {
            data_int = data_int + '<th>' + Response['campos'][x]['Nombre'] + '</th>'

          }
          data_int = data_int + '</tr></thead><tbody>'


          for (x = 0; x < Response['valores'].length; x++) {
            data_int = data_int + '<tr class="odd gradeX" onclick="selecctt_buscador_nota(this)">'
            data_int = data_int + '<td>' + Response['valores'][x]['Pk'+Response['tabla']] + '</td>'

            for (x2 = 0; x2 < Response['campos'].length; x2++) {
              data_int = data_int + '<td>' + Response['valores'][x][Response['campos'][x2]['Nombre']] + '</td>'
            }
            data_int = data_int + '</tr>'

          }
      
          data_int = data_int + '</tbody></table></div>'

          data_int = data_int + '</div>'

          $('#divbusca_nota_doc').html(data_int);


          }
          });

    
}


function mas(id_tab) {

    cc_porPesta['p-'+id_tab] = cc_porPesta['p-'+id_tab] + 1

    Response = dict_pestalla['p-'+id_tab]


    if(cc_porPesta['p-'+id_tab] > 3){

        document.getElementById('divtabla' + id_tab).style.height = "500px";

    }


    fila =  '<tr id="f' + Response["pestalla"] + '-f' +cc_porPesta['p-'+id_tab]+ '"><td><div class="row" style="padding-left: 10px;">'
    fila = fila + '<button type="button" style="padding: 3px 4px;" onclick="mas(' + Response["pestalla"]+')" class="btn btn-success" >+</button>'
    fila = fila + '<button type="button" style="padding: 3px 6px;" onclick="menos(' + Response["pestalla"]+',' +cc_porPesta['p-'+id_tab]+ ', 0)" class="btn btn-danger" >-</button></div></td>'

    i  = cc_porPesta['p-'+id_tab]
    altura_mini =45

    for (x = 0; x < Response["campos_det"].length; x++) { 
        valor_campo = 0;
            if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
              valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorPredeterminado"]

            }

            if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){
              valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"]

            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsecuencial"){
              if (Response["campos_det"][x]["TablaCampo"].substring(0,2) == "Pk"){
                valor_campo = 0
              }else{
                valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorInicial"]
              }
            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpopcmultiple"){
                valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Valor"]

            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpsistema"){

              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                valor_campo = "{{usuario}}"

              }

              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                var now = new Date();
                valor_campo = now.format("Y-m-d h:m:s");
              }

            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){
               valor_campo = 0
            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
              var now = new Date();
              addi = ' AM'
              if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Tiempo"] == "Y"){
                 if(now.format("H") > 11){addi = ' PM' }
                valor_campo = now + addi
              }else{
                valor_campo = now.format("Y-m-d");
              }
            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Tipo_Predeterminado"] == '0'){
                    valor_campo = 0
                }else{
                    valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["predeterminado_valor"]
                }
            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
              valor_campo = 0
            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){
              valor_campo = 0
            }
            if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
              valor_campo = 0
            }
          
            if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){
              valor_campo = ""
            }

      id_tag = 'pd' + Response["pestalla"] +  'fff'+ i + 'ccc'+ Response["campos_det"][x]["Nombre"]

      if (Response["campos_det"][x]["Visible"] == "Y") {

          fila = fila + '<td style="padding-left: 0px;padding-right: 0px;"><div style="width: ' + Response["campos_det"][x]["largo"] + 'px;">'
          if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
              readonly_int = ''
              if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == "N"){
                readonly_int = 'readonly="readonly"'
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Largo"] > 100 ){
                fila = fila + '<textarea type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" ' + readonly_int + ' onchange="guardar_calcular_det('+ id_tag +')" style="height: '+ altura_mini +'px;font-size: 11px;">'+ valor_campo +'</textarea>'
              }else{
                fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" ' + readonly_int + ' onchange="guardar_calcular_det('+ id_tag +')" style="height: 25px;font-size: 11px;">'
              }
              
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){
            
            fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" onchange="guardar_calcular_det('+ id_tag +')" min="'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"] +'" max="'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Mayor"] +'" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsecuencial"){
            
            fila = fila + '<input type="number" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpopcmultiple"){

      

             fila = fila + '<select class="form-control" id="' + id_tag +'" value="'+ valor_campo +'" onchange="guardar_calcular_det('+ id_tag +')" style="height: 25px;font-size: 11px;">'

              for (z = 0; z < Response["func_det"][Response["campos_det"][x]["Nombre"]].length; z++) { 

                if(valor_campo == Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] )
                  {
                      fila = fila + '<option selected>' + Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] + '</option>'
                  }else{
                      fila = fila + '<option>' + Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] + '</option>'
                  }
                        
              }

              fila = fila + '</select>'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpsistema"){

            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
              fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
            }

            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"] == 'Fecha Actual'){
              fila = fila + '<input type="datetime-local" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
            }
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){


            fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
            tipodato = 'date'
         
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tiempo"] == 'Y'){
                    tipodato = 'datetime-local'}
            fila = fila + '<input type="' + tipodato + '" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" onchange="guardar_calcular_det('+ id_tag +')" style="height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){

            fila = fila + '<div class="input-group"><input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" style="width: 70%;height: 25px;font-size: 11px;" onchange="guardar_calcular_det('+ id_tag +')" onkeypress="return runScript_detalle(event, '+ id_tag +')">'


            fila = fila + '<button class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_detalle('+ id_tag +' )" style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></button></div>'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){

            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Imagen'){
                fila = fila + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+id_tag +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank" style="font-size: 11px;"><img style="width: 100%;height: 60%; display: block;" id="'+id_tag +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'
                altura_mini = 125
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == 'N'){
                    fila = fila + '</div></div>'

                }else{
                    fila = fila + '<label for="'+id_tag +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                    fila = fila + '<input type="file" id="'+id_tag +'_img_file" onchange="cambiar_imagen('+ id_tag +'_img)" style="display: none"></div></div>'
                }

            }else{
                Moddato = ''
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == 'N'){
                    Moddato = 'readonly="readonly"'}
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Texto'){
                  if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tamano"] == 'G'){
                    fila = fila + '<textarea type="text" onchange="guardar_calcular_det('+ id_tag +')" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  ' + Moddato + ' style="height: '+ altura_mini +'px;font-size: 11px;">'+ valor_campo +'</textarea>'
                  }else{
                    fila = fila + '<input type="text" onchange="guardar_calcular_det('+ id_tag +')" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  ' + Moddato + ' style="height: 25px;font-size: 11px;">'
                  }
                    
                }
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Numero'){
                    fila = fila + '<input type="text" onchange="guardar_calcular_det('+ id_tag +')" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  ' + Moddato + ' style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'

                }
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Fecha'){
             
                    fila = fila + '<input type="date" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  ' + Moddato + ' style="height: 25px;font-size: 11px;">'
                  }
                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Fecha Tiempo'){
              
                    fila = fila + '<input type="datetime-local" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" ' + Moddato + ' style="height: 25px;font-size: 11px;">'
                  }

                 
            }
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){
            
            fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" onchange="setTwoNumberDecimal('+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Decimales"] +')" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
      
            fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmparchivo"){
           //fila = fila + '<input type="file" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'" style="height: 25px;font-size: 11px;">'

           fila = fila + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+id_tag +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank" style="font-size: 11px;"><img style="width: 100%;height: 60%; display: block;" id="'+id_tag +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

            fila = fila + '<label for="'+id_tag +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
            fila = fila + '<input type="file" id="'+id_tag +'_img_file" onchange="cambiar_imagen('+ id_tag +'_img)" style="display: none"></div></div>'



          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumeroaletras"){
     
           fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  readonly="readonly" style="height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){

            fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  readonly="readonly" style="height: 25px;font-size: 11px;">'
          }
          if (Response["campos_det"][x]["TablaCampo"] == "cmpelectronico"){

            fila = fila + '<input type="text" id="' + id_tag +'" class="form-control" value="'+ valor_campo +'"  readonly="readonly" style="height: 25px;font-size: 11px;">'
          }
          fila = fila + '</div></td>'

        } else {

          fila = fila + '<input type="hidden" id="' + id_tag +'" value="' +valor_campo+ '" '+ readonly +'>'
                    } 
            }

    fila = fila + '</tr>'

    $('#tabla' +id_tab + ' tr:last').after(fila);
    calcular_detalle_nuevo(Response["pestalla"], i)
    calcular_0(Response["pestalla"])
}
function setTwoNumberDecimal(valor, decimales) {
    return parseFloat(valor).toFixed(decimales);
}
function menos(id_tab, fila, fuente) {
  var tt = document.getElementById('tabla' + id_tab)

  if(tt.rows.length>2 || fuente ==1){
      f_id = '#f' + id_tab + '-f' + fila;

      $(f_id).remove();
      calcular_0(id_tab)

  }
}



function incrementar_resp() {
    document.getElementById('vpk_nota_responsable').value = document.getElementById('vpk_nota_responsable').value + document.getElementById('nota_tarea_cbx').value + ', '     
}


function subir_archivo_nota2() {
    var frm = $('#vpk_nota_responsable')
    var files = document.getElementById('myfile_nota')
    formdata = new FormData();
    // file =files.prop('myfile_nota')[0];
    formdata.append("myfile_nota", files);
    //formdata.append("myfile_nota", file);
    formdata.append("Id_empresa", '{{Id_empresa}}');
    formdata.append("usuario", '{{usuario}}');
    formdata.append("csrfmiddlewaretoken", '{{ csrf_token }}');



    jQuery.ajax({
        url: '/file_upload',
        type: "POST",
        data: formdata,
        processData: false,
        contentType: false,
        success: function (result) {
                alert('Submission was successful.');
                alert(data);
        },
        error: function (data) {
                alert('An error occurred.');
                alert(data);
        },
    });


}

$("#form_nota").submit(function(e) {

    e.preventDefault(); // avoid to execute the actual submit of the form.

    var form = $(this);
    var url = form.attr('action');

    $.ajax({
            type: "POST",
            url: '/file_upload',
            data: form.serialize(), // serializes the form's elements.
            success: function(data)
            {
               alert(data); // show response from the php script.
            }
         });


});

function subir_archivo_nota() {
    if (!window.FileReader) {
        alert('{{idioma_html.nopuede}}');
        return false;
    }

    var fileInput = $('#input_files');
    var input = fileInput.get(0);
    var reader = new FileReader();

    if (input.files.length) {
      for (x = 0; x < input.files.length; x++) {

        var textFile = input.files[x];
        // Read the file
        //reader.readAsText(textFile);
        reader.readAsDataURL(textFile);
        // When it's loaded, process it
        $(reader).on('load', processFile);
      }

    } else {
        alert('{{idioma_html.nofiles}}')
    } 
}
function processFile(e) {
    var file = e.target.result,
        results;
    if (file && file.length) {
    $.ajax({
        type: 'POST',
        url: '/notasload',
        data: {'file': file, 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}'},
        beforeSend: function () {
                        $("#div_update").html("{{idioma_html.upload}}");
                },
        success: function(response){

            $("#div_update").html("{{idioma_html.upload_listo}}");
        }
    });

    }
}
function nota_texto() {


  $.ajax({
          type: 'POST',
          url: '/nota_add_text',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'pknota': document.getElementById('vpk_nota').value, 'texto': document.getElementById('vpk_nota_txt').value},
          success: function(Response){
            var li = document.createElement("li");

            nota_texto_html = '<div class="block"><div class="block_content">'
            nota_texto_html = nota_texto_html + '<h2 class="title"><a>{{usuario}}</a></h2>'
            nota_texto_html = nota_texto_html + '<div class="byline"><p>'+ Response["date"] +'</span></div>'
            nota_texto_html = nota_texto_html + '<p>'+Response["texto"]+'</p></div></div>'
            li.innerHTML  = nota_texto_html

            var ul = document.getElementById("ul_notas_txt");
            //ul.appendChild(li);
            ul.prepend(li);
            
            

          }     

     });
}
function crear_resp() {
  $.ajax({
          type: 'POST',
          url: '/crear_resp',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'pknota': document.getElementById('vpk_nota').value, 'tarea': document.getElementById('vpk_nota_tarea').value, 'responsable': document.getElementById('vpk_nota_responsable').value},
          success: function(Response){
  
            var li = document.createElement("li");

            nota_texto_html = '<p><div class="icheckbox_flat-green unchecked" style="position: relative;"><input type="checkbox" class="flat" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> '+Response["tarea"]+', '+Response["responsable"]+' </p>'

            li.innerHTML  = nota_texto_html

            var ul = document.getElementById("ul_ckh");
            ul.appendChild(li);


          }     

     });
}
function movernota() {
  if(document.getElementById('nota_tarea_cbx').value != ''){

  $.ajax({
          type: 'POST',
          url: '/movernota',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'pknota': document.getElementById('vpk_nota').value, 'n_estado': document.getElementById('nota_tarea_cbx').value},
          success: function(Response){
  
          var li = document.getElementById("li_notapk" + Response["pknota"]);
          li.remove();

          var ul = document.getElementById("ul_estadopk" + Response["pkestado"]);
          var li_new = document.createElement("li");
          li_new.id = 'li_notapk'+ Response["pknota"]

             


              nota_texto_html = '<div class="block"><div class="block_content">'

              nota_texto_html = nota_texto_html + '<h2 class="title"><a>'+Response["titulo"]+'</a></h2>'
              nota_texto_html = nota_texto_html + '             <div class="byline"><p>'+Response["fecha_inicio"]+' ' +Response["fecha_fin"]+ ' '+Response["responable"]+'</span></div>'
              nota_texto_html = nota_texto_html + '             <p class="excerpt">'+Response["descripcion"]+'</p>'

               nota_texto_html = nota_texto_html + '<div style="text-align: right;">'
              
              nota_texto_html = nota_texto_html + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-sm" onclick="abrir_nota('+Response["pknota"]+' )"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button></div>'

              nota_texto_html = nota_texto_html + '           </div></div></li>'
   
          li_new.innerHTML  = nota_texto_html

          //ul.appendChild(li);
          ul.appendChild(li_new);
            

          }     

     });



  }   
}
function abrir_doc(not_PkModulo, not_pk ) {
        //pestalla = pestalla +1;


       // $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">Consulta</a></li>');
        registro(not_PkModulo, not_pk ,"consulta", 'consulta',0);
}
function abrir_nota(pknota) {
     
   $.ajax({
          type: 'POST',
          url: '/traer_nota',
          data: {'pknota': pknota, 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}'},
          beforeSend: function () {

              document.getElementById('nota_tarea_cbx').value = ''     
              document.getElementById('vpk_nota').value = 0     
              //data_int = '<div class="col-md-12"><div class="col-middle"><div class="text-center text-center">'
              //data_int = data_int + '<h1 class="error-number"></h1><h2>{{idioma_html.espere}}</h2>'
              //data_int = data_int + '<p>{{idioma_html.carga}}. </p>'
             // data_int = data_int + '<div class="weather-icon">'
              //data_int = data_int + '<span><canvas height="84" width="84" id="partly-cloudy-day"></canvas>'
              //data_int = data_int + '</span></div></div></div></div>'

                            
              //$('#intnota').html(data_int);

             },
          success: function(Response){

          document.getElementById('vpk_nota').value = Response["notas_main"][0]["pknota"] 
          new_tap_cab = '<h4 class="modal-title">'+ Response["notas_main"][0]["titulo"] +'</h4>' 

          new_tap_cab = new_tap_cab + '<ul class="nav navbar-right panel_toolbox"   >' 
          new_tap_cab = new_tap_cab + '<li> Inicio: '+ Response["notas_main"][0]["fecha_inicio"] +', </li>' 
          new_tap_cab = new_tap_cab + '<li> Vencimiento: '+ Response["notas_main"][0]["fecha_fin"] +', </li>' 
          new_tap_cab = new_tap_cab + '<li> Responable: '+ Response["notas_main"][0]["responable"] +'.</li>' 
          new_tap_cab = new_tap_cab + '</ul><br>'

          new_tap_cab = new_tap_cab + '<p>'+ Response["notas_main"][0]["descripcion"] +'</p>' 
          new_tap = '<div class="x_content" style="width: 800px; background: whitesmoke;"><div class="dashboard-widget-content"><ul class="list-unstyled timeline widget" id="ul_notas">'

           // if(Response["notas_com_chk"].length > 0){

              new_tap = new_tap + '<li>'
              new_tap = new_tap + '         <div class="block">'
              new_tap = new_tap + '           <div class="block_content">'
              new_tap = new_tap + '             <h2 class="title"><a>{{idioma_html.tareas}}</a></h2>'
              new_tap = new_tap + '             <div class="byline"><p></span></div>'

              new_tap = new_tap + '<ul class="to_do" id="ul_ckh">'

              for (x = 0; x < Response["notas_com_chk"].length; x++) {
              
                new_tap = new_tap + '<li><p><div class="icheckbox_flat-green '+Response["notas_com_chk"][x]["check"]+'" style="position: relative;"><input type="checkbox" class="flat" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> '+Response["notas_com_chk"][x]["tarea"]+', '+Response["notas_com_chk"][x]["responsable"]+'</p></li>'

              }
              new_tap = new_tap + '</ul></p></div></div></li>'

          //  }

            //if(Response["notas_com_doc"].length > 0){

              new_tap = new_tap + '<li>'
                new_tap = new_tap + '         <div class="block">'
                new_tap = new_tap + '           <div class="block_content">'

                new_tap = new_tap + '             <h2 class="title"><a>{{idioma_html.documen_rela}}</a></h2><div id="div_nota_doc">'

              for (x = 0; x < Response["notas_com_doc"].length; x++) {
                
                new_tap = new_tap + '<button class="btn btn-success"  data-dismiss="modal" onclick="abrir_doc( '+ Response["notas_com_doc"][x]["pkmodulo"] +',  '+ Response["notas_com_doc"][x]["pk"] +')">'+  Response["notas_com_doc"][x]["modulo"] +', '+ Response["notas_com_doc"][x]["descripcion"] +':'+ Response["notas_com_doc"][x]["identificador"] +'</button>'


              }

              new_tap = new_tap + '           </div></div></div></li>'
           // }
         

            //if(Response["notas_com_file"].length > 0){



             new_tap = new_tap + '<li>'
              new_tap = new_tap + '         <div class="block">'
              new_tap = new_tap + '           <div class="block_content">'
              new_tap = new_tap + '             <h2 class="title"><a>{{idioma_html.files}}</a></h2>'
              new_tap = new_tap + '             <div class="byline"><p></span></div>'



              new_tap = new_tap + '<div class="row">'

              for (x = 0; x < Response["notas_com_file"].length; x++) {
                new_tap = new_tap + '<div class="col-md-55"><div class="thumbnail"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;" src="/static/notas/{{Id_empresa}}/' + Response["notas_com_file"][x]["archivo"] +'" alt="image" /><div class="mask"><p>' + Response["notas_com_file"][x]["nombre"] +'</p><div class="tools tools-bottom"><a href="/static/notas/{{Id_empresa}}/' + Response["notas_com_file"][x]["archivo"] +'" download><i class="fa fa-download"></i></a><a href="/static/notas/{{Id_empresa}}/' + Response["notas_com_file"][x]["archivo"] +'" target="_blank"><i class="fa fa-external-link"></i></a></div></div></div><div class="caption"><p>' + Response["notas_com_file"][x]["descrip"] +'</p></div></div></div>'

              }
              new_tap = new_tap + '        </div></div></div></li>'
            //}



            if(Response["notas_com_txt"].length > 0){
              
              new_tap = new_tap + '<ul class="list-unstyled timeline widget" id="ul_notas_txt">'

              for (x = 0; x < Response["notas_com_txt"].length; x++) {
              new_tap = new_tap + '<li>'
              new_tap = new_tap + '         <div class="block">'
              new_tap = new_tap + '           <div class="block_content">'
              new_tap = new_tap + '             <h2 class="title"><a>'+ Response["notas_com_txt"][x]["usuario"] +'</a></h2>'
              new_tap = new_tap + '             <div class="byline"><p>'+Response["notas_com_txt"][x]["fecha"] +'</span></div>'

              new_tap = new_tap + '<p>'+Response["notas_com_txt"][x]["texto"]+'</p></div></div></li>' 
              }
              new_tap = new_tap + '</ul>'
            }





          new_tap =new_tap + '</ul></div></div>'

          $('#intnotaCab').html(new_tap_cab);
          $('#intnota').html(new_tap);
          $('#divbusca_nota_doc').html('');

  

          }

          
        });
}

$(document).ready(function(){

    

    document.getElementById("archivo_p12").addEventListener('change', cargarContenidoP12, false);


  $(".opciones_list").click(function(e){
  window.open("log/opciones/Ingresar/"+$(this).attr("id") +"/", '_blank');
      });

  $(".dropdown-item").click(function(e){


        //  $("#id"+ $(this).attr("id")).remove();
        //  $("#rr"+ $(this).attr("id")).empty();
          pestalla = pestalla +1;

          $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">' + $(this).attr("result") + ' <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a> </li>');





          if( $(this).attr("value") == "registro"){
          $.ajax({
            type: 'POST',
            url: '/menu_click',
            data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','pk': $(this).attr("id"), 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'pestalla':pestalla},
            beforeSend: function () {
              $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> <div style="padding-top: 15px;">Procesando </div></div>');
                  },
            success: function(Response){

              dict_pestalla['p-'+Response["pestalla"]] = Response


              data_new = '<div class="row" style="padding-top: 15px;"><div class="col-md-12">'
              if(Response["nuevo"] == 'Si'){
                data_new = data_new + '<button class="btn btn-primary" onclick="registro(' + Response["tabla"][0]["PkModulo"] +',0,0,' + Response["pestalla"] +',0)">{{idioma_html.nuevo}}</span></button>'
              }
              data_new = data_new + ''
              data_new = data_new + '<button type="button" onclick="cerrar_elemento(' + Response["pestalla"] +')" class="btn btn-warning">{{idioma_html.cerrar}}</span></button></div>'

              data_new = data_new + '<div class="col-md-3">'
              data_new = data_new + '</div>'

              data_new = data_new + '<div class="input-group">{{idioma_html.filtrar}}: '
  
          
              data_new = data_new + '<input type="text" id="valor' + Response["pestalla"] +'"  name="valor' + Response["pestalla"] +'" onkeydown="if(event.keyCode == 13){filtrar(' + Response["pestalla"] +')}">'
              data_new = data_new + ' {{idioma_html.max}}: <input type="number" id="top' + Response["pestalla"] +'"  name="top' + Response["pestalla"] +'" value="10" style="width: 40px;" onchange="filtrar(' + Response["pestalla"] +')">'
            data_new = data_new + '<select class="form-control col-sm-3" id="campo' + Response["pestalla"] +'" style="width: 200px;height: 25px;font-size: 11px;">'
            data_new = data_new +'<option>Todos</option>'

            for (x = 1; x < Response["names"].length; x++) {
                data_new = data_new +'<option>' + Response["names"][x][0] +'</option>'
              }
            data_new = data_new + '</select>'


              largo_tablaPX = 0
              for (x = 0; x < Response["estru"].length; x++) {
                largo_tablaPX = largo_tablaPX + parseInt(Response["estru"][x]["largo"])
              }


              data_new = data_new + '</div></div><div class="row"><div class="card-block text-left" style="overflow: auto;"><div id="tabla' + Response["pestalla"] +'"><table id="datatable-checkbox" width="100%;font-size: 11px;" class="table table-bordered bulk_action" style="background-color: white;overflow-x:auto;width: '+ largo_tablaPX +'px; font-size: 11px;">'

              data_new = data_new + '<thead><tr><th style="width: 80px;">{{idioma_html.Acciones}}</th>'
              

              for (x = 1; x < Response["names"].length; x++) {
                data_new = data_new + '<th style="width: '+ parseInt(Response["estru"][x]["largo"]) +'px;">' + Response["names"][x][0] +'</th>'
              }
              data_new = data_new + '</tr></thead><tbody>'


                data_new = data_new + ''
              for (x = 0; x < Response["dictlist"].length; x++) {
                data_new = data_new + '<tr id="f' + Response["tabla"][0]["PkModulo"] +'-f' + Response["dictlist"][x][0] +'"><td><div class="row" >'
                if(Response["modifica"] == "Si"){
                  data_new = data_new + '<a class="btn btn-success" onclick="registro(' + Response["tabla"][0]["PkModulo"] +',' + Response["dictlist"][x][0] +',1, ' + Response["pestalla"] +',0)" style="padding: 2px 2px; margin-right: 0px; margin-left: 5px;"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a>'
                }
                if(Response["eliminar"] == "Si"){
                  data_new = data_new + '<a class="btn btn-danger" onclick="eliminar(' + Response["tabla"][0]["PkModulo"] +',' + Response["dictlist"][x][0] +')" style="padding: 2px 2px; margin-right: 0px; margin-left: 0px;"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></a>'
                }
                data_new = data_new + '<a class="btn btn-primary" onclick="registro(' + Response["tabla"][0]["PkModulo"] +',' + Response["dictlist"][x][0] +',2, ' + Response["pestalla"] +',0)" style="padding: 2px 2px; margin-right: 0px; margin-left: 0px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></a></div></td>'

                for (x2 = 1; x2 < Response["names"].length; x2++) {

                  if(Response["modifica"] == "Si" && '{{Es_admin}}' == 'Y'){
                    if( !(Response["estru"][x2]["TablaCampo"] == "cmpnumsimple" || Response["estru"][x2]["TablaCampo"] == "cmpreferenciaadjunto" || Response["estru"][x2]["TablaCampo"] == "cmptxtsimple") ){
                    data_new = data_new + '<td><input type="text" class="form-control" value="' + Response["dictlist"][x][x2] +'" readonly="readonly"  style="font-size: 11px; height: 25px;"></td>'

                    }else{
                      id_tag_int = 'md'+ Response["pestalla"] +'zzz'+Response["names"][x2][0]+'jjj'+Response["dictlist"][x][0]
                      data_new = data_new + '<td><input type="text" id="'+ id_tag_int +'" class="form-control" value="' + Response["dictlist"][x][x2] +'" onkeypress="return runScript_modi_fast(event, ' + id_tag_int +')" style="font-size: 11px; height: 25px;"></td>'
                    }
                  }else{
                        data_new = data_new + '<td><input type="text" class="form-control" value="' + Response["dictlist"][x][x2] +'" readonly="readonly"  style="font-size: 11px; height: 25px;"></td>'                  }
                }
                  data_new = data_new + '</tr>'
              }
              data_new = data_new + '</tbody></table></div></div></div> '
           
              $('#rr' + Response["pestalla"]).html(data_new);

              document.getElementById('id'+ Response["pestalla"]).click();


              }
            });
          }
          if( $(this).attr("value") == "reporte"){
            $.ajax({
            type: 'POST',
            url: '/menu_reporte',
            data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','pkrepo': $(this).attr("id"), 'nombre_rep':$(this).attr("result"), 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'pestalla':pestalla},
            beforeSend: function () {

              $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> <div style="padding-top: 15px;"> Procesando </div></div>');
                  },
            success: function(Response){

              id_dic = 'p-' + pestalla
              dict_pestalla[id_dic] = Response

              data_int =  '<div class="panel-body" style="padding-top: 15px;">'
              data_int = data_int + '<button class="btn btn-primary" id="reporteejecutar" name="reporteejecutar" type="submit" value="' + Response['pkrepo'] + '" onclick="reporte_ejecutar('+ Response["pestalla"] +',0, '+ Response["pkrepo"] +')">{{idioma_html.ejecutar}}</button>' 
              data_int = data_int + '<button type="button" onclick="cerrar_elemento('+ Response["pestalla"] +')" class="btn btn-warning"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button>'
              data_int = data_int + '<div class="card-block text-left"><table class="table table-hover"><thead><tr><th></th><th></th><th></th></tr></thead><tbody>'

              for (x = 0; x < Response['variables_reprotes'].length; x++) {
                //data_int = data_int + '<br>'

                if(Response['variables_reprotes'][x]["tipo"] == "Texto"){
                    data_int = data_int + '<tr><td><strong>'+Response['variables_reprotes'][x]["glosa"] +':</td>'
                    data_int = data_int + '<td> <input type="text" id="var-'+ Response["pestalla"] +'-'+ Response['variables_reprotes'][x]["id"] +'" name="'+ Response['variables_reprotes'][x]["id_rep"] +'" value="%"></td>'
                    data_int = data_int + '<td></td></tr>'
                }else
                {
                  if(Response['variables_reprotes'][x]["tipo"] == "Valor"){
                      data_int = data_int + '<tr><td><strong>'+Response['variables_reprotes'][x]["glosa"] +':</td>'
                      data_int = data_int + '<td> <input type="text" id="var-'+ Response["pestalla"] +'-'+ Response['variables_reprotes'][x]["id"] +'" name="'+ Response['variables_reprotes'][x]["id_rep"] +'" value="0"></td>'
                      data_int = data_int + '<td></td></tr>'
                  }else{
                    data_int = data_int + '<tr><td><strong>'+Response['variables_reprotes'][x]["glosa"] +':</td>'
                    data_int = data_int + '<td> <input type="date" id="var-'+ Response["pestalla"] +'-'+ Response['variables_reprotes'][x]["id"] +'" name="'+ Response['variables_reprotes'][x]["id_rep"] +'" value="'+ Response['variables_reprotes'][x]["valor"] +'"></td>'
                    data_int = data_int + '<td></td></tr>'
                  }
                }
              }
              for (x = 0; x < Response['referencias_reprotes'].length; x++) {
                data_int = data_int + '<tr><td><strong>'+Response['referencias_reprotes'][x]["glosa"] +':</td>'
                data_int = data_int + '<td> <input type="text" id="rpzz'+ Response["pestalla"] +'zz'+ x +'zz'+Response['referencias_reprotes'][x]["id"] +'" name="'+Response['referencias_reprotes'][x]["id"] +'" value="%"></td>'
                data_int = data_int + '<td><button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_reporte(rpzz'+ Response["pestalla"] +'zz'+ x +'zz'+Response['referencias_reprotes'][x]["id"]+')"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button></td></tr>'


              }
              data_int = data_int + '</tbody></table></div>  '
              $('#rr' + Response["pestalla"]).html(data_int);
                document.getElementById('id'+ Response["pestalla"]).click();

              }
            });
          }

          });
      });


  $(window).load(function() {
   // executes when complete page is fully loaded, including all frames, objects and images
        traer_alertas()
        pre_ejecutados()

    




          $.ajax({
            type: 'POST',
            url: '/cargar_paneles',
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}'},
            beforeSend: function () {
                             },
            success: function(Response){


              for (x = 0; x < Response["paneles"].length; x++) {
                pestalla = pestalla +1;

                $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false" >' + Response["paneles"][x]["nombre"] + ' <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a></li>');



                $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> Procesando </div>');

                new_tap ='<div class="row" style="padding-top: 15px;">'


                new_tap = new_tap + '<div class="col-md-12"><button class="btn btn-primary" onclick="nuevonota(' + pestalla + ')">{{idioma_html.nuevo}}</button><button type="button" onclick="cerrar_panel(' + pestalla + ')" class="btn btn-warning">{{idioma_html.cerrar}}</button></div>'

                for (x2 = 0; x2 < Response["estados"][Response["paneles"][x]["pkpanel"]].length; x2++) {
                  new_tap = new_tap + '<div class="col-md-3">'
                  new_tap = new_tap + '<div class="x_panel">'

                  new_tap = new_tap + '<div class="x_title">'
                  new_tap = new_tap + ' <h2>' +Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["nombre"]+  '</h2>'
                  new_tap = new_tap + ' <div class="clearfix"></div></div>'

                  new_tap = new_tap + ' <div class="x_content">'
                  new_tap = new_tap + '   <div class="dashboard-widget-content">'
                  new_tap = new_tap + '     <ul class="list-unstyled timeline widget" id="ul_estadopk' +Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]+  '">'

                  for (x3 = 0; x3 < Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]].length; x3++) {

                    new_tap = new_tap + '       <li id="li_notapk'+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["pknota"]+'">'
                    //new_tap = new_tap + '<ul class="nav navbar-right panel_toolbox">   <div><a style="padding-right: 10px;padding-left: 10px;"><i class="fa fa-mail-forward"></i></a><a onclick="abrir_nota('+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["pknota"]+')"><i class="fa fa-comment"></i></a></div> </ul>'

                   

                   



                    new_tap = new_tap + '         <div class="block">'
                    new_tap = new_tap + '           <div class="block_content">'



                    new_tap = new_tap + '             <h2 class="title"><a>'+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["titulo"]+'</a></h2>'
                    new_tap = new_tap + '             <div class="byline"><p>'+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["fecha_inicio"]+' ' +Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["fecha_fin"]+ ' '+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["responable"]+'</span></div>'
                    new_tap = new_tap + '             <p class="excerpt">'+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["descripcion"]+'</p>'

                     new_tap = new_tap + '<div style="text-align: right;">'
                    
                    new_tap = new_tap + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-sm" onclick="abrir_nota('+Response["notas"][Response["estados"][Response["paneles"][x]["pkpanel"]][x2]["pkestado"]][x3]["pknota"]+' )"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>'
                    new_tap = new_tap + '</div>'


                    new_tap = new_tap + '           </div>'
                    new_tap = new_tap + '         </div>'
                    new_tap = new_tap + '       </li>'
                    }



                  new_tap = new_tap + '     </ul>'
                  new_tap = new_tap + '   </div>'
                  new_tap = new_tap + ' </div>'
                  new_tap = new_tap + '</div></div>'
                }

                new_tap =new_tap + '</div>'

                $('#rr' + pestalla).html(new_tap);
              }

              }
          });
          


          $.ajax({
            type: 'POST',
            url: '/cargar_charts',
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}'},
            beforeSend: function () {},
            success: function(Response){
              carga_charts(Response)

            }
          });

            var fecha_now = new Date();
            document.getElementById("calendar_date").value = fecha_now.format("Y-m-d")
            calendario() 

            document.getElementById('calendar-tab').click();
  });




var colorNames = Object.keys(window.chartColors);

function runScript_modi_fast(e, campo) {
    //See notes about 'which' and 'key'
    if (e.keyCode == 13) {
        modi_fast(campo)
    }else{
          var campo_int = document.getElementById(campo.id)
          campo_int.style.backgroundColor = "white"
    }
}

function modi_fast(campo){


  var cc_id = campo.id
  var res = cc_id.split("zzz");
  var res2 = res[1].split("jjj");


  var cc_pesta = res[0].substring(2);
  var cc_nombre  = res2[0]
  var cc_pk  = res2[1]

  var cc_tabla = dict_pestalla["p-" + cc_pesta]["tabla"][0]["Nombre"]
  var cc_valor =  campo.value
 
        $.ajax({
          type: 'POST',
          url: '/modi_fast',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','id': cc_id, 'pkregistro': cc_pk, 'tabla':cc_tabla, 'nombre':cc_nombre, 'valor':cc_valor, 'usuario':'{{usuario}}'},
          success: function(Response){
          var campo = document.getElementById(Response["id"])
          campo.style.backgroundColor = "lightgreen"
          }
        });

}

function cerrar_cemaforo(){
  $('#panel_cemaforo').remove();
  $('#home-tab').remove();

}

function carga_charts(Response){

  if(Response["lista_charts"].length>0){
    $('#panel_cemaforo').html('');
  }else{
    $('#panel_cemaforo').html('<div class="col-md-12"><div class="col-middle"><div class="text-center text-center"><h1 class="error-number"></h1><h2>No existe paneles validos</h2><p>Hable con su administrador para incluir indicadores o grÃ¡ficos</p><div class="weather-icon"><span><canvas height="84" width="84" id="partly-cloudy-day"></canvas></span></div></div></div></div>');
  }

    if(Response["lista_charts"].length >0 ){
        //add_tap ='<div class="col-md-12"><button type="button" onclick="cerrar_cemaforo()" class="btn btn-warning">{{idioma_html.cerrar}}</button></div>'

        add_tap = '<div class="x_panel"><div class="x_title"><h2><i class="fa fa-bars"></i><small>indicadores</small></h2><div class="clearfix"></div></div><div class="x_content" id="chart_indi"></div></div>'

        add_tap = add_tap +'<div class="x_panel"><div class="x_title"><h2><i class="fa fa-bars"></i><small>Barras</small></h2><div class="clearfix"></div></div><div class="x_content" id="chart_bars"></div></div>'


        //add_tap = add_tap + '<div class="x_panel"><div class="x_title"><h2><i class="fa fa-bars"></i><small>Pasteles</small></h2><div class="clearfix"></div></div><div class="x_content" id="chart_pie"></div></div>'

    }else{
      add_tap =''
    }
        var iDiv = document.createElement('div');
        iDiv.innerHTML= add_tap
        var divcemaforo = document.getElementById('panel_cemaforo');
        divcemaforo.appendChild(iDiv);

    for (y = 0; y < Response["lista_charts"].length; y++) {
      
      new_tap =  ''

      if(Response["lista_charts"][y]["tipo"]=='chart js'){
        var iDiv = document.createElement('div');
        iDiv.className  = Response["lista_charts"][y]["html_class"]

        new_tap = new_tap + '<canvas id="charts'+ Response["lista_charts"][y]["pk"] +'" class="chartjs-render-monitor"></canvas></div>'
        new_tap = new_tap + '</div>'


        iDiv.innerHTML= new_tap

        if(Response["lista_charts"][y]["modelo"]=='barras'){
          data_final = {}
          data_temp = []

          data_final['labels'] = Response["lista_charts"][y]["dato_x"].split(",")
          for (yy = 0; yy < Response["valores_charts"][Response["lista_charts"][y]["pk"]].length; yy++) {
            data_linea = {}

            data_linea['label'] = Response["valores_charts"][Response["lista_charts"][y]["pk"]][yy][Response["lista_charts"][y]["label"]]
            data_linea['backgroundColor'] = 'rgb('+ Math.floor(Math.random() * 254) +','+ Math.floor(Math.random() * 254) +','+ Math.floor(Math.random() * 254) +')'
            data_linea['borderColor'] = 'rgb('+ Math.floor(Math.random() * 254) +','+ Math.floor(Math.random() * 254) +','+ Math.floor(Math.random() * 254) +')'
            data_linea['fill'] = false

            data_valor = []
            columas = Response["lista_charts"][y]["dato_x"].split(",")
              for (y3 = 0; y3 < columas.length; y3++) {
                data_valor.push(Response["valores_charts"][Response["lista_charts"][y]["pk"]][yy][columas[y3]])
              }
            data_linea['data'] = data_valor
            data_temp.push(data_linea)
          }
          
          data_final['datasets'] = data_temp

          var config = {
              type: 'line',
              data: data_final,
              options: {responsive: true,title: {display: true,text: Response["lista_charts"][y]["descripcion"]},
                tooltips: {mode: 'index',intersect: false,},
                hover: {mode: 'nearest',intersect: true},
                scales: {
                  xAxes: [{display: true,scaleLabel: {display: true,labelString: Response["lista_charts"][y]["dato_x_name"]}}],
                  yAxes: [{display: true,scaleLabel: {display: true,labelString: Response["lista_charts"][y]["dato_y_name"]}}]
                }
              }
            };

          var divcemaforo = document.getElementById('chart_bars');
          divcemaforo.appendChild(iDiv);

          var canvas_int = document.getElementById('charts' +Response["lista_charts"][y]["pk"]).getContext('2d');
          window.myLine = new Chart(canvas_int, config);
        }

        if(Response["lista_charts"][y]["modelo"]=='pastel'){
          temp_valores = []
          temp_backgroundColor = []
          temp_labels = []

          for (yy = 0; yy < Response["valores_charts"][Response["lista_charts"][y]["pk"]].length; yy++) {
            temp_valores.push(Response["valores_charts"][Response["lista_charts"][y]["pk"]][yy][Response["lista_charts"][y]["dato_y_name"]])
            temp_backgroundColor.push('rgb('+ Math.floor(Math.random() * 254) +','+ Math.floor(Math.random() * 254) +','+ Math.floor(Math.random() * 254) +')')
            temp_labels.push(Response["valores_charts"][Response["lista_charts"][y]["pk"]][yy][Response["lista_charts"][y]["dato_x_name"]])
          }

          data_final = {}
          data_final['datasets'] = [{'data':temp_valores,'backgroundColor':temp_backgroundColor,'label':Response["lista_charts"][y]["titulo"]}]
          data_final['labels'] = temp_labels
           


          var config = {
              type: 'doughnut',
              data: data_final,
              options: {responsive: true,legend: {position: 'top',},
              title: {display: true,text: Response["lista_charts"][y]["titulo"]},
              animation: {animateScale: true,animateRotate: true}
              }
            };



          var divcemaforo = document.getElementById('chart_indi');
          divcemaforo.appendChild(iDiv);

          var canvas_int = document.getElementById('charts' +Response["lista_charts"][y]["pk"]).getContext('2d');
          window.myLine = new Chart(canvas_int, config);
        }

        if(Response["lista_charts"][y]["modelo"]=='barras_test'){





            var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            var config = {
                type: 'line',
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
                    datasets: [{
                        label: 'My First dataset',
                        backgroundColor: window.chartColors.red,
                        borderColor: window.chartColors.red,
                        data: [
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor()
                        ],
                        fill: false,
                    }, {
                        label: 'My Second dataset',
                        fill: false,
                        backgroundColor: window.chartColors.blue,
                        borderColor: window.chartColors.blue,
                        data: [
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor(),
                            randomScalingFactor()
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    title: {display: true,text: 'Chart.js Line Chart'},
                    tooltips: {mode: 'index',intersect: false,},
                    hover: {mode: 'nearest',intersect: true},
                    scales: {xAxes: [{display: true,scaleLabel: {display: true,labelString: 'Month'}}],yAxes: [{display: true,scaleLabel: {display: true,labelString: 'Value'}}]}
                }};


          var divcemaforo = document.getElementById('chart_bars');
          divcemaforo.appendChild(iDiv);

          var canvas_int = document.getElementById('charts' +Response["lista_charts"][y]["pk"]).getContext('2d');
          window.myLine = new Chart(canvas_int, config);
        }

      }
      if(Response["lista_charts"][y]["tipo"]=='echarts'){
        var iDiv = document.createElement('div');
        iDiv.className  = Response["lista_charts"][y]["html_class"]
        new_tap = new_tap + '<div id="charts'+ Response["lista_charts"][y]["pk"] +'" </div></div>'
        iDiv.innerHTML= new_tap

        var divcemaforo = document.getElementById('chart_indi');
        divcemaforo.appendChild(iDiv);


        if(Response["lista_charts"][y]["modelo"]=='gauge'){
            var dom = document.getElementById('charts'+ Response["lista_charts"][y]["pk"]);

            ch_meta = Response["valores_charts"][Response["lista_charts"][y]["pk"]][0][Response["lista_charts"][y]["dato_x_name"]]
            ch_valor = Response["valores_charts"][Response["lista_charts"][y]["pk"]][0][Response["lista_charts"][y]["dato_x"]]

            var gg1 = new JustGage({
              id: 'charts'+ Response["lista_charts"][y]["pk"],
              value : ch_valor,
              min: 0,
              max: ch_meta,
              height:170,
              width:200,
              title: Response["lista_charts"][y]["titulo"],
              decimals: 2,  
              gaugeWidthScale: 0.6,
              customSectors: [{color : "#ff0000",lo : 0,hi : (ch_meta / 4 )*1},{color : "#ffa600",lo : (ch_meta / 4 )*1,hi : (ch_meta / 4 )*2},{color : "#ffff00",lo : (ch_meta / 4 )*2,hi : (ch_meta / 4 )*3},{color : "#37ff00",lo : (ch_meta / 4 )*3,hi : ch_meta}],
              counter: true
            });

        }


      }
       
    }
        document.getElementById('home-tab').click();

}

function reporte_ejecutar(tem_pestalla, temp_nivel,  id){

  Response = dict_pestalla['p-'+tem_pestalla]
  senten = []
  str1 = []
  str2 = []
  str3 = []
  str4 = []
  str5 = []

  label = {}
  varref = {}
  varvar = {}

    for (x2 = 0; x2 < Response["Resto_reporte"][0].length; x2++) {
      str1.push(Response["Resto_reporte"][0][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < Response["Resto_reporte"][1].length; x2++) {
      str2.push(Response["Resto_reporte"][1][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < Response["Resto_reporte"][2].length; x2++) {
      str3.push(Response["Resto_reporte"][2][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < Response["Resto_reporte"][3].length; x2++) {
      str4.push(Response["Resto_reporte"][3][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < Response["Resto_reporte"][4].length; x2++) {
      str5.push(Response["Resto_reporte"][4][x2]["sentencia"]) 
    }
    for (x2 = 0; x2 < str1.length; x2++) {
      senten.push(str1[x2] + str2[x2] + str3[x2] + str4[x2] + str5[x2])
    }

    for (x = 0; x < Response["referencias_reprotes"].length; x++) {
      id_tem =  "rpzz" + tem_pestalla + "zz"+ x + "zz" + Response["referencias_reprotes"][x]["id"]
      varref[Response["referencias_reprotes"][x]["id_rep"]] = String(document.getElementById(id_tem).value)  
      label[Response["referencias_reprotes"][x]["id_rep"]] = Response["referencias_reprotes"][x]["glosa"]
    }

    for (x = 0; x < Response["variables_reprotes"].length; x++) {
      id_tem =  "var-"+ tem_pestalla + "-"+ Response["variables_reprotes"][x]["id"]
      varvar[Response["variables_reprotes"][x]["id_rep"]] = String(document.getElementById(id_tem).value)    
      label[Response["variables_reprotes"][x]["id_rep"]] = Response["variables_reprotes"][x]["glosa"]
  
    }
  $.ajax({
          type: 'POST',
          url: '/reporte_ejecutar',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','senten': JSON.stringify(senten), 'usuario':'{{usuario}}', 'label':JSON.stringify(label), 'varref':JSON.stringify(varref),'varvar':JSON.stringify(varvar), 'pestalla':tem_pestalla, 'id':id, 'nombre_rep':Response["nombre_rep"]},
          beforeSend: function () {
             
            data_int = '<div class="col-md-12" style="padding-top: 15px;"><div class="col-middle"><button type="button" onclick="cerrar_elemento(' + tem_pestalla +')" class="btn btn-warning"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button><div class="text-center text-center"><h1 class="error-number"></h1><h2>{{idioma_html.espere}}</h2><p>{{idioma_html.carga}}.</p><div class="weather-icon"><span><canvas height="84" width="84" id="partly-cloudy-day"></canvas></span></div></div></div></div>'
            $('#rr' +tem_pestalla).html(data_int);            


            },
          success: function(Response){

            dict_pestalla['p-'+Response["pestalla"]] = Response
            dict_pestalla['p-'+Response["pestalla"]]["vinculacion"] = {}
            reppuesta_rep = Response["resutado"]

            data_int =  '<div style="padding-top: 15px;"><div class="panel-body" style="overflow: auto;"><div class="row"><button class="btn btn-primary" id="reporteejecutar" name="reporteejecutar" type="submit" value="4" onclick="reejecutar_reprote(' + Response["id"] + ')">{{idioma_html.nuevo}}</button><button type="button" onclick="cerrar_elemento(' + Response["pestalla"] + ')" class="btn btn-warning"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button><button type="button" data-toggle="tooltip" data-placement="top" title="Pdf" onclick="pdf_reporte(' + Response["pestalla"] + ')" class="btn btn-info"><span class="fa fa-file-pdf-o" aria-hidden="true"></span></button><button type="button" data-toggle="tooltip" data-placement="top" title="Excell" onclick="excell_reporte(' + Response["pestalla"] + ')" class="btn btn-info"><span class="fa fa-file-excel-o" aria-hidden="true"></span></button>filtrar: <input type="text" id="fil_rep-' + Response["pestalla"] + '" onkeypress="return runScript_rep_filtro(event, ' + Response["pestalla"] + ')"></div>'
            data_int = data_int + '<div style="overflow: auto;height: 600px;">'

            data_int = data_int + html_rep(reppuesta_rep, Response["pestalla"]) + '</div>'




            $('#rr' +tem_pestalla).html(data_int);  



          } 
    });

}

function html_rep(reppuesta_rep, t_pestalla){
    data_rep = ''
    if(reppuesta_rep.length == 1){
        data_rep = '<table width="100%" class="table  table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr>'
        for (y = 0; y < reppuesta_rep[0][0].length; y++) {
            data_rep= data_rep + '<th>' +  reppuesta_rep[0][0][y][0] + '</th>'  
        }
        data_rep= data_rep + '</tr></thead><tbody>'  

        for (y = 0; y < reppuesta_rep[0][1].length; y++) {
            data_rep= data_rep + '<tr>'  
            for (y2 = 0; y2 < reppuesta_rep[0][0].length; y2++) {
                if(reppuesta_rep[0][0][y2][0]!='$vinculo_out' && reppuesta_rep[0][0][y2][0]!='$vinculo_in' && reppuesta_rep[0][0][y2][0][0]!='$'){
                    
                    if(reppuesta_rep[0][0][y2][0]=='imagen'){
                        data_rep= data_rep + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" target="_blank">' +  reppuesta_rep[0][1][y][y2] + '</a></div></div></div></td>'  
                    }else{
                        data_rep= data_rep + '<td>' +  reppuesta_rep[0][1][y][y2] + '</td>'  
                    }
                }
            }
            data_rep= data_rep + '</tr>'      
        }
        data_rep= data_rep + '</tbody></table>'  
    }

    if(reppuesta_rep.length == 2){
        data_rep = '<table width="100%" class="table  table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr>'
        data_rep= data_rep + '<th style="width: 15px;"></th>'  

        for (y = 0; y < reppuesta_rep[0][0].length; y++) {
            if(reppuesta_rep[0][0][y][0]!='$vinculo_out' && reppuesta_rep[0][0][y][0]!='$vinculo_in' && reppuesta_rep[0][0][y][0][0]!='$'){
                data_rep= data_rep + '<th>' +  reppuesta_rep[0][0][y][0] + '</th>'  
            }
        }
        data_rep= data_rep + '</tr></thead><tbody>'  

        for (y = 0; y < reppuesta_rep[0][1].length; y++) {
            data_rep= data_rep + '<tr><td>**btn**</td>'  
            for (y2 = 0; y2 < reppuesta_rep[0][0].length; y2++) {
                vinculo_out = ''
                if(reppuesta_rep[0][0][y2][0]!='$vinculo_out' && reppuesta_rep[0][0][y2][0]!='$vinculo_in' && reppuesta_rep[0][0][y2][0][0]!='$'){
                    if(reppuesta_rep[0][0][y2][0]=='imagen'){
                        data_rep= data_rep + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" target="_blank">' +  reppuesta_rep[0][1][y][y2] + '</a></div></div></div></td>'  
                    }else{
                        data_rep= data_rep + '<td>' +  reppuesta_rep[0][1][y][y2] + '</td>'  
                    }
                }
                if(reppuesta_rep[0][0][y2][0]=='$vinculo_out'){
                    vinculo_out = reppuesta_rep[0][1][y][y2]

                }
            }   
            data_rep= data_rep + '</tr>'  

            //-------------------------------------------nivel 1

            data_sub = '<tr id="dr-'+t_pestalla+ '-' + y +'-0" hidden style="background-color: aliceblue;"><td colspan="15"> <div><div class="panel-body" style="overflow: auto;padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 50px;"><table width="100%" class="table  table-hover" style="background-color: aliceblue;margin-bottom: 0px;"><thead><tr>'
            for (x = 0; x < reppuesta_rep[1][0].length; x++) {
                if(reppuesta_rep[1][0][x][0]!='$vinculo_out' && reppuesta_rep[1][0][x][0]!='$vinculo_in' && reppuesta_rep[1][0][x][0][0]!='$'){
                    data_sub = data_sub + '<th>' +  reppuesta_rep[1][0][x][0] + '</th>'  
                }
            }
            data_sub = data_sub + '</tr></thead><tbody>' 
                
            hay_fila = 0
            for (x = 0; x < reppuesta_rep[1][1].length; x++) {
                data_sub= data_sub + ''  
                pasa_fila = 0
                data_fila = ''               
                for (x2 = 0; x2 < reppuesta_rep[1][0].length; x2++) {
                    if(reppuesta_rep[1][0][x2][0]!='$vinculo_out' && reppuesta_rep[1][0][x2][0]!='$vinculo_in' && reppuesta_rep[1][0][x2][0][0]!='$'){
                        if(reppuesta_rep[1][0][x2][0]=='imagen'){
                            data_fila= data_fila + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[1][1][x][x2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[1][1][x][x2] + '" target="_blank">' +  reppuesta_rep[1][1][x][x2] + '</a></div></div></div></td>'  
                        }else{
                            data_fila= data_fila + '<td>' +  reppuesta_rep[1][1][x][x2] + '</td>'  
                        }
                    }
                    if(reppuesta_rep[1][0][x2][0] == '$vinculo_in' ){
                        if( vinculo_out == reppuesta_rep[1][1][x][x2] ){
                            pasa_fila = 1
                            hay_fila = 1
                        }
                    }
                }
                if(pasa_fila == 1){
                    dict_pestalla['p-'+t_pestalla]["vinculacion"]['1-'+ x] = y 
                    data_sub = data_sub + '<tr>' + data_fila + '</tr>'
                }
            }
            data_sub = data_sub + '</tbody></table></div></div></td></tr>'

            if(hay_fila == 1){
                data_rep = data_rep + data_sub
                btn_abrir = '<button type="button" id="btn-'+t_pestalla+'-'+ y +'-0" style="padding: 1px 6px;margin-bottom: 0px;margin-right: 0px; background-color: darkblue;" onclick="abrir_subrep('+t_pestalla+', '+ y +',0)" class="btn btn-round btn-success"><span class="fa fa-plus" aria-hidden="true"></span></button>'
                data_rep = data_rep.replace('**btn**',btn_abrir)
            }else{
                data_rep = data_rep.replace('**btn**','')

            }

            //-------------------------------------------nivel 1
            //data_rep= data_rep + '</tr>'      
        }
        data_rep= data_rep + '</tbody></table>'  
    }

    if(reppuesta_rep.length == 3){
        data_rep = '<table width="100%" class="table  table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr>'
        data_rep= data_rep + '<th style="width: 15px;"></th>'  

        for (y = 0; y < reppuesta_rep[0][0].length; y++) {
            if(reppuesta_rep[0][0][y][0]!='$vinculo_out' && reppuesta_rep[0][0][y][0]!='$vinculo_in' && reppuesta_rep[0][0][y][0][0]!='$'){
                data_rep= data_rep + '<th>' +  reppuesta_rep[0][0][y][0] + '</th>'  
            }
        }
        data_rep= data_rep + '</tr></thead><tbody>'  

        for (y = 0; y < reppuesta_rep[0][1].length; y++) {
            data_rep= data_rep + '<tr><td>**btn**</td>'  
            for (y2 = 0; y2 < reppuesta_rep[0][0].length; y2++) {
                vinculo_out = ''
                if(reppuesta_rep[0][0][y2][0]!='$vinculo_out' && reppuesta_rep[0][0][y2][0]!='$vinculo_in' && reppuesta_rep[0][0][y2][0][0]!='$'){
                    
                    if(reppuesta_rep[0][0][y2][0]=='imagen'){
                        data_rep= data_rep + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" target="_blank">' +  reppuesta_rep[0][1][y][y2] + '</a></div></div></div></td>'  
                    }else{
                        data_rep= data_rep + '<td>' +  reppuesta_rep[0][1][y][y2] + '</td>'  
                    }
                }
                if(reppuesta_rep[0][0][y2][0]=='$vinculo_out'){
                    vinculo_out = reppuesta_rep[0][1][y][y2]

                }
            }
            data_rep= data_rep + '</tr>'  

            //-------------------------------------------nivel 1
                data_sub = '<tr id="dr-'+t_pestalla+ '-' + y +'-0" hidden><td colspan="15" > <div><div class="panel-body" style="overflow: auto;padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 50px;"><table width="100%" class="table  table-hover" style="background-color: aliceblue;margin-bottom: 0px;"><thead><tr><th style="width: 15px;"></th>'

                for (x = 0; x < reppuesta_rep[1][0].length; x++) {
                    if(reppuesta_rep[1][0][x][0]!='$vinculo_out' && reppuesta_rep[1][0][x][0]!='$vinculo_in' && reppuesta_rep[1][0][x][0][0]!='$'){
                        data_sub = data_sub + '<th>' +  reppuesta_rep[1][0][x][0] + '</th>'  
                    }
                }
                data_sub = data_sub + '</tr></thead><tbody>' 
                    
                hay_fila = 0
                for (x = 0; x < reppuesta_rep[1][1].length; x++) {
                    data_sub= data_sub + ''  
                    pasa_fila = 0
                    data_fila = '<td>**btn2**</td>' 

                    for (x2 = 0; x2 < reppuesta_rep[1][0].length; x2++) {
                        if(reppuesta_rep[1][0][x2][0]!='$vinculo_out' && reppuesta_rep[1][0][x2][0]!='$vinculo_in' && reppuesta_rep[1][0][x2][0][0]!='$'){


                            if(reppuesta_rep[1][0][x2][0]=='imagen'){
                                data_fila= data_fila + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[1][1][x][x2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[1][1][x][x2] + '" target="_blank">' +  reppuesta_rep[1][1][x][x2] + '</a></div></div></div></td>'  
                            }else{
                                data_fila= data_fila + '<td>' +  reppuesta_rep[1][1][x][x2] + '</td>'  
                            }

                        }
                        if(reppuesta_rep[1][0][x2][0] == '$vinculo_in' ){
                            if( vinculo_out == reppuesta_rep[1][1][x][x2] ){
                                pasa_fila = 1
                                hay_fila = 1
                            }
                        }
                        if(reppuesta_rep[1][0][x2][0] == '$vinculo_out' ){
                            vinculo_out2 = reppuesta_rep[1][1][x][x2]
                        }
                    }

                    if(pasa_fila == 1){
                        dict_pestalla['p-'+t_pestalla]["vinculacion"]['1-'+ x] = y 
                        data_sub = data_sub + '<tr>' + data_fila + '</tr>'
                    //------------------------------------nivel 2

                   
                        data_sub2 = '<tr id="dr-'+t_pestalla+ '-' + x +'-1" hidden><td colspan="15"> <div><div class="panel-body" style="overflow: auto;padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 50px;"><table width="100%" class="table  table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr>'
                        for (z = 0; z < reppuesta_rep[2][0].length; z++) {
                            if(reppuesta_rep[2][0][z][0]!='$vinculo_out' && reppuesta_rep[2][0][z][0]!='$vinculo_in' && reppuesta_rep[2][0][z][0][0]!='$'){
                                data_sub2 = data_sub2 + '<th>' +  reppuesta_rep[2][0][z][0] + '</th>'  
                            }
                        }
                        data_sub2 = data_sub2 + '</tr></thead><tbody>' 
                            
                        hay_fila2 = 0
                        for (z = 0; z < reppuesta_rep[2][1].length; z++) {
                            data_sub2= data_sub2 + ''  
                            pasa_fila2 = 0
                            data_fila2 = ''  
                            for (z2 = 0; z2 < reppuesta_rep[2][0].length; z2++) {
                                if(reppuesta_rep[2][0][z2][0]!='$vinculo_out' && reppuesta_rep[2][0][z2][0]!='$vinculo_in' && reppuesta_rep[2][0][z2][0][0]!='$'){


                                    if(reppuesta_rep[2][0][z2][0]=='imagen'){
                                        data_fila2= data_fila2 + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%;margin-left: auto;margin-right: auto; display: block;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[2][1][z][z2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[2][1][z][z2] + '" target="_blank">' +  reppuesta_rep[2][1][z][z2] + '</a></div></div></div></td>'  
                                    }else{
                                        data_fila2= data_fila2 + '<td>' +  reppuesta_rep[2][1][z][z2] + '</td>'  
                                    }

                                }
                                if(reppuesta_rep[2][0][z2][0] == '$vinculo_in' ){
                                    if( vinculo_out2 == reppuesta_rep[2][1][z][z2] ){
                                        pasa_fila2 = 1
                                        hay_fila2 = 1
                                    }
                                }
                            }
                            if(pasa_fila2 == 1){
                                data_sub2 = data_sub2 + '<tr>' + data_fila2 + '</tr>'
                            }
                        }

                        if(hay_fila2 == 1){
                            dict_pestalla['p-'+t_pestalla]["vinculacion"]['2-'+ z] = x 

                            btn_abrir2 = '<button type="button" id="btn-'+t_pestalla+'-'+ x +'-1" style="padding: 1px 6px;margin-bottom: 0px;margin-right: 0px; background-color: darkblue;" onclick="abrir_subrep('+t_pestalla+', '+ x +',1)" class="btn btn-round btn-success"><span class="fa fa-plus" aria-hidden="true"></span></button>'
                            data_sub = data_sub.replace('**btn2**',btn_abrir2)
                            data_sub = data_sub + data_sub2 + '</tbody></table></div></div></td></tr>'
                        }else{
                            data_sub = data_sub.replace('**btn2**','')

                        }

                    //------------------------------------nivel 2
                    //data_sub = data_sub + '</tbody></table></div></div></td></tr>'

                    }
                }
                data_sub = data_sub + '</tbody></table></div></div></td></tr>'
                if(hay_fila == 1){
                    data_rep = data_rep + data_sub
                    btn_abrir = '<button type="button" id="btn-'+t_pestalla+'-'+ y +'-0" style="padding: 1px 6px;margin-bottom: 0px;margin-right: 0px; background-color: darkblue;" onclick="abrir_subrep('+t_pestalla+', '+ y +',0)" class="btn btn-round btn-success"><span class="fa fa-plus" aria-hidden="true"></span></button>'
                    data_rep = data_rep.replace('**btn**',btn_abrir)
                }else{
                    data_rep = data_rep.replace('**btn**','')

                }
           

            //-------------------------------------------nivel 1
            //data_rep= data_rep + '</tr>'      
        }
        data_rep= data_rep + '</tbody></table>'  
    }

    if(reppuesta_rep.length == 4){
        data_rep = '<table width="100%" class="table  table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr>'
        data_rep= data_rep + '<th style="width: 15px;"></th>'  

        for (y = 0; y < reppuesta_rep[0][0].length; y++) {
            if(reppuesta_rep[0][0][y][0]!='$vinculo_out' && reppuesta_rep[0][0][y][0]!='$vinculo_in' && reppuesta_rep[0][0][y][0][0]!='$'){
                data_rep= data_rep + '<th>' +  reppuesta_rep[0][0][y][0] + '</th>'  
            }
        }
        data_rep= data_rep + '</tr></thead><tbody>'  

        for (y = 0; y < reppuesta_rep[0][1].length; y++) {
            data_rep= data_rep + '<tr><td>**btn**</td>'  
            for (y2 = 0; y2 < reppuesta_rep[0][0].length; y2++) {
                vinculo_out = ''
                if(reppuesta_rep[0][0][y2][0]!='$vinculo_out' && reppuesta_rep[0][0][y2][0]!='$vinculo_in' && reppuesta_rep[0][0][y2][0][0]!='$'){
                    if(reppuesta_rep[0][0][y2][0]=='imagen'){
                        data_rep= data_rep + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%;margin-left: auto;margin-right: auto; display: block;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[0][1][y][y2] + '" target="_blank">' +  reppuesta_rep[0][1][y][y2] + '</a></div></div></div></td>'  
                    }else{
                        data_rep= data_rep + '<td>' +  reppuesta_rep[0][1][y][y2] + '</td>'  
                    }
                }
                if(reppuesta_rep[0][0][y2][0]=='$vinculo_out'){
                    vinculo_out = reppuesta_rep[0][1][y][y2]

                }
            }
            data_rep= data_rep + '</tr>'  

            //-------------------------------------------nivel 1
                data_sub = '<tr id="dr-'+t_pestalla+ '-' + y +'-0" hidden ><td colspan="15"> <div><div class="panel-body" style="overflow: auto;padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 50px;"><table width="100%" class="table  table-hover" style="background-color: aliceblue;margin-bottom: 0px;"><thead><tr><th style="width: 15px;"></th>'

                for (x = 0; x < reppuesta_rep[1][0].length; x++) {
                    if(reppuesta_rep[1][0][x][0]!='$vinculo_out' && reppuesta_rep[1][0][x][0]!='$vinculo_in' && reppuesta_rep[1][0][x][0][0]!='$'){
                        data_sub = data_sub + '<th>' +  reppuesta_rep[1][0][x][0] + '</th>'  
                    }
                }
                data_sub = data_sub + '</tr></thead><tbody>' 
                    
                hay_fila = 0
                for (x = 0; x < reppuesta_rep[1][1].length; x++) {
                    data_sub= data_sub + ''  
                    pasa_fila = 0
                    data_fila = '<td>**btn2**</td>' 

                    for (x2 = 0; x2 < reppuesta_rep[1][0].length; x2++) {
                        if(reppuesta_rep[1][0][x2][0]!='$vinculo_out' && reppuesta_rep[1][0][x2][0]!='$vinculo_in' && reppuesta_rep[1][0][x2][0][0]!='$'){
                            if(reppuesta_rep[1][0][x2][0]=='imagen'){
                                data_fila= data_fila + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[1][1][x][x2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[1][1][x][x2] + '" target="_blank">' +  reppuesta_rep[1][1][x][x2] + '</a></div></div></div></td>'  
                            }else{
                                data_fila= data_fila + '<td>' +  reppuesta_rep[1][1][x][x2] + '</td>'  
                            }
                        }
                        if(reppuesta_rep[1][0][x2][0] == '$vinculo_in' ){
                            if( vinculo_out == reppuesta_rep[1][1][x][x2] ){
                                pasa_fila = 1
                                hay_fila = 1
                            }
                        }
                        if(reppuesta_rep[1][0][x2][0] == '$vinculo_out' ){
                            vinculo_out2 = reppuesta_rep[1][1][x][x2]
                        }
                    }

                    if(pasa_fila == 1){
                        dict_pestalla['p-'+t_pestalla]["vinculacion"]['1-'+ x] = y 
                        //data_sub = data_sub + '<tr>1-'+ x + ':'+ y + '// '+data_fila + '</tr>'
                        data_sub = data_sub + '<tr>'+data_fila + '</tr>'

                    //------------------------------------nivel 2

                   
                        data_sub2 = '<tr id="dr-'+t_pestalla+ '-' + x +'-1" hidden><td colspan="10"> <div><div class="panel-body" style="overflow: auto;padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 50px;"><table width="100%" class="table  table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr><th style="width: 15px;"></th>'
                        for (z = 0; z < reppuesta_rep[2][0].length; z++) {
                            if(reppuesta_rep[2][0][z][0]!='$vinculo_out' && reppuesta_rep[2][0][z][0]!='$vinculo_in' && reppuesta_rep[2][0][z][0][0]!='$'){
                                data_sub2 = data_sub2 + '<th>' +  reppuesta_rep[2][0][z][0] + '</th>'  
                            }
                        }
                        data_sub2 = data_sub2 + '</tr></thead><tbody>' 
                            
                        hay_fila2 = 0
                        for (z = 0; z < reppuesta_rep[2][1].length; z++) {
                            data_sub2= data_sub2 + ''  
                            pasa_fila2 = 0
                            data_fila2 = '<td>**btn3**</td>' 
 
                            for (z2 = 0; z2 < reppuesta_rep[2][0].length; z2++) {
                                if(reppuesta_rep[2][0][z2][0]!='$vinculo_out' && reppuesta_rep[2][0][z2][0]!='$vinculo_in' && reppuesta_rep[2][0][z2][0][0]!='$'){
                                    if(reppuesta_rep[2][0][z2][0]=='imagen'){
                                        data_fila2= data_fila2 + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[2][1][z][z2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[2][1][z][z2] + '" target="_blank">' +  reppuesta_rep[2][1][z][z2] + '</a></div></div></div></td>'  
                                    }else{
                                        data_fila2= data_fila2 + '<td>' +  reppuesta_rep[2][1][z][z2] + '</td>'  
                                    }                                }
                                if(reppuesta_rep[2][0][z2][0] == '$vinculo_in' ){
                                    if( vinculo_out2 == reppuesta_rep[2][1][z][z2] ){
                                        pasa_fila2 = 1
                                        hay_fila2 = 1
                                    }
                                }
                                if(reppuesta_rep[2][0][z2][0] == '$vinculo_out' ){
                                    vinculo_out3 = reppuesta_rep[2][1][z][z2]
                                }
                            }
                            if(pasa_fila2 == 1){
                                dict_pestalla['p-'+t_pestalla]["vinculacion"]['2-'+ z] = x 
                            //data_sub2 = data_sub2 + '<tr>2-' + z + ':'+ x + '// '+ data_fila2 + '</tr>'
                                data_sub2 = data_sub2 + '<tr>' + data_fila2 + '</tr>'

                            //------------------------------------nivel 3

                           
                                data_sub3 = '<tr id="dr-'+t_pestalla+ '-' + z +'-2" hidden><td colspan="10"> <div><div class="panel-body" style="overflow: auto;padding-top: 0px;padding-right: 0px;padding-bottom: 0px;padding-left: 50px;"><table width="100%" class="table table-hover" style="background-color: white;margin-bottom: 0px;"><thead><tr>'
                                for (a = 0; a < reppuesta_rep[3][0].length; a++) {
                                    if(reppuesta_rep[3][0][a][0]!='$vinculo_out' && reppuesta_rep[3][0][a][0]!='$vinculo_in' && reppuesta_rep[3][0][a][0][0]!='$'){

                                        data_sub3 = data_sub3 + '<th>' +  reppuesta_rep[3][0][a][0].replace('@','') + '</th>'  
                                    }
                                }
                                data_sub3 = data_sub3 + '</tr></thead><tbody>' 
                                    
                                hay_fila3 = 0
                                for (a = 0; a < reppuesta_rep[3][1].length; a++) {
                                    data_sub3= data_sub3 + ''  
                                    pasa_fila3 = 0
                                    data_fila3 = ''  
                                    for (a2 = 0; a2 < reppuesta_rep[3][0].length; a2++) {
                                        if(reppuesta_rep[3][0][a2][0]!='$vinculo_out' && reppuesta_rep[3][0][a2][0]!='$vinculo_in' && reppuesta_rep[3][0][a2][0][0]!='$'){


                                    if(reppuesta_rep[3][0][a2][0]=='imagen'){
                                        data_fila3= data_fila3 + '<td><div style="width: 100px;"><div class="thumbnail" style="height: 110px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%; display: block;margin-left: auto;margin-right: auto;" src="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[3][1][a][a2] + '" alt="image" value="0"><a href="/media/archivos/{{Id_empresa}}/' +  reppuesta_rep[3][1][a][a2] + '" target="_blank">' +  reppuesta_rep[3][1][a][a2] + '</a></div></div></div></td>'  
                                    }else{
                                        if(reppuesta_rep[3][0][a2][0][0]=='@'){
                                            valore = reppuesta_rep[3][1][a][a2].split('-')

                                            data_fila3= data_fila3 + '<td><u><a onclick="registro_de_rep('+ valore[0] + ', '+ valore[1] + ', '+ valore[2] + ')" style="cursor: pointer;">' +  valore[3] + '</a></u></td>'  
     

                                        }else{
                                            data_fila3= data_fila3 + '<td>' +  reppuesta_rep[3][1][a][a2] + '</td>'  
                                        }


                                    }
                                        }
                                        if(reppuesta_rep[3][0][a2][0] == '$vinculo_in' ){
                                            if( vinculo_out3 == reppuesta_rep[3][1][a][a2] ){
                                                pasa_fila3 = 1
                                                hay_fila3 = 1
                                            }
                                        }
                                    }
                                    if(pasa_fila3 == 1){
                                        dict_pestalla['p-'+t_pestalla]["vinculacion"]['3-'+ a] = z 
                                        //data_sub3 = data_sub3 + '<tr>3-' + a + ':'+ z + '// '+ data_fila3 + '</tr>'
                                        data_sub3 = data_sub3 + '<tr>' + data_fila3 + '</tr>'

                                    }
                                }

                                if(hay_fila3 == 1){

                                    btn_abrir3 = '<button type="button" id="btn-'+t_pestalla+'-'+ z +'-2" style="padding: 1px 6px;margin-bottom: 0px;margin-right: 0px; background-color: darkblue;" onclick="abrir_subrep('+t_pestalla+', '+ z +',2)" class="btn btn-round btn-success"><span class="fa fa-plus" aria-hidden="true"></span></button>'
                                    data_sub2 = data_sub2.replace('**btn3**',btn_abrir3)
                                    data_sub2 = data_sub2 + data_sub3 + '</tbody></table></div></div></td></tr>'
                                }else{
                                    data_sub2 = data_sub2.replace('**btn3**','')

                                }

                            //------------------------------------nivel 3


                            }
                        }

                        if(hay_fila2 == 1){
                            btn_abrir2 = '<button type="button" id="btn-'+t_pestalla+'-'+ x +'-1" style="padding: 1px 6px;margin-bottom: 0px;margin-right: 0px; background-color: darkblue;" onclick="abrir_subrep('+t_pestalla+', '+ x +',1)" class="btn btn-round btn-success"><span class="fa fa-plus" aria-hidden="true"></span></button>'
                            data_sub = data_sub.replace('**btn2**',btn_abrir2)
                            data_sub = data_sub + data_sub2 + '</tbody></table></div></div></td></tr>'
                        }else{
                            data_sub = data_sub.replace('**btn2**','')

                        }

                    //------------------------------------nivel 2
                    //data_sub = data_sub + '</tbody></table></div></div></td></tr>'

                    }
                }
                data_sub = data_sub + '</tbody></table></div></div></td></tr>'
                if(hay_fila == 1){
                    data_rep = data_rep + data_sub
                    btn_abrir = '<button type="button" id="btn-'+t_pestalla+'-'+ y +'-0" style="padding: 1px 6px;margin-bottom: 0px;margin-right: 0px; background-color: darkblue;" onclick="abrir_subrep('+t_pestalla+', '+ y +',0)" class="btn btn-round btn-success"><span class="fa fa-plus" aria-hidden="true"></span></button>'
                    data_rep = data_rep.replace('**btn**',btn_abrir)
                }else{
                    data_rep = data_rep.replace('**btn**','')

                }
            //-------------------------------------------nivel 1
            //data_rep= data_rep + '</tr>'      
        }
        data_rep= data_rep + '</tbody></table>'  
    }


    return data_rep

}

function pdf_reportedet(temp_pest, fila){
    
    reppuesta_rep = dict_pestalla['p-'+temp_pest] 
    var date = new Date()

      var vinculos = []
      for (z = 0; z < reppuesta_rep["resutado"][0][0].length; z++){
        if(reppuesta_rep["resutado"][0][0][z][0] == '$vinculo'){
          vinculos.push(z)
        }
      }

      for (z = 0; z < reppuesta_rep["resutado"][1][0].length; z++){
        if(reppuesta_rep["resutado"][1][0][z][0] == '$vinculo'){
          vinculos.push(z)
        }
      }      
   



    var dbvariables = ""

    for (x2 = 0; x2 < Object.keys(reppuesta_rep["repvariables"]).length; x2++){
        dbvariables = dbvariables + reppuesta_rep["label"][Object.keys(reppuesta_rep['repvariables'])[x2]]+ ": " +  reppuesta_rep["repvariables"][Object.keys(reppuesta_rep['repvariables'])[x2]] + ' / '
    }
    for (x2 = 0; x2 < Object.keys(reppuesta_rep["repreferencias"]).length; x2++){
        dbvariables = dbvariables + reppuesta_rep["label"][Object.keys(reppuesta_rep['repreferencias'])[x2]]+ ": " +  reppuesta_rep["repreferencias"][Object.keys(reppuesta_rep['repreferencias'])[x2]] + ' / '
    }
    var tipo_pag = ''

    if (reppuesta_rep["repstilo"][0]["posicion"] == "Horizontal") {
      tipo_pag = 'landscape'
      
    }

    var doc = new jsPDF(tipo_pag);



     doc.setFontSize(10);
     doc.text(10, 10, '{{Id_empresa}}: ' + reppuesta_rep["nombre_rep"] + ', {{idioma_html.fecha}}:' + date.toLocaleDateString() + " " + date.toLocaleTimeString() );
     doc.text(10, 15, dbvariables.substring(0, dbvariables.length-2));

    var conv_cc = 0.375
    var filaX = 10
    var filaY = 25

    columnas = reppuesta_rep["repstilo"][0]["columnas"].split(',')
    columnas_largo = reppuesta_rep["repstilo"][0]["largos"].split(',')

    imprimio_cabecera = false

      filaX = 10

        for (x2 = 0; x2 < columnas.length; x2++){
          doc.line(filaX -0.5, filaY - 5, filaX-0.5, filaY +0.5);
          doc.line(filaX -0.5 , filaY - 5 , filaX  + (columnas_largo[x2] * conv_cc) -0.5 , filaY- 5);

          doc.text(filaX, filaY, columnas[x2]);
          filaX = filaX + (columnas_largo[x2] * conv_cc)
        }
        doc.line(filaX-0.5, filaY - 5, filaX-0.5, filaY +0.5);  
        doc.line(filaX-0.5 , filaY - 5 , filaX  + (columnas_largo[x2] * conv_cc) -0.5  , filaY- 5);

        imprimio_cabecera = true
        filaY = filaY + 5
      
      filaX = 10
      for (x2 = 0; x2 < columnas.length; x2++){
        for (x3 = 0; x3 < reppuesta_rep["resutado"][0][0].length; x3++){
          if(reppuesta_rep["resutado"][0][0][x3][0] == columnas[x2]){
            doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY+0.5);
            doc.line(filaX-0.5 , filaY - 4.5 , (filaX  + (columnas_largo[x2] * conv_cc))-0.5  , filaY - 4.5 ,);

            var escri = reppuesta_rep["resutado"][0][1][fila][x3] 
            if((escri.length *6.5) > columnas_largo[x2]){escri = escri.substring(0, Math.round(columnas_largo[x2] / 6.5) )+'...'}
            if(isNaN(escri) == true){doc.text(filaX , filaY, escri); 
            }else{doc.text(filaX + ( (columnas_largo[x2] * conv_cc)-2) , filaY, escri, 'right');}
          }
        }
        filaX = filaX + (columnas_largo[x2] * conv_cc)
        doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY+0.5);
        //doc.line(filaX , filaY - 5 , (filaX  + (columnas_largo[x2] * conv_cc)) , filaY- 5);
      }
      filaY = filaY + 5
      
      
      //valor

      
        var imprimio_cabeceradet = false
        columnasdet = reppuesta_rep["repstilo"][1]["columnas"].split(',')
        columnas_largodet = reppuesta_rep["repstilo"][1]["largos"].split(',')
        var entro = false
        for (y = 0; y < reppuesta_rep["resutado"][1][1].length; y++){
          
          if(reppuesta_rep["resutado"][0][1][fila][vinculos[0]] == reppuesta_rep["resutado"][1][1][y][vinculos[1]]   ){

            if(filaY > (40 * 5) ){
              doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);

              doc.addPage(tipo_pag)
              doc.text(10, 10, '{{Id_empresa}}: ' + reppuesta_rep["nombre_rep"] + ', {{idioma_html.fecha}}:' + date.toLocaleDateString() + " " + date.toLocaleTimeString() );
              doc.text(10, 15, dbvariables.substring(0, dbvariables.length-2));
              filaY = 25
              imprimio_cabecera = false 
            }


            if (entro == false) {
              doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);
              filaY = filaY + 2.5
            };

            entro = true
            filaX = reppuesta_rep["repstilo"][1]["tab"] * conv_cc

            if(imprimio_cabeceradet == false && reppuesta_rep["repstilo"][1]["Cabecera"] == 'Si'){

              for (y2 = 0; y2 < columnasdet.length; y2++){
                doc.line(filaX -0.5, filaY - 5, filaX-0.5, filaY + 0.5);
                doc.line(filaX -0.5 , filaY - 5 , filaX  + (columnas_largodet[y2] * conv_cc) -0.5 , filaY- 5);

                doc.text(filaX, filaY, columnasdet[y2]);
                filaX = filaX + (columnas_largodet[y2] * conv_cc)

              }

              doc.line(filaX-0.5, filaY - 5, filaX-0.5, filaY);  
              doc.line(filaX-0.5 , filaY - 5 , filaX  + (columnas_largodet[x2] * conv_cc) -0.5  , filaY- 5);

              imprimio_cabeceradet = true
              filaY = filaY + 5
            }

            filaX = reppuesta_rep["repstilo"][1]["tab"] * conv_cc
            for (y2 = 0; y2 < columnasdet.length; y2++){
              for (y3 = 0; y3 < reppuesta_rep["resutado"][1][0].length; y3++){
                if(reppuesta_rep["resutado"][1][0][y3][0] == columnasdet[y2]){
                  doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY + 0.5);
                  doc.line(filaX-0.5 , filaY - 4.5 , (filaX  + (columnas_largodet[y2] * conv_cc))-0.5  , filaY - 4.5 ,);

                  var escri = reppuesta_rep["resutado"][1][1][y][y3] 
                  if((escri.length *6.5) > columnas_largodet[y2]){escri = escri.substring(0, Math.round(columnas_largodet[y2] / 6.5) )+'...'}
                  if(isNaN(escri) == true){doc.text(filaX , filaY, escri.toString()); 
                  }else{doc.text(filaX + ( (columnas_largodet[y2] * conv_cc)-2) , filaY, escri.toString(), 'right');}
                }
              }
              filaX = filaX + (columnas_largodet[y2] * conv_cc)
              doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY + 0.5);
              //doc.line(filaX , filaY - 5 , (filaX  + (columnas_largo[x2] * conv_cc)) , filaY- 5);
            }
            filaY = filaY + 5
          
            if(reppuesta_rep["repstilo"][1]["cabeceras"] == true){imprimio_cabecera = false}

          }
        }
        if(entro == true){
          doc.line(reppuesta_rep["repstilo"][1]["tab"] * conv_cc -0.5, filaY -4.5, filaX-0.5, filaY-4.5);
          filaY = filaY + 2.5}

      
        if(filaY > (40 * 5) ){
          doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);

          doc.addPage(tipo_pag)
          doc.text(10, 10, '{{Id_empresa}}: ' + reppuesta_rep["nombre_rep"] + ', {{idioma_html.fecha}}:' + date.toLocaleDateString() + " " + date.toLocaleTimeString() );
          doc.text(10, 15, dbvariables.substring(0, dbvariables.length-2));
          filaY = 25
          imprimio_cabecera = false 
        }


    

    doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);

    doc.save(reppuesta_rep["nombre_rep"] + '_' + date.toLocaleDateString() + " " + date.toLocaleTimeString() + '.pdf');

}

function pdf_reporte(temp_pest){
    
    reppuesta_rep = dict_pestalla['p-'+temp_pest] 
    var date = new Date()

    if(reppuesta_rep["resutado"].length==2){
      var detalle = confirm("{{idioma_html.mens_detalle}}");
      var vinculos = []
      for (z = 0; z < reppuesta_rep["resutado"][0][0].length; z++){
        if(reppuesta_rep["resutado"][0][0][z][0] == '$vinculo'){
          vinculos.push(z)
        }
      }

      for (z = 0; z < reppuesta_rep["resutado"][1][0].length; z++){
        if(reppuesta_rep["resutado"][1][0][z][0] == '$vinculo'){
          vinculos.push(z)
        }
      }      
    }else{
      var detalle = false
    }



    var dbvariables = ""

    for (x2 = 0; x2 < Object.keys(reppuesta_rep["repvariables"]).length; x2++){
        dbvariables = dbvariables + reppuesta_rep["label"][Object.keys(reppuesta_rep['repvariables'])[x2]]+ ": " +  reppuesta_rep["repvariables"][Object.keys(reppuesta_rep['repvariables'])[x2]] + ' / '
    }
    for (x2 = 0; x2 < Object.keys(reppuesta_rep["repreferencias"]).length; x2++){
        dbvariables = dbvariables + reppuesta_rep["label"][Object.keys(reppuesta_rep['repreferencias'])[x2]]+ ": " +  reppuesta_rep["repreferencias"][Object.keys(reppuesta_rep['repreferencias'])[x2]] + ' / '
    }
    var tipo_pag = ''

    if (reppuesta_rep["repstilo"][0]["posicion"] == "Horizontal") {
      tipo_pag = 'landscape'
      
    }

    var doc = new jsPDF(tipo_pag);



     doc.setFontSize(10);
     doc.text(10, 10, '{{Id_empresa}}: ' + reppuesta_rep["nombre_rep"] + ', {{idioma_html.fecha}}:' + date.toLocaleDateString() + " " + date.toLocaleTimeString() );
     doc.text(10, 15, dbvariables.substring(0, dbvariables.length-2));

    var conv_cc = 0.375
    var filaX = 10
    var filaY = 25

    columnas = reppuesta_rep["repstilo"][0]["columnas"].split(',')
    columnas_largo = reppuesta_rep["repstilo"][0]["largos"].split(',')

    imprimio_cabecera = false
    for (x = 0; x < reppuesta_rep["resutado"][0][1].length; x++){

      filaX = 10
      if(imprimio_cabecera == false){

        for (x2 = 0; x2 < columnas.length; x2++){
          doc.line(filaX -0.5, filaY - 5, filaX-0.5, filaY +0.5);
          doc.line(filaX -0.5 , filaY - 5 , filaX  + (columnas_largo[x2] * conv_cc) -0.5 , filaY- 5);

          doc.text(filaX, filaY, columnas[x2]);
          filaX = filaX + (columnas_largo[x2] * conv_cc)
        }
        doc.line(filaX-0.5, filaY - 5, filaX-0.5, filaY +0.5);  
        doc.line(filaX-0.5 , filaY - 5 , filaX  + (columnas_largo[x2] * conv_cc) -0.5  , filaY- 5);

        imprimio_cabecera = true
        filaY = filaY + 5
      }

      filaX = 10
      for (x2 = 0; x2 < columnas.length; x2++){
        for (x3 = 0; x3 < reppuesta_rep["resutado"][0][0].length; x3++){
          if(reppuesta_rep["resutado"][0][0][x3][0] == columnas[x2]){
            doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY+0.5);
            doc.line(filaX-0.5 , filaY - 4.5 , (filaX  + (columnas_largo[x2] * conv_cc))-0.5  , filaY - 4.5 ,);

            var escri = reppuesta_rep["resutado"][0][1][x][x3] 
            if((escri.length *6.5) > columnas_largo[x2]){escri = escri.substring(0, Math.round(columnas_largo[x2] / 6.5) )+'...'}
            if(isNaN(escri) == true){doc.text(filaX , filaY, escri); 
            }else{doc.text(filaX + ( (columnas_largo[x2] * conv_cc)-2) , filaY, escri, 'right');}
          }
        }
        filaX = filaX + (columnas_largo[x2] * conv_cc)
        doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY+0.5);
        //doc.line(filaX , filaY - 5 , (filaX  + (columnas_largo[x2] * conv_cc)) , filaY- 5);
      }
      filaY = filaY + 5
      
      
      //valor

      if (detalle == true) {
      
        var imprimio_cabeceradet = false
        columnasdet = reppuesta_rep["repstilo"][1]["columnas"].split(',')
        columnas_largodet = reppuesta_rep["repstilo"][1]["largos"].split(',')
        var entro = false
        for (y = 0; y < reppuesta_rep["resutado"][1][1].length; y++){
          
          if(reppuesta_rep["resutado"][0][1][x][vinculos[0]] == reppuesta_rep["resutado"][1][1][y][vinculos[1]]   ){

            if(filaY > (40 * 5) ){
              doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);

              doc.addPage(tipo_pag)
              doc.text(10, 10, '{{Id_empresa}}: ' + reppuesta_rep["nombre_rep"] + ', {{idioma_html.fecha}}:' + date.toLocaleDateString() + " " + date.toLocaleTimeString() );
              doc.text(10, 15, dbvariables.substring(0, dbvariables.length-2));
              filaY = 25
              imprimio_cabecera = false 
            }


            if (entro == false) {
              doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);
              filaY = filaY + 2.5
            };

            entro = true
            filaX = reppuesta_rep["repstilo"][1]["tab"] * conv_cc

            if(imprimio_cabeceradet == false && reppuesta_rep["repstilo"][1]["Cabecera"] == 'Si'){

              for (y2 = 0; y2 < columnasdet.length; y2++){
                doc.line(filaX -0.5, filaY - 5, filaX-0.5, filaY + 0.5);
                doc.line(filaX -0.5 , filaY - 5 , filaX  + (columnas_largodet[y2] * conv_cc) -0.5 , filaY- 5);

                doc.text(filaX, filaY, columnasdet[y2]);
                filaX = filaX + (columnas_largodet[y2] * conv_cc)

              }

              doc.line(filaX-0.5, filaY - 5, filaX-0.5, filaY);  
              doc.line(filaX-0.5 , filaY - 5 , filaX  + (columnas_largodet[x2] * conv_cc) -0.5  , filaY- 5);

              imprimio_cabeceradet = true
              filaY = filaY + 5
            }

            filaX = reppuesta_rep["repstilo"][1]["tab"] * conv_cc
            for (y2 = 0; y2 < columnasdet.length; y2++){
              for (y3 = 0; y3 < reppuesta_rep["resutado"][1][0].length; y3++){
                if(reppuesta_rep["resutado"][1][0][y3][0] == columnasdet[y2]){
                  doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY + 0.5);
                  doc.line(filaX-0.5 , filaY - 4.5 , (filaX  + (columnas_largodet[y2] * conv_cc))-0.5  , filaY - 4.5 ,);

                  var escri = reppuesta_rep["resutado"][1][1][y][y3] 
                  if((escri.length *6.5) > columnas_largodet[y2]){escri = escri.substring(0, Math.round(columnas_largodet[y2] / 6.5) )+'...'}
                  if(isNaN(escri) == true){doc.text(filaX , filaY, escri.toString()); 
                  }else{doc.text(filaX + ( (columnas_largodet[y2] * conv_cc)-2) , filaY, escri.toString(), 'right');}
                }
              }
              filaX = filaX + (columnas_largodet[y2] * conv_cc)
              doc.line(filaX-0.5, filaY -4.5, filaX-0.5, filaY + 0.5);
              //doc.line(filaX , filaY - 5 , (filaX  + (columnas_largo[x2] * conv_cc)) , filaY- 5);
            }
            filaY = filaY + 5
          
            if(reppuesta_rep["repstilo"][1]["cabeceras"] == true){imprimio_cabecera = false}

          }

          
          
        }
        if(entro == true){
          doc.line(reppuesta_rep["repstilo"][1]["tab"] * conv_cc -0.5, filaY -4.5, filaX-0.5, filaY-4.5);
          filaY = filaY + 2.5}

      }
        if(filaY > (40 * 5) ){
          doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);

          doc.addPage(tipo_pag)
          doc.text(10, 10, '{{Id_empresa}}: ' + reppuesta_rep["nombre_rep"] + ', {{idioma_html.fecha}}:' + date.toLocaleDateString() + " " + date.toLocaleTimeString() );
          doc.text(10, 15, dbvariables.substring(0, dbvariables.length-2));
          filaY = 25
          imprimio_cabecera = false 
        }


    }

    doc.line(10 -0.5, filaY -4.5, filaX-0.5, filaY-4.5);

    doc.save(reppuesta_rep["nombre_rep"] + '_' + date.toLocaleDateString() + " " + date.toLocaleTimeString() + '.pdf');

}

function excell_subreporte(temp_pest){

    reppuesta_rep = dict_pestalla['p-'+temp_pest] 

    var tab_text="<table border='2px'><tr bgcolor='#87AFC6'>";
    var textRange; var j=0;
    tab = document.getElementById('dataTablessub-'+temp_pest); // id of table

    for(j = 0 ; j < tab.rows.length ; j++) 
    {     
        tab_text=tab_text+tab.rows[j].innerHTML+"</tr>";
        //tab_text=tab_text+"</tr>";
    }

    tab_text=tab_text+"</table>";
    tab_text= tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
    tab_text= tab_text.replace(/<img[^>]*>/gi,""); // remove if u want images in your table
    tab_text= tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

    var ua = window.navigator.userAgent;
    var msie = ua.indexOf("MSIE "); 

    if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
    {
        txtArea1.document.open("txt/html","replace");
        txtArea1.document.write(tab_text);
        txtArea1.document.close();
        txtArea1.focus(); 
        sa=txtArea1.document.execCommand("SaveAs",true,"Say Thanks to Sumit.xls");
    }  
    else                 //other browser not tested on IE 11
        sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));  

    return (sa);

}

function excell_reporte(temp_pest){

    reppuesta_rep = dict_pestalla['p-'+temp_pest] 

    var tab_text="<table border='2px'><tr bgcolor='#87AFC6'>";
    var textRange; var j=0;
    tab = document.getElementById('dataTables-'+temp_pest); // id of table

    for(j = 0 ; j < tab.rows.length ; j++) 
    {     
        tab_text=tab_text+tab.rows[j].innerHTML+"</tr>";
        //tab_text=tab_text+"</tr>";
    }

    tab_text=tab_text+"</table>";
    tab_text= tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
    tab_text= tab_text.replace(/<img[^>]*>/gi,""); // remove if u want images in your table
    tab_text= tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

    var ua = window.navigator.userAgent;
    var msie = ua.indexOf("MSIE "); 

    if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
    {
        txtArea1.document.open("txt/html","replace");
        txtArea1.document.write(tab_text);
        txtArea1.document.close();
        txtArea1.focus(); 
        sa=txtArea1.document.execCommand("SaveAs",true,"Say Thanks to Sumit.xls");
    }  
    else                 //other browser not tested on IE 11
        sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));  

    return (sa);

}

function abrir_subrep(temp_pest, fila, nivel){
    tr = document.getElementById('dr-' + temp_pest +'-'+ fila +'-'+ nivel)
    btn = document.getElementById('btn-' + temp_pest +'-'+ fila +'-'+ nivel)
    if (tr.hidden == false){
        tr.hidden = true
        btn.innerHTML = '<span class="fa fa-plus" aria-hidden="true"></span>'
        btn.style.backgroundColor = "darkblue"

    }else{
        tr.hidden = false
        btn.innerHTML = '<span class="fa fa-minus" aria-hidden="true"></span>'
        btn.style.backgroundColor = "cornflowerblue"

    }

}
function reejecutar_reprote(id_rep) {

        //  $("#id"+ $(this).attr("id")).remove();
        //  $("#rr"+ $(this).attr("id")).empty();
          pestalla = pestalla +1;


          
          $.ajax({
            type: 'POST',
            url: '/menu_reporte',
            data: {'fuente': 'reporte', 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','pkrepo': id_rep, 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'pestalla':pestalla},
            //beforeSend: function () {},
            success: function(Response){
              $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '"style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">'+ Response["nombre_rep"] + ' <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a></li>');
        




              $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> Procesando </div>');

              id_dic = 'p-' + pestalla
              dict_pestalla[id_dic] = Response


              data_int = '<div class="panel-body" style="padding-top: 15px;">'
              data_int = data_int + '<button class="btn btn-primary" id="reporteejecutar" name="reporteejecutar" type="submit" value="' + Response['pkrepo'][0] + '" onclick="reporte_ejecutar('+ Response["pestalla"] +',0, '+ Response["pkrepo"] +')">{{idioma_html.ejecutar}}</button>' 
              data_int = data_int + '<button type="button" onclick="cerrar_elemento('+ Response["pestalla"] +')" class="btn btn-warning"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button>'
              data_int = data_int + '<div class="card-block text-left"><table class="table table-hover"><thead><tr><th></th><th></th><th></th></tr></thead><tbody>'

              for (x = 0; x < Response['variables_reprotes'].length; x++) {
                data_int = data_int + '<br>'

                if(Response['variables_reprotes'][x]["tipo"] == "Texto"){
                    data_int = data_int + '<tr><td><strong>'+Response['variables_reprotes'][x]["glosa"] +':</td>'
                    data_int = data_int + '<td> <input type="text" id="var-'+ Response["pestalla"] +'-'+ Response['variables_reprotes'][x]["id"] +'" name="'+ Response['variables_reprotes'][x]["id_rep"] +'" value="%"></td>'
                    data_int = data_int + '<td></td></tr>'
                }else
                {
                  if(Response['variables_reprotes'][x]["tipo"] == "Valor"){
                      data_int = data_int + '<tr><td><strong>'+Response['variables_reprotes'][x]["glosa"] +':</td>'
                      data_int = data_int + '<td> <input type="text" id="var-'+ Response["pestalla"] +'-'+ Response['variables_reprotes'][x]["id"] +'" name="'+ Response['variables_reprotes'][x]["id_rep"] +'" value="0"></td>'
                      data_int = data_int + '<td></td></tr>'
                  }else{
                    data_int = data_int + '<tr><td><strong>'+Response['variables_reprotes'][x]["glosa"] +':</td>'
                    data_int = data_int + '<td> <input type="date" id="var-'+ Response["pestalla"] +'-'+ Response['variables_reprotes'][x]["id"] +'" name="'+ Response['variables_reprotes'][x]["id_rep"] +'" value="'+ Response['variables_reprotes'][x]["valor"] +'"></td>'
                    data_int = data_int + '<td></td></tr>'
                  }
                }
              }
              for (x = 0; x < Response['referencias_reprotes'].length; x++) {
                data_int = data_int + '<tr><td><strong>'+Response['referencias_reprotes'][x]["glosa"] +':</td>'
                data_int = data_int + '<td> <input type="text" id="rpzz'+ Response["pestalla"] +'zz'+ x +'zz'+Response['referencias_reprotes'][x]["id"] +'" name="'+Response['referencias_reprotes'][x]["id"] +'" value="%"></td>'
                data_int = data_int + '<td><button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_reporte(rpzz'+ Response["pestalla"] +'zz'+ x +'zz'+Response['referencias_reprotes'][x]["id"]+')"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button></td></tr>'
              }
              data_int = data_int + '</tbody></table></div>  '
              $('#rr' + Response["pestalla"]).html(data_int);
              }
          });
}

function calcular_0_nuevo(pestana_int) {


    Response = dict_pestalla['p-'+pestana_int]
  
    for (x = 0; x < Response["campos_cab"].length; x++) { 
        ID_TAG = 'p' + pestana_int + 'zzz' + Response["campos_cab"][x]["Nombre"] + ''; 

        if (Response["campos_cab"][x]["TablaCampo"] == "cmptxtsimple"){
          document.getElementById(ID_TAG).value = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorPredeterminado"]
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsimple"){
          document.getElementById(ID_TAG).value = setTwoNumberDecimal(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"], Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["NumDecimales"])
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpformuladetalle"){
          document.getElementById(ID_TAG).value =   setTwoNumberDecimal(0, 2) 
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){
          var now = new Date();
          if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == "Y"){
            valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
          }else{
            valor_campo = now.format("Y-m-d");
          }
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferencia"){
          valor_campo = 0
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
          valor_campo = 0
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpoperacion"){
          valor_campo = 0
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpconsolidado"){
          valor_campo = 0
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmparchivo"){
          valor_campo = ""
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumeroaletras"){
          valor_campo = ""
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpdecabecera"){
          valor_campo = ""
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpelectronico"){
          valor_campo = 0
        }

    }
}

function calcular_detalle_nuevo(pestana_int, fila) {
    Response = dict_pestalla['p-'+pestana_int]
  
    for (x = 0; x < Response["campos_det"].length; x++) { 
        ID_TAG = 'pd' + pestana_int + 'fff' + fila + 'ccc' + Response["campos_det"][x]["Nombre"] + ''; 

        if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
          document.getElementById(ID_TAG).value = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorPredeterminado"]
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){
          document.getElementById(ID_TAG).value = setTwoNumberDecimal(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"], Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"])
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){
          document.getElementById(ID_TAG).value =   setTwoNumberDecimal(0, 2) 
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
          var now = new Date();
          if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tiempo"] == "Y"){
            valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
          }else{
            valor_campo = now.format("Y-m-d");
          }
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
          valor_campo = 0
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
          valor_campo = 0
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){
          valor_campo = 0
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
          valor_campo = 0
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmparchivo"){
          valor_campo = ""
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpnumeroaletras"){
          valor_campo = ""
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){
          valor_campo = ""
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpelectronico"){
          valor_campo = 0
        }

    }
}

function selecctt_buscador2click(x) {  
  document.getElementById("vfinal_bus").value = x.rowIndex
  document.getElementById("vfinal_bus_2").value = document.getElementById("dataTables-example").rows[x.rowIndex].cells[0].innerHTML.trim();
}

function selecctt_buscador(x) {  
  document.getElementById("vfinal_bus").value = x.rowIndex
  document.getElementById("vfinal_bus_2").value = document.getElementById("dataTables-example").rows[x.rowIndex].cells[0].innerHTML.trim();
}

function calcular_0(pestana_int) {


    Response = dict_pestalla['p-'+pestana_int]
  
    for (x = 0; x < Response["campos_cab"].length; x++) {   
        ID_TAG = 'p' + pestana_int + 'zzz' + Response["campos_cab"][x]["Nombre"] + ''; 
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsimple"){
          if (document.getElementById(ID_TAG).value <=  Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"]){
            document.getElementById(ID_TAG).value = setTwoNumberDecimal(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"], Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["NumDecimales"])
          }else{
            if (document.getElementById(ID_TAG).value >=  Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Mayor"]){
              document.getElementById(ID_TAG).value = setTwoNumberDecimal(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Mayor"], Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["NumDecimales"])
            }else{
            document.getElementById(ID_TAG).value = setTwoNumberDecimal(document.getElementById(ID_TAG).value, Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["NumDecimales"])
            }
            
          }
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpformuladetalle"){
          valor_final = 0;
          cc_final = 0;

          for (x2 = 0; x2 < (cc_porPesta['p-' + pestana_int] + 1 ); x2++) { 

            Campo_a_oper = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Campo"]
            Campo = Campo_a_oper.split(".")
            ID_TAG_campo = 'pd' + pestana_int + 'fff' + x2 +'ccc'+ Campo[1]

            if (document.getElementById(ID_TAG_campo) != null){

              Valor = parseFloat(document.getElementById(ID_TAG_campo).value)

              excluido = 0;

              for (x3 = 0; x3 < Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1].length; x3++) { 
                valor_comparar = 0;
                ID_TAG_campoA = 'pd' + pestana_int + 'fff' + x2 +'ccc'+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Campo"]
                if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Tipo"] == "Valor")
                  {
                    valor_comparar = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Valor"]
                  }else{
                    ID_TAG_compa = 'pd' + pestana_int + 'fff' + x2 + 'ccc' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Valor"]
                    valor_comparar = document.getElementById(ID_TAG_compa).value
                  }
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Operador"] == "=")
                {if(document.getElementById(ID_TAG_campoA).value != valor_comparar){excluido = 1}}
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Operador"] == "<")
                {if(document.getElementById(ID_TAG_campoA).value >= valor_comparar){excluido = 1}}
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Operador"] == ">")
                {if(document.getElementById(ID_TAG_campoA).value <= valor_comparar){excluido = 1}}
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Operador"] == "<=")
                {if(document.getElementById(ID_TAG_campoA).value > valor_comparar){excluido = 1}}
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Operador"] == ">=")
                {if(document.getElementById(ID_TAG_campoA).value < valor_comparar){excluido = 1}}
              }    
            
              if(excluido == 0){
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Suma"){
                  valor_final =  parseFloat(valor_final) + parseFloat(Valor)
                }
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Promedio"){
                  valor_final =  parseFloat(valor_final) + parseFloat(Valor)
                  cc_final =  cc_final + 1
                }
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Maximo"){
                  if(parseFloat(valor_final) < parseFloat(Valor)){valor_final = Valor}
                }
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Minimo"){
                  if(parseFloat(valor_final) > parseFloat(Valor)){valor_final = Valor}
                }
                if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Contar"){
                  cc_final =  cc_final + 1
                }
              }
            }      
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Suma"){
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Promedio"){
            valor_final =  valor_final / (cc_final + 1)
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Maximo"){
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Minimo"){
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Operacion"] == "Contar"){
            document.getElementById(ID_TAG).value =   cc_final
          }           
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpsistema"){

          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == "Fecha Actual"){
            temp_sentencia = 'select now() as "tiempo"'
            id_tag_ajax = ID_TAG
             $.ajax({
                type: 'POST',
                url: '/consolidado',
                data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': temp_sentencia, 'tag1': id_tag_ajax, 'tag2': 0, 'usuario':'{{usuario}}'},
                success: function(Response){
                  if (Response["cmpvalor"].length == 0){
                    document.getElementById(Response["tag1"]).value = 0
                  }else{
                    document.getElementById(Response["tag1"]).value =  Response["cmpvalor"][0]['tiempo']
                  }
                }
              });
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == "Usuario Actual"){
            document.getElementById(ID_TAG).value = '{{usuario}}'
          }
          if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == "Hora Actual"){
            temp_sentencia = 'select now() as "tiempo"'
            $.ajax({
              type: 'POST',
              url: '/consolidado',
              data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': temp_sentencia, 'tag1': ID_TAG, 'tag2': ID_TAG, 'usuario':'{{usuario}}'},
              success: function(Response){
                if (Response["cmpvalor"].length == 0){
                  document.getElementById(Response["tag1"]).value = 0
                }else{
                    if (Response["cmpvalor"][0][Response["tag2"]] == null){
                        document.getElementById(Response["tag1"]).value = 0
                    }else{
                        document.getElementById(Response["tag1"]).value =  Response["cmpvalor"][0]['tiempo']
                    }
                  
                }
              }
            });
          }
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferencia"){
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpoperacion"){
          temp  = 0.0;
          operador = "=";
          Valor = 0.0;

          for (x3 = 0; x3 < Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1].length; x3++) { 
            if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Estado"] == "C"){

              ID_TAG_campo = 'p' + pestana_int + 'zzz' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Sentencia"] + ''; 
              if(document.getElementById(ID_TAG_campo).value == ""){
                Valor = 0.0
              }else{
                Valor = document.getElementById(ID_TAG_campo).value
              }

              if(operador == "="){temp = parseFloat(Valor)}
              if(operador == "+"){temp = parseFloat(temp) + parseFloat(Valor)}
              if(operador == "-"){temp = parseFloat(temp) - parseFloat(Valor)}
              if(operador == "*"){temp = parseFloat(temp) * parseFloat(Valor)}
              if(operador == "/"){
                if(Valor > 0){temp = parseFloat(temp) / parseFloat(Valor)}
                }
            }
            if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Estado"] == "O"){
              operador = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Sentencia"]
            }
            if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Estado"] == "V"){
              Valor = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Sentencia"]
              if(operador == "="){temp = parseFloat(Valor)}
              if(operador == "+"){temp = parseFloat(temp) + parseFloat(Valor)}
              if(operador == "-"){temp = parseFloat(temp) - parseFloat(Valor)}
              if(operador == "*"){temp = parseFloat(temp) * parseFloat(Valor)}
              if(operador == "/"){
                if(Valor > 0){temp = parseFloat(temp) / parseFloat(Valor)}
                }
            }
          }
          temp = setTwoNumberDecimal(temp, Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Decimales"])
          document.getElementById(ID_TAG).value = temp
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpconsolidado"){

          A_Select = 'Select ( '
          A_From = 'From '
          A_Where = 'Where '
          A_Group = 'Group by '
          A_GroupWhere = 'Group by '
          sentencia = ""
          FaltaDato = false



          for (x3 = 0; x3 < Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1].length; x3++) { 
              A_From = A_From + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Tabla"] + ' as ' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][1][x3]["Nombre"] + ', '
          }
          if(A_From == "From "){ A_From = ""}else{        A_From =   A_From.slice(0,-2)}

          for (x3 = 0; x3 < Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2].length; x3++) { 

            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Tipo"] == "Valor"){
              A_Where = A_Where + " '" + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + "' "            
            }
            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Tipo"] == "Operacion"){
             A_Where = A_Where + " " + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + " "             
            }
            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Tipo"] == "Registro"){
              ID_TAG_reg = 'p' + pestana_int + 'zzz' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"]; 

              if(document.getElementById(ID_TAG_reg).value == ""){
                FaltaDato = true       
                A_Where = A_Where + " '' "
              }else{
                A_Where = A_Where + " '" + document.getElementById(ID_TAG_reg).value + "' "
              }
                    
            }
            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Tipo"] == "Campo"){

              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Funcion"] == ""){

                A_Where = A_Where + " " + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + " " 
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Funcion"] == " "){
                A_Where = A_Where + " " + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + " "               }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Funcion"] == "Suma"){
                 A_Where = A_Where + " " + 'Sum(' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + ') '
                  A_GroupWhere = A_GroupWhere + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + ', '
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Funcion"] == "Promedio"){
                A_Where = A_Where + ' Avg(' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + ') '
                A_GroupWhere = A_GroupWhere + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + ', '
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Funcion"] == "Contar"){
                A_Where = A_Where + ' Count(' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + ') ' 
                A_GroupWhere = A_GroupWhere + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][2][x3]["Elemento"] + ', '            
              }
            }

            
          }
          if(A_Where == 'Where '){A_Where = ''}
          if(A_GroupWhere == "Group by "){ A_GroupWhere = ""}else{A_GroupWhere =   A_GroupWhere.slice(0,-2)}
      

          for (x3 = 0; x3 < Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3].length; x3++) { 


            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Tipo"] == "Valor"){
               A_Select = A_Select + " '" + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + "' "
            }
            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Tipo"] == "Operacion"){
               A_Select = A_Select + " " + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + " "   
            }
            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Tipo"] == "Registro"){
              ID_TAG_reg = 'p' + pestana_int + 'zzz' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"]; 

              if(document.getElementById(ID_TAG_reg).value == ""){
                FaltaDato = true       
                A_Select = A_Select + " '' "     
              }else{
                A_Select = A_Select + " '" + document.getElementById(ID_TAG_reg).value + "' "
              }
            }
            if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Tipo"] == "Campo"){

              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Funcion"] == ""){

                A_Select = A_Select + " " + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + " "
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Funcion"] == " "){
                A_Select = A_Select + " " + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + " "
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Funcion"] == "Suma"){
                 A_Select = A_Select + ' Sum(' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + ') '
                  A_Group = A_Group + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + ', '
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Funcion"] == "Promedio"){
                A_Select = A_Select + ' Avg(' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + ') '
                A_Group = A_Group + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + ', '
              }
              if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Funcion"] == "Contar"){
                A_Select = A_Select + ' Count(' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + ') ' 
                A_Group = A_Group + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][3][x3]["Elemento"] + ', '            
              }
            }
          }
          if(A_Group == "Group by "){ A_Group = ""}else{A_Group = A_Group.slice(0,-2)}

          A_Select = A_Select + " ) as '" + Response["campos_cab"][x]["Nombre"] + "'"
          if(A_Group == ""){
            if(A_GroupWhere == ""){
              sentencia = A_Select + " " + A_From + " " + A_Where 
            }else{
              sentencia = A_Select + " " + A_From + " " + A_Where + " " +  A_GroupWhere
            }
          }else{
            if(A_GroupWhere == ""){
              sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_Group
            }else{
              sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_Group + ", " + A_GroupWhere.replace("Group by ","")
            }
          }

          if(FaltaDato == true && Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["Permite_nulo"] == "No"){
           document.getElementById(ID_TAG).value =  0

          }else{
            ID_TAG_resp = 'p' + pestana_int + 'zzz' + Response["campos_cab"][x]["Nombre"] + '';
            ID_TAG_nombre = Response["campos_cab"][x]["Nombre"]
              $.ajax({
                type: 'POST',
                url: '/consolidado',
                data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': sentencia,'tag1': ID_TAG_resp, 'tag2': ID_TAG_nombre, 'usuario':'{{usuario}}'},
                success: function(Response){
                  if (Response["cmpvalor"].length == 0){
                    document.getElementById(Response["tag1"]).value = 0
                  }else{
                    if (Response["cmpvalor"][0][Response["tag2"]] == null){
                        document.getElementById(Response["tag1"]).value =  0                    
                    }else{
                        document.getElementById(Response["tag1"]).value =  Response["cmpvalor"][0][Response["tag2"]]                    
                    }
                   
                  }
                }
              });
          }
        }
        if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumeroaletras"){
          ID_TAG_campo = 'p' + pestana_int + 'zzz' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["CampoNumero"] + ''; 
           
         document.getElementById(ID_TAG).value =  numeroALetras(document.getElementById(ID_TAG_campo).value);

        }
    }
}

function calcular_detalle(pestana_int, fila) {


    Response = dict_pestalla['p-'+pestana_int]
  
    for (x = 0; x < Response["campos_det"].length; x++) {   
        ID_TAG = 'pd' + pestana_int + 'fff' + fila + 'ccc' + Response["campos_det"][x]["Nombre"] + ''; 

        if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){
          if (document.getElementById(ID_TAG).value <=  Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"]){
            document.getElementById(ID_TAG).value = setTwoNumberDecimal(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"], Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"])
          }else{
            if (document.getElementById(ID_TAG).value >=  Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Mayor"]){
              document.getElementById(ID_TAG).value = setTwoNumberDecimal(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Mayor"], Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"])
            }else{
              document.getElementById(ID_TAG).value = setTwoNumberDecimal(document.getElementById(ID_TAG).value, Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"])
            }


            
          }
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){
          valor_final = 0;
          cc_final = 0;

          for (x2 = 0; x2 < (cc_porPesta['p-' + pestana_int] + 1 ); x2++) { 

            excluido = 0;

            for (x3 = 0; x3 < Response["func_det"][Response["campos_det"][x]["Nombre"]][1].length; x3++) { 
            valor_comparar = 0;

            ID_TAG_campo = 'pd' + pestana_int + 'fff' + x2 +'ccc'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Campo"]
              if (Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Tipo"] == "Valor")
                {
                  valor_comparar = Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Valor"]
                }else{
                  ID_TAG_compa = 'pd' + pestana_int + 'fff' + x2 + 'ccc' + Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Valor"]
                  valor_comparar = document.getElementById(ID_TAG_compa).value
                }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Operador"] == "=")
              {if(document.getElementById(ID_TAG_campo).value != valor_comparar){excluido = 1}}
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Operador"] == "<")
              {if(document.getElementById(ID_TAG_campo).value >= valor_comparar){excluido = 1}}
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Operador"] == ">")
              {if(document.getElementById(ID_TAG_campo).value <= valor_comparar){excluido = 1}}
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Operador"] == "<=")
              {if(document.getElementById(ID_TAG_campo).value > valor_comparar){excluido = 1}}
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Operador"] == ">=")
              {if(document.getElementById(ID_TAG_campo).value < valor_comparar){excluido = 1}}
            }    
          
            if(excluido == 0){

              Campo_a_oper = Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Campo"]
              Campo = Campo_a_oper.split(".")
              ID_TAG_campo = 'pd' + pestana_int + 'fff' + x2 +'ccc'+ Campo[1]
              Valor = parseFloat(document.getElementById(ID_TAG_campo).value)


              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Suma"){
                valor_final =  parseFloat(valor_final) + parseFloat(Valor)
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Promedio"){
                valor_final =  parseFloat(valor_final) + parseFloat(Valor)
                cc_final =  cc_final + 1
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Maximo"){
                if(parseFloat(valor_final) < parseFloat(Valor)){valor_final = Valor}
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Minimo"){
                if(parseFloat(valor_final) > parseFloat(Valor)){valor_final = Valor}
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Contar"){
                cc_final =  cc_final + 1
              }
            }

          }      
          
          if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Suma"){
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Promedio"){
            valor_final =  valor_final / (cc_final + 1)
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Maximo"){
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Minimo"){
            document.getElementById(ID_TAG).value =   setTwoNumberDecimal(valor_final, 2)
          }
          if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Operacion"] == "Contar"){
            document.getElementById(ID_TAG).value =   cc_final

          }           
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){
          temp  = 0.0;
          operador = "=";
          Valor = 0.0;

          for (x3 = 0; x3 < Response["func_det"][Response["campos_det"][x]["Nombre"]][1].length; x3++) { 
            if (Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Estado"] == "C"){

              ID_TAG_campo = 'pd' + pestana_int + 'fff' + fila + 'ccc'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Sentencia"] + ''; 
              if(document.getElementById(ID_TAG_campo).value == ""){
                Valor = 0.0
              }else{
                Valor = document.getElementById(ID_TAG_campo).value
              }

              if(operador == "="){temp = parseFloat(Valor)}
              if(operador == "+"){temp = parseFloat(temp) + parseFloat(Valor)}
              if(operador == "-"){temp = parseFloat(temp) - parseFloat(Valor)}
              if(operador == "*"){temp = parseFloat(temp) * parseFloat(Valor)}
              if(operador == "/"){
                if(Valor > 0){temp = parseFloat(temp) / parseFloat(Valor)}
                }
            }
            if (Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Estado"] == "O"){
              operador = Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Sentencia"]
            }
            if (Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Estado"] == "V"){
              Valor = Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Sentencia"]
              if(operador == "="){temp = parseFloat(Valor)}
              if(operador == "+"){temp = parseFloat(temp) + parseFloat(Valor)}
              if(operador == "-"){temp = parseFloat(temp) - parseFloat(Valor)}
              if(operador == "*"){temp = parseFloat(temp) * parseFloat(Valor)}
              if(operador == "/"){
                if(Valor > 0){temp = parseFloat(temp) / parseFloat(Valor)}
                }
            }
          }
          temp = setTwoNumberDecimal(temp, Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Decimales"])
          document.getElementById(ID_TAG).value = temp
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){

          A_Select = 'Select ( '
          A_From = 'From '
          A_Where = 'Where '
          A_Group = 'Group by '
          A_GroupWhere = 'Group by '
          sentencia = ""
          FaltaDato = false



          for (x3 = 0; x3 < Response["func_det"][Response["campos_det"][x]["Nombre"]][1].length; x3++) { 
              A_From = A_From + Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Tabla"] + ' as ' + Response["func_det"][Response["campos_det"][x]["Nombre"]][1][x3]["Nombre"] + ', '
          }
          if(A_From == "From "){ A_From = ""}else{        A_From =   A_From.slice(0,-2)}

          for (x3 = 0; x3 < Response["func_det"][Response["campos_det"][x]["Nombre"]][2].length; x3++) { 

            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Tipo"] == "Valor"){
              A_Where = A_Where + " '" + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + "' "            
            }
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Tipo"] == "Operacion"){
             A_Where = A_Where + ' ' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"]+ ' '             
            }
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Tipo"] == "Registro"){
              ID_TAG_reg = 'pd' + pestana_int + 'fff' + fila + 'ccc'+  Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"]; 

              if(document.getElementById(ID_TAG_reg).value == ""){
                FaltaDato = true            
                A_Where = A_Where + " '' "
              }else{
                A_Where = A_Where + " '" + document.getElementById(ID_TAG_reg).value + "' "
              }
                    
            }
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Tipo"] == "Campo"){

              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Funcion"] == ""){

                A_Where = A_Where + ' ' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ' ' 
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Funcion"] == " "){
                A_Where = A_Where + ' ' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ' ' 
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Funcion"] == "Suma"){
                 A_Where = A_Where + ' Sum(' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ') '
                  A_GroupWhere = A_GroupWhere + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ', '
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Funcion"] == "Promedio"){
                A_Where = A_Where + ' Avg(' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ') '
                A_GroupWhere = A_GroupWhere + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ', '
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Funcion"] == "Contar"){
                A_Where = A_Where + ' Count(' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ') ' 
                A_GroupWhere = A_GroupWhere + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][2][x3]["Elemento"] + ', '            
              }
            }

            
          }
          if(A_GroupWhere == "Group by "){ A_GroupWhere = ""}else{A_GroupWhere =   A_GroupWhere.slice(0,-2)}
          if(A_Where == "Where "){ A_Where = ""}

          for (x3 = 0; x3 < Response["func_det"][Response["campos_det"][x]["Nombre"]][3].length; x3++) { 


            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Tipo"] == "Valor"){
               A_Select = A_Select + " '" + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + "' "
            }
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Tipo"] == "Operacion"){
               A_Select = A_Select + " " + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"]+ " "   
            }
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Tipo"] == "Registro"){
              ID_TAG_reg = 'pd' + pestana_int + 'fff' + fila + 'ccc'+  Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"]; 

              if(document.getElementById(ID_TAG_reg).value == ""){
                FaltaDato = true            
                A_Select = A_Select + " '' "

              }else{
                A_Select = A_Select + " '" + document.getElementById(ID_TAG_reg).value + "' "
              }
            }
            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Tipo"] == "Campo"){

              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Funcion"] == ""){

                A_Select = A_Select + " " + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + " "
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Funcion"] == " "){
                A_Select = A_Select + " " + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + " "
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Funcion"] == "Suma"){
                 A_Select = A_Select + ' Sum(' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + ') '
                  A_Group = A_Group + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + ', '
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Funcion"] == "Promedio"){
                A_Select = A_Select + ' Avg(' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + ') '
                A_Group = A_Group + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + ', '
              }
              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Funcion"] == "Contar"){
                A_Select = A_Select + ' Count(' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + ') ' 
                A_Group = A_Group + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Origen"] + '.' + Response["func_det"][Response["campos_det"][x]["Nombre"]][3][x3]["Elemento"] + ', '            
              }
            }
          }
          if(A_Group == "Group by "){ A_Group = ""}else{A_Group = A_Group.slice(0,-2)}

          A_Select = A_Select + " ) as '" + Response["campos_det"][x]["Nombre"] + "' "
          if(A_Group == ""){
            if(A_GroupWhere == ""){
              sentencia = A_Select + " " + A_From + " " + A_Where 
            }else{
              sentencia = A_Select + " " + A_From + " " + A_Where + " " +  A_GroupWhere
            }
          }else{
            if(A_GroupWhere == ""){
              sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_Group
            }else{
              sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_Group + ", " + A_GroupWhere.replace("Group by ","")
            }
          }

          if(FaltaDato == true && Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Permite_nulo"] == "No"){document.getElementById(ID_TAG).value =  0
          }else{
            ID_TAG_resp = 'pd' + pestana_int + 'fff' + fila + 'ccc'+  Response["campos_det"][x]["Nombre"] + '';
            ID_TAG_nombre = Response["campos_det"][x]["Nombre"]
              $.ajax({
                type: 'POST',
                url: '/consolidado',
                data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': sentencia, 'tag1': ID_TAG_resp, 'tag2': ID_TAG_nombre, 'usuario':'{{usuario}}'},
                success: function(Response){
                if(Response["cmpvalor"].length > 0){
                    if(Response["cmpvalor"][0][Response["tag2"]] == null){
                        document.getElementById(Response["tag1"]).value =  0
                    }else{
                        document.getElementById(Response["tag1"]).value =  Response["cmpvalor"][0][Response["tag2"]]
                    }
                }else{
                    document.getElementById(Response["tag1"]).value =  0

                }
                }
            });
          }
        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpnumeroaletras"){
         document.getElementById(ID_TAG).value =  numeroALetras(document.getElementById(ID_TAG).value);

        }
        if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){
          id_cab = 'p' + pestana_int + 'zzz' + Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Campo"]
          document.getElementById(ID_TAG).value = document.getElementById(id_cab).value

        }
    }
    calcular_0(pestana_int)
}

function guardar_calcular(campo, tipo) {

  var cc_id = campo.id
  var res = cc_id.split("zzz");
  var cc_pesta = res[0].substring(1);
  var cc_nombre  = res[1]


  if(tipo==0){calcular_0(cc_pesta)}
}

function guardar_calcular_det(campo) {


  var cc_id = campo.id
  var res = cc_id.split("fff");
  var res2 = res[1].split("ccc");

  var cc_pesta = res[0].substring(2);
  var cc_fila = res2[0]
  var cc_nombre  = res2[1]
    
  calcular_detalle(cc_pesta, cc_fila)
}

function poner_valor_buscar_referencia_detalle(campo){
  var cc_id = campo.id
  var res = cc_id.split("fff");
  var res2 = res[1].split("ccc");

  var cc_pesta = res[0].substring(2);
  var cc_fila = res2[0]
  var cc_nombre  = res2[1]

  document.getElementById(campo.id).value = document.getElementById("vfinal_bus_2").value

  anexos = []

  Response = dict_pestalla['p-'+cc_pesta]

  for (x = 0; x <   Response["campos_det"].length; x++) {  
    if(Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
      if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["CampoReferencia"] == cc_nombre){
        ID_TAG = 'pd' + cc_pesta + 'fff' + cc_fila + 'ccc' + Response["campos_det"][x]["Nombre"]

        if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == "Imagen"){


            ajuste_fila ='<img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto;display: block;" id="'+ID_TAG+'_img" src="/media/archivos/{{Id_empresa}}/'+buscador_resultado[(document.getElementById("vfinal_bus").value-1)][Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Sentencia"]]+'" alt="image" value="0">' + buscador_resultado[(document.getElementById("vfinal_bus").value-1)][Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Sentencia"]] 

          document.getElementById(ID_TAG + "_label").innerHTML = ajuste_fila



          document.getElementById(ID_TAG + "_label").href = '/media/archivos/{{Id_empresa}}/'+ buscador_resultado[(document.getElementById("vfinal_bus").value-1)][Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Sentencia"]]
        
          document.getElementById(ID_TAG + "_img").src = '/media/archivos/{{Id_empresa}}/'+ buscador_resultado[(document.getElementById("vfinal_bus").value-1)][Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Sentencia"]] 

        }else{
          document.getElementById(ID_TAG).value = buscador_resultado[(document.getElementById("vfinal_bus").value-1)][Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Sentencia"]]
        }

            for (z2 = 0; z2 < Response["campos_det"].length; z2++) { 
              if(Response["campos_det"][z2]["TablaCampo"] == "cmpreferencia"){
                if(Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["predeterminado_valor"] == Response["campos_det"][x]["Nombre"]){
                  document.getElementById('pd' + pestalla +  'fff'+ cc_fila + 'ccc'+ Response["campos_det"][z2]["Nombre"]).value = document.getElementById(ID_TAG).value
                  anexos.push('pd' + pestalla +  'fff'+ cc_fila + 'ccc'+ Response["campos_det"][z2]["Nombre"])
                }
              }
            }



      }
    }
  } 

  for (zt = 0; zt < anexos.length; zt++) {  
     buscar_referencia_detalle_enter(document.getElementById(anexos[zt]))
  }

  calcular_detalle(cc_pesta, cc_fila)
}

function poner_valor_buscar_referencia_cabecera(campo){
  var cc_id = campo.id
  var res = cc_id.split("zzz");
  var cc_pesta = res[0].substring(1);
  var cc_nombre  = res[1]
  document.getElementById(campo.id).value = document.getElementById("vfinal_bus_2").value

  Response = dict_pestalla['p-'+cc_pesta]
  anexos = []
  for (x = 0; x < Response["campos_cab"].length; x++) {  
    if(Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
      if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["CampoReferencia"] == cc_nombre){
        ID_TAG = 'p' + cc_pesta + 'zzz' + Response["campos_cab"][x]["Nombre"]
        document.getElementById(ID_TAG).value = buscador_resultado[(document.getElementById("vfinal_bus").value-1)][Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Sentencia"]]


        for (z2 = 0; z2 < Response["campos_cab"].length; z2++) { 
          if(Response["campos_cab"][z2]["TablaCampo"] == "cmpreferencia" ){
            if(Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["predeterminado_valor"] ==  Response["campos_cab"][x]["Nombre"]){
              document.getElementById('p' + cc_pesta + 'zzz' + Response["campos_cab"][z2]["Nombre"]).value = document.getElementById(ID_TAG).value
              anexos.push('p' + cc_pesta + 'zzz' + Response["campos_cab"][z2]["Nombre"])
            }
          }
        }


      }
    }
  } 

  if(Response["func_cab"][cc_nombre][2].length > 0){
    if(Response["func_cab"][cc_nombre][2][0]["Adicionar_registros"] == "Si"){
      A_Select = "Select "
      A_From = "From "
      A_Where = "Where "
      A_Group = "Group by "
      A_GroupWhere = "Group by "
      sentencia = ""
      A_extra = ""
      FaltaDato = false

      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][0].length; x++) {
        A_extra = " " + Response["func_cab"][cc_nombre][3][0][0][x]["Elemento"] + " "
      }
      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][1].length; x++) {
        A_From = A_From + " " + Response["func_cab"][cc_nombre][3][0][1][x]["Tabla"] + " as " + Response["func_cab"][cc_nombre][3][0][1][x]["Nombre"] + ", "      
      }
      if(A_From == "From "){A_From = ""}else{A_From = A_From.slice(0,-2)}
      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][2].length; x++) {
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Valor"){
          A_Where = A_Where + " '" + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + "' "
        }
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Operacion"){
          A_Where = A_Where + " " + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + " "
        }
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Registro"){
          ID_TAG_where = 'p' + cc_pesta + 'zzz' + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"]
          if(document.getElementById(ID_TAG_where).value == ""){FaltaDato = true}
          A_Where = A_Where + " '" + document.getElementById(ID_TAG_where).value + "' "
        }
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Campo"){
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="" ){
            A_Where = A_Where + " " + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + " "
          }
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="Suma" ){
            A_Where = A_Where + " Sum(" + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + ") "
            A_GroupWhere = A_GroupWhere + Response["func_cab"][cc_nombre][3][0][2][x]["Grupo"] + ", "
          }
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="Promedio" ){
            A_Where = A_Where + "Avg(" + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + ") "
            A_GroupWhere = A_GroupWhere + Response["func_cab"][cc_nombre][3][0][2][x]["Grupo"] + ", "
          }
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="Contar" ){
            A_Where = A_Where + "Count(" + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + ") "
            A_GroupWhere = A_GroupWhere + Response["func_cab"][cc_nombre][3][0][2][x]["Grupo"] + ", "
          }
        }
      }
      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][3].length; x++) {

        A_Select = A_Select + "CAST( "
        for (x2 = 0; x2 < Response["func_cab"][cc_nombre][3][0][4][x].length; x2++) {
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Valor"){
            A_Select = A_Select + " '" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + "' "
          } 
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Operacion"){
            A_Select = A_Select + " " + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + " "
          } 
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Registro"){
            ID_TAG_selec = 'p' + cc_pesta + 'zzz' + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"]
            if(document.getElementById(ID_TAG_where).value == ""){FaltaDato = true}
            A_Select = A_Select + " '" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + "' "
          } 
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Campo"){
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == ""){
              A_Select = A_Select + " " + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + " "
            } 
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == "Suma"){
              A_Select = A_Select + " Sum(" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + ") "    
              if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] != ""){
                A_Group = A_Group + Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] + ", "
              }     
            } 
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == "Promedio"){
              A_Select = A_Select + " Avg(" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + ") "
              if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] != ""){
                A_Group = A_Group + Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] + ", "
              }
            } 
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == "Contar"){
              A_Select = A_Select + " Count(" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + ") "
              if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] != ""){
                A_Group = A_Group + Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] + ", "
              }
            } 
          } 
        }
        A_Select = A_Select + " as char) as '" + Response["func_cab"][cc_nombre][3][0][3][x]["Nombre"] +  "', "
      }
      A_Select = A_Select.slice(0,-2)
      if(A_Group != "Group by "){
        A_Group = A_Group.slice(0,-2)
      }

      if(A_Group == "Group by "){
        if(A_GroupWhere == "Group by "){
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where
          }
        }else{
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From + " " + A_GroupWhere
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_GroupWhere
          }
        }
      }else{
        if(A_GroupWhere == "Group by "){
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From + " " + A_Group
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_Group
          }
        }else{
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From + " " +  A_Group + ", " + A_GroupWhere.slice(8).ToString
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where + " " +  A_Group + ", " + A_GroupWhere.slice(8).ToString
          }
        }
      }
      $.ajax({
        type: 'POST',
        url: '/consolidado',
        data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': sentencia,  'tag1': 'tag1', 'tag2': 'tag2', 'usuario':'{{usuario}}'},
        success: function(Response){

        if(Response["cmpvalor"].length > 0){

              for (xq = 0; xq < (cc_porPesta["p-" + cc_pesta]+2); xq++) {
                menos(cc_pesta, xq, 1)
              }
              linea_inicial = cc_porPesta["p-" + cc_pesta]

              for (xq = 0; xq < Response["cmpvalor"].length; xq++) {
                mas(cc_pesta)
                for (xq2 = 0; xq2 < Object.keys(Response['cmpvalor'][xq]).length; xq2++) {
                  id_tag_det = 'pd' + cc_pesta + 'fff' + cc_porPesta["p-" + cc_pesta] + 'ccc' + Object.keys(Response['cmpvalor'][xq])[xq2]     
                  if(dict_pestalla['p-' +cc_pesta]["func_det"][ Object.keys(Response['cmpvalor'][xq])[xq2]][0]["Tipo"] == "Imagen"){

                            inerhtml = '<img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+id_tag_det+'_img" src="/media/archivos/{{Id_empresa}}/'+ Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]+'" alt="image" value="0">' + Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]

                          document.getElementById(id_tag_det + "_label").innerHTML =  inerhtml  
                          document.getElementById(id_tag_det + "_label").href = '/media/archivos/{{Id_empresa}}/'+ Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]   
                        
                          document.getElementById(id_tag_det + "_img").src = '/media/archivos/{{Id_empresa}}/'+ Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]   




                  }else{
                    document.getElementById(id_tag_det).value  = Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]   
                  }
                }
              }
            calcular_0(cc_pesta)
             for (xq = linea_inicial; xq < (cc_porPesta["p-" + cc_pesta]); xq++) {
                calcular_detalle(cc_pesta, xq+1)
              }
            calcular_0(cc_pesta)

        }


        } 
      });
    }
  }         


  for (zt = 0; zt < anexos.length; zt++) {  

     buscar_referencia_cabecera_enter(document.getElementById(anexos[zt]))
  }
  calcular_0(pestalla)
}

function poner_valor_buscar_referencia_reporte(campo){
  var cc_id = campo.id
  var res = cc_id.split("zz");
  var cc_pesta = res[1];
  var cc_nombre  = res[3]
  document.getElementById(campo.id).value = document.getElementById("vfinal_bus_2").value + "%"
 
  //id="rpzz'+ pestalla +'zz'+ x +'zz'+Response['referencias_reprotes'][x]["id"] +'" 
  //Response = dict_pestalla['p-'+cc_pesta]
}

function doble_click_buscador_rep(campo, x){
  selecctt_buscador(x)
  var btn = document.getElementById("c_modal_ref_rep")
  btn.click()
}

function doble_click_buscador_cad(campo, x){
  selecctt_buscador(x)
  var btn = document.getElementById("c_modal_ref_cab")
  btn.click()
}

function doble_click_buscador_det(campo, x){
  selecctt_buscador(x)
  var btn = document.getElementById("c_modal_ref_det")
  btn.click()
}

function filtrar_buscar_rep(id_campo_busc, pkcampo){

  //sentencia2 = "select * from (" + document.getElementById("buscador_senten").value + ") int_ress where "  + document.getElementById("busca_campo").value + " like '" + document.getElementById("busca_valor").value + "%'"

  cmpsenten= document.getElementById("buscador_senten").value
  valor_filtro = document.getElementById("busca_valor").value

   $.ajax({
          type: 'POST',
          url: '/buscador_filt_rep',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten':cmpsenten, 'usuario':'{{usuario}}', 'pkcampo':pkcampo, 'valor_filtro':valor_filtro, 'id_campo_busc':id_campo_busc.id,},
          success: function(Response){

            var campo = document.getElementById(Response['id_campo_busc'][0]) 

            buscador_resultado = Response['cmpvalor']

            data_int = '<div class="panel-body" style="overflow: auto;"><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'
            data_int = data_int + '<th style="display: none;">' + Response['nombre'] + '</th>'

            for (x = 0; x < Object.keys(Response['cmpvalor'][0]).length; x++) {
              data_int = data_int + '<th>' + Object.keys(Response['cmpvalor'][0])[x] + '</th>'

            }
            data_int = data_int + '</tr></thead><tbody>'
            for (x = 0; x < Response['cmpvalor'].length; x++) {
              data_int = data_int + '<tr onclick="doble_click_buscador_rep(' + campo +', this)">'
              data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][Response['nombre']] + '</td>'

              for (x2 = 0; x2 < Object.keys(Response['cmpvalor'][x]).length; x2++) {
                data_int = data_int + '<td>' + Response['cmpvalor'][x][Object.keys(Response['cmpvalor'][x])[x2]] + '</td>'
              }
              data_int = data_int + '</tr>'
            }
            data_int = data_int + '</tbody></table></div>'
            $('#buscador_int').html(data_int);
          } 
        });
}

function filtrar_buscar(id_campo_busc, pkcampo){

  //sentencia2 = "select * from (" + document.getElementById("buscador_senten").value + ") int_ress where "  + document.getElementById("busca_campo").value + " like '" + document.getElementById("busca_valor").value + "%'"

  cmpsenten= document.getElementById("buscador_senten").value
  valor_filtro = document.getElementById("busca_valor").value
  max = document.getElementById('busca_max').value

   $.ajax({
          type: 'POST',
          url: '/buscador_filtro',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten':cmpsenten, 'usuario':'{{usuario}}', 'pkcampo':pkcampo, 'valor_filtro':valor_filtro, 'id_campo_busc':id_campo_busc.id, 'max':max},
          success: function(Response){

            var campo = document.getElementById(Response['id_campo_busc'][0]) 

            buscador_resultado = Response['cmpvalor']
            orden = Response["A_Select"].split(",")

            data_int = '<div class="panel-body" style="overflow: auto;"><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'
            data_int = data_int + '<th style="display: none;">' + Response['nombre'] + '</th>'
            visibles = Response['datos_PkCampo'][0]['visibles'].split(',')
            largos = Response['datos_PkCampo'][0]['largos'].split(',')

            for (x = 0; x < orden.length; x++) {
                if(visibles[x] == 'S'){
                        data_int = data_int + '<th>' + orden[x] + '</th>'
                    }else{
                        data_int = data_int + '<th style="display: none;">' + orden[x] + '</th>'
                    }
            }
          
            data_int = data_int + '</tr></thead><tbody>'
            for (x = 0; x < Response['cmpvalor'].length; x++) {
              data_int = data_int + '<tr onclick="doble_click_buscador_cad(' + campo +', this)">'
              data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][Response['nombre']] + '</td>'

              for (x2 = 0; x2 < orden.length; x2++) {
                if(visibles[x2] == 'S'){
                        data_int = data_int + '<td>' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                    }else{
                        data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][orden[x2]] + '</td>'

                    }
              }
              data_int = data_int + '</tr>'
            }
            data_int = data_int + '</tbody></table></div>'
            $('#buscador_int').html(data_int);
          } 
        });
}

function filtrar_buscar_det(id_campo_busc, pkcampo){

  //sentencia2 = "select * from (" + document.getElementById("buscador_senten").value + ") int_ress where "  + document.getElementById("busca_campo").value + " like '" + document.getElementById("busca_valor").value + "%'"

  cmpsenten= document.getElementById("buscador_senten").value
  valor_filtro = document.getElementById("busca_valor").value
     max = document.getElementById("busca_max").value
   $.ajax({
          type: 'POST',
          url: '/buscador_filtro',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten':cmpsenten, 'usuario':'{{usuario}}', 'pkcampo':pkcampo, 'valor_filtro':valor_filtro, 'id_campo_busc':id_campo_busc.id, 'max':max},
          success: function(Response){

            var campo = document.getElementById(Response['id_campo_busc'][0]) 

            buscador_resultado = Response['cmpvalor']
            orden = Response["A_Select"].split(",")
            data_int = '<div class="panel-body" style="overflow: auto;"><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'
            visibles = Response['datos_PkCampo'][0]['visibles'].split(',')
            largos = Response['datos_PkCampo'][0]['largos'].split(',')

            data_int = data_int + '<th style="display: none;">' + Response['nombre'] + '</th>'
            for (x = 0; x < orden.length; x++) {
                if(visibles[x] == 'S'){
                    data_int = data_int + '<th>' + orden[x] + '</th>'
                }else{
                    data_int = data_int + '<th style="display: none;">' + orden[x] + '</th>'
                }

            }

            data_int = data_int + '</tr></thead><tbody>'
            for (x = 0; x < Response['cmpvalor'].length; x++) {
              data_int = data_int + '<tr  onclick="doble_click_buscador_det(' + campo +', this)">'
              data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][Response['nombre']] + '</td>'

              for (x2 = 0; x2 < orden.length; x2++) {

                if(visibles[x2] == 'S'){
                    data_int = data_int + '<td>' 
                }else{
                    data_int = data_int + '<td style="display: none;">'
                }
                  if(orden[x2] == 'imagen'){
                    data_int = data_int + '<div class="thumbnail" style="height: 100px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%;margin-left: auto;margin-right: auto; display: block;" src="/media/archivos/{{Id_empresa}}/' + Response['cmpvalor'][x][orden[x2]] + '" alt="image"><a href="/media/archivos/{{Id_empresa}}/' + Response['cmpvalor'][x][orden[x2]] + '" target="_blank">' + Response['cmpvalor'][x][orden[x2]] + '</a></div></div></td>'
                  }else{
                    data_int = data_int + '' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                  }
              }
              data_int = data_int + '</tr>'
            }
            data_int = data_int + '</tbody></table></div>'
            $('#buscador_int').html(data_int);
          } 
        });
}

var buscador_resultado = []

function buscar_referencia_reporte(campo){
  var cc_id = campo.id
  var res = cc_id.split("zz");
  var cc_pesta = res[1]
  var cc_indi = res[2]
  var cc_id_ref  = res[3]

  Response = dict_pestalla['p-'+cc_pesta]


  where = " "
  columnas = Response["referencias_reprotes"][cc_indi]["columnas"]
  campo = Response["referencias_reprotes"][cc_indi]["campo"]
  dato = document.getElementById(cc_id).value
  tabla = Response["referencias_reprotes"][cc_indi]["tabla"]
  orderby = " order by pk" + Response["referencias_reprotes"][cc_indi]["tabla"] + " desc "

  PkCampo = Response["referencias_reprotes"][cc_indi]["id"] 

    cmpsenten = "select " + columnas + ' from ' + tabla + ' ' 

        $.ajax({
          type: 'POST',
          url: '/buscador',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': cmpsenten, 'usuario':'{{usuario}}', 'PkCampo':PkCampo, 'A_Select': columnas},
          success: function(Response){
            orden = Response["A_Select"].split(",")
            buscador_resultado = Response['cmpvalor']
            data_int= '<div class="row"><div class="col-lg-12" >'
            document.getElementById("buscador_senten").value = cmpsenten
           
            data_int = data_int +'<input class="form-control" id="busca_valor" placeholder="Escriba para filtrar" onkeypress="return runScript_buscador_rep(event, ' + cc_id +', '+Response['PkCampo']+')"></div></div>'


            data_int = data_int + '<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" onclick="poner_valor_buscar_referencia_reporte(' + cc_id +')" id="c_modal_ref_rep" style="display: none;"></button></div>'

        
            data_int = data_int + '<div id="buscador_int" style="overflow: auto;">'

            data_int = data_int + '<div class="panel-body" ><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'
              data_int = data_int + '<th style="display: none;">' + campo + '</th>'


                for (x = 0; x < orden.length; x++) {
                    data_int = data_int + '<th>' + orden[x] + '</th>'
                }
         
            data_int = data_int + '</tr></thead><tbody>'



              for (x = 0; x < Response['cmpvalor'].length; x++) {
                data_int = data_int + '<tr onclick="doble_click_buscador_rep(' + cc_id +', this)">'
                data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][campo] + '</td>'

                for (x2 = 0; x2 < orden.length; x2++) {
                  data_int = data_int + '<td>' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                }
                data_int = data_int + '</tr>'
              }
        
            data_int = data_int + '</tbody></table></div>'

            data_int = data_int + '</div>'

            data_int = data_int + '<div class="modal-footer"></div>'

              $('#intbuscador').html(data_int);
          }
          });

    
}


function buscar_referencia_cabecera(campo){
  var cc_id = campo.id
  var res = cc_id.split("zzz");
  var cc_pesta = res[0].substring(1);
  var cc_nombre  = res[1]

  Response = dict_pestalla['p-'+cc_pesta]


  where = " "
  modo = Response["func_cab"][cc_nombre][0][0]["Modo"]
  columnas = Response["func_cab"][cc_nombre][0][0]["Columnas"]
  campo = Response["func_cab"][cc_nombre][0][0]["Sentencia"]
  dato = document.getElementById(cc_id).value
  tabla = Response["func_cab"][cc_nombre][0][0]["TablaOrigen"]
  orderby = " order by pk" + Response["func_cab"][cc_nombre][0][0]["TablaOrigen"] + " desc "
  PkCampo = Response["func_cab"][cc_nombre][0][0]["PkCampo"]


  for (x = 0; x <   Response["func_cab"][cc_nombre][1].length; x++) {   

    ElementoA = ""
    ElementoB = ""
    
    if(Response["func_cab"][cc_nombre][1][x]["TipoA"] == "R"){
      id_ext = 'p' + cc_pesta + 'zzz' + Response["func_cab"][cc_nombre][1][x]["ElementoA"] 
      ElementoA = "'" + document.getElementById(id_ext).value + "'"
    }
    if(Response["func_cab"][cc_nombre][1][x]["TipoA"] == "V"){
      ElementoA = " '" +Response["func_cab"][cc_nombre][1][x]["ElementoA"] + "'"
    }
    if(Response["func_cab"][cc_nombre][1][x]["TipoA"] == "C"){
      ElementoA = Response["func_cab"][cc_nombre][1][x]["ElementoA"]
    }

    if(Response["func_cab"][cc_nombre][1][x]["TipoB"] == "R"){
      id_ext = 'p' + cc_pesta + 'zzz' + Response["func_cab"][cc_nombre][1][x]["ElementoB"] 
      ElementoB = "'" + document.getElementById(id_ext).value + "'"
    }
    if(Response["func_cab"][cc_nombre][1][x]["TipoB"] == "V"){
      ElementoB = "'" + Response["func_cab"][cc_nombre][1][x]["ElementoB"] + "'"
    }
    if(Response["func_cab"][cc_nombre][1][x]["TipoB"] == "C"){
      ElementoB = Response["func_cab"][cc_nombre][1][x]["ElementoB"]
    }

    where = where + ElementoA + ' ' + Response["func_cab"][cc_nombre][1][x]["Operador"]  + ' ' + ElementoB +  ' and '
  }
  if (where == " "){where = ""}else{where = 'where ' + where.slice(0,-4)}

  cmpsenten = "select " + columnas + ' from ' + tabla + ' ' + where + ' order by pk' + tabla + ' desc' 

        $.ajax({
          type: 'POST',
          url: '/buscador',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': cmpsenten, 'usuario':'{{usuario}}', 'A_Select': columnas, 'PkCampo':PkCampo},
          success: function(Response){

            if(Response['cmpvalor'].length == 0){
              //data_int = '<div class="col-lg-3">No existen datos</div>'
              data_int = 'No existen datos'

            }else{
                orden = Response["A_Select"].split(",")

              buscador_resultado = Response['cmpvalor']
              data_int= '<div class="row"><div class="col-lg-12" >'
              //'<select class="form-control" id="busca_campo">'
              //for (x = 0; x <   Object.keys(Response['cmpvalor'][0]).length; x++) {
              //  data_int = data_int + '<option>' + Object.keys(Response['cmpvalor'][0])[x] + '</option>'
                
              //} 
              document.getElementById("buscador_senten").value = cmpsenten
               //'</select>'
              data_int = data_int +'<input class="form-control" id="busca_valor" placeholder="Escriba para filtrar" onkeypress="return runScript_buscador_cab(event, ' + cc_id +', '+Response['PkCampo']+')"> Max: <input type="number" id="busca_max" value="10" style="width: 40px;" onchange="filtrar_buscar(' + cc_id +', '+Response['PkCampo']+')"</div></div>'
            

              data_int = data_int + '<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" onclick="poner_valor_buscar_referencia_cabecera(' + cc_id +')" id="c_modal_ref_cab" style="display: none;"></button></div>'

              data_int = data_int + '<div id="buscador_int" style="overflow: auto;">'
              data_int = data_int + '<div class="panel-body" ><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'
              data_int = data_int + '<th style="display: none;">' + campo + '</th>'
                visibles = Response['datos_PkCampo'][0]['visibles'].split(',')
                largos = Response['datos_PkCampo'][0]['largos'].split(',')
                for (x = 0; x < orden.length; x++) {
                    if(visibles[x] == 'S'){
                        data_int = data_int + '<th>' + orden[x] + '</th>'
                    }else{
                        data_int = data_int + '<th style="display: none;">' + orden[x] + '</th>'
                    }
                }
 
              data_int = data_int + '</tr></thead><tbody>'


              for (x = 0; x < Response['cmpvalor'].length; x++) {
                data_int = data_int + '<tr onclick="doble_click_buscador_cad(' + cc_id +', this)">'
                data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][campo] + '</td>'

                for (x2 = 0; x2 < orden.length; x2++) {
                    if(visibles[x2] == 'S'){
                        data_int = data_int + '<td>' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                    }else{
                        data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                    }
                }
                data_int = data_int + '</tr>'
              }
          
              data_int = data_int + '</tbody></table></div>'

              data_int = data_int + '</div>'

              data_int = data_int + '<div class="modal-footer"></div>'
            }
         


            $('#intbuscador').html(data_int);

          }
          });
}

function buscar_referencia_detalle(campo){
  var cc_id = campo.id
  var res = cc_id.split("fff");
  var res2 = res[1].split("ccc");

  var cc_pesta = res[0].substring(2);
  var cc_fila = res2[0]
  var cc_nombre  = res2[1]
  calcular_detalle(cc_pesta, cc_fila)

  Response = dict_pestalla['p-'+cc_pesta]

  PkCampo = Response["func_det"][cc_nombre][0][0]["PkCampo"]

  where = " "
  modo = Response["func_det"][cc_nombre][0][0]["Modo"]
  columnas = Response["func_det"][cc_nombre][0][0]["Columnas"]
  campo = Response["func_det"][cc_nombre][0][0]["Sentencia"]
  dato = document.getElementById(cc_id).value
  tabla = Response["func_det"][cc_nombre][0][0]["TablaOrigen"]
  orderby = " order by pk" + Response["func_det"][cc_nombre][0][0]["TablaOrigen"] + " desc "


  for (x = 0; x <   Response["func_det"][cc_nombre][1].length; x++) {   

    ElementoA = ""
    ElementoB = ""
    if(Response["func_det"][cc_nombre][1][x]["TipoA"] == "R"){
      id_ext = 'pd' + cc_pesta + 'fff' + cc_fila + 'ccc' + Response["func_det"][cc_nombre][1][x]["ElementoA"] 
      ElementoA = "'" + document.getElementById(id_ext).value + "'"
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoA"] == "V"){
      ElementoA = "'" +Response["func_det"][cc_nombre][1][x]["ElementoA"] + "'"
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoA"] == "C"){
      ElementoA = Response["func_det"][cc_nombre][1][x]["ElementoA"]
    }

    if(Response["func_det"][cc_nombre][1][x]["TipoB"] == "R"){
      id_ext = 'pd' + cc_pesta + 'fff' + cc_fila + 'ccc' + Response["func_det"][cc_nombre][1][x]["ElementoB"] 
      ElementoB = "'" + document.getElementById(id_ext).value + "'"
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoB"] == "V"){
      ElementoB = "'" + Response["func_det"][cc_nombre][1][x]["ElementoB"] + "'"
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoB"] == "C"){
      ElementoB = Response["func_det"][cc_nombre][1][x]["ElementoB"]
    }

    where = where + ElementoA + ' ' + Response["func_det"][cc_nombre][1][x]["Operador"]  + ' ' + ElementoB +  ' and '
  }
  if (where == " "){where = ""}else{where = 'where ' + where.slice(0,-4)}

    cmpsenten = "select " + columnas + ' from ' + tabla + ' ' + where + ' order by pk' + tabla + ' desc'

        $.ajax({
          type: 'POST',
          url: '/buscador',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': cmpsenten, 'usuario':'{{usuario}}', 'PkCampo':PkCampo, 'A_Select': columnas},
          success: function(Response){

            if(Response['cmpvalor'].length == 0){
              //data_int = '<div class="col-lg-3">No existen datos</div>'
              data_int = 'No existen datos'

            }else{
              buscador_resultado = Response['cmpvalor']
                orden = Response["A_Select"].split(",")
              data_int= '<div class="row"><div class="col-lg-12">'
              //'<select class="form-control" id="busca_campo">'
              //for (x = 0; x <   Object.keys(Response['cmpvalor'][0]).length; x++) {
                //data_int = data_int + '<option>' + Object.keys(Response['cmpvalor'][0])[x] + '</option>'
                
              //} 
              document.getElementById("buscador_senten").value = cmpsenten
              //data_int = data_int + '</select>'
              data_int = data_int +'<input class="form-control" id="busca_valor" placeholder="Escriba para filtrar" onkeypress="return runScript_buscador_det(event, ' + cc_id +', '+Response['PkCampo']+')"> Max: <input type="number" id="busca_max" value="10" style="width: 40px;" onchange="filtrar_buscar_det(' + cc_id +', '+Response['PkCampo']+')"></div></div>'
        

              //'<button class="btn btn-primary" onclick="filtrar_buscar(' + cc_id +')"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></button>'
            
             data_int = data_int + '<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" onclick="poner_valor_buscar_referencia_detalle(' + cc_id +')" id="c_modal_ref_det" style="display: none;"></button></div>'


              data_int = data_int + '<div id="buscador_int" style="overflow: auto;">'
              data_int = data_int + '<div class="panel-body"><table style="cursor: pointer;font-size: 11px;" width="100%" class="table table-striped table-bordered table-hover" id="dataTables-example"><thead><tr>'
              data_int = data_int + '<th style="display: none;">' + campo + '</th>'
            visibles = Response['datos_PkCampo'][0]['visibles'].split(',')
            largos = Response['datos_PkCampo'][0]['largos'].split(',')
                for (x = 0; x < orden.length; x++) {
                    if(visibles[x] == 'S'){
                        data_int = data_int + '<th>' + orden[x] + '</th>'
                    }else{
                        data_int = data_int + '<th style="display: none;">' + orden[x] + '</th>'
                    }

                }


           

              data_int = data_int + '</tr></thead><tbody>'

              for (x = 0; x < Response['cmpvalor'].length; x++) {
                data_int = data_int + '<tr onclick="doble_click_buscador_det(' + cc_id +', this)" >'
                data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][campo] + '</td>'
                for (x2 = 0; x2 < orden.length; x2++) {
                    if(visibles[x2] == 'S'){
                        if(orden[x2] == 'imagen'){
                            data_int = data_int + '<td><div class="thumbnail" style="height: 100px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%;margin-left: auto;margin-right: auto; display: block;" src="/media/archivos/{{Id_empresa}}/' + Response['cmpvalor'][x][orden[x2]] + '" alt="image"><a href="/media/archivos/{{Id_empresa}}/' + Response['cmpvalor'][x][orden[x2]] + '" target="_blank">' + Response['cmpvalor'][x][orden[x2]] + '</a></div></div></td>'
                        }else{
                            data_int = data_int + '<td>' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                        }

                    }else{
                        if(orden[x2] == 'imagen'){
                            data_int = data_int + '<td style="display: none;"><div class="thumbnail" style="height: 100px;margin-bottom: 1px;"><div class="image view view-first"><img style="width: 80%;height: 60%;margin-left: auto;margin-right: auto; display: block;" src="/media/archivos/{{Id_empresa}}/' + Response['cmpvalor'][x][orden[x2]] + '" alt="image"><a href="/media/archivos/{{Id_empresa}}/' + Response['cmpvalor'][x][orden[x2]] + '" target="_blank">' + Response['cmpvalor'][x][orden[x2]] + '</a></div></div></td>'
                        }else{
                            data_int = data_int + '<td style="display: none;">' + Response['cmpvalor'][x][orden[x2]] + '</td>'
                        }

                    }

                 



                }
                data_int = data_int + '</tr>'
              }
          
                data_int = data_int + '</tbody></table></div>'          
                data_int = data_int + '</div>'
                data_int = data_int + '<div class="modal-footer"></div>'

        }

            $('#intbuscador').html(data_int);

          }
          });
}


function registro_de_rep(pkmodulo, pkregistro, tipo) {

        pestalla = pestalla +1;

        $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">Vista_rapida  <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i> </a></li>');


       


        var id_tab = pkmodulo
        if(tipo == 0){tipo = 'Nuevo'}
        if(tipo == 1){tipo = 'modificar'}
        if(tipo == 2){tipo = 'consulta'}

        $.ajax({
          type: 'POST',
          url: '/{{idioma}}/consulta',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'pkmodulo':pkmodulo, 'pestalla':pestalla,'pkregistro':pkregistro, 'tipo':tipo },
          beforeSend: function () {
              $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> Procesando </div>');
             },
          success: function(Response){

            $('#rr' + pestalla).html('');

            id_dic = 'p-' + pestalla
            dict_pestalla[id_dic] = Response
            cc_porPesta[id_dic] = 1

            div_botones = '<div class="row"><div class="col-md-12"><div class="row">'
            readonly = 'readonly="readonly"'
            if (tipo == 'consulta'){ 
                readonly = 'readonly="readonly"'
                //div_botones =div_botones +'<button type="button" onclick="cerrar_elemento(' + pestalla + ')" class="btn btn-primary"><span>Correo</span></button>'
                div_botones =div_botones +'<button type="button" onclick="pdf_elemento(' + pestalla + ')" class="btn btn-primary"><span>PDF</span></button>'
                //div_botones =div_botones +'<button type="button" onclick="excell_elemento(' + pestalla + ')" class="btn btn-primary"><span>Excell</span></button>'

            }



              else{          
                if (tipo == 'Nuevo'){
                  disparador= 'Guardar Registro Nuevo'
                  div_botones =div_botones +'<button type="button" onclick="grabar_elemento(' + pestalla + ',0)" class="btn btn-success"><span>Grabar</span></button>'
                }else{
                  disparador= 'Modificar Registro'
                  div_botones =div_botones +'<button type="button" onclick="grabar_elemento(' + pestalla + ',1)" class="btn btn-success"><span>Grabar</span></button>'
                }
                div_botones =div_botones +'<button type="button" onclick="validar_registro(' + pestalla + ')" class="btn btn-warning"><span>Validar</span></button>'
                //div_botones =div_botones +'<button type="button" onclick="nuevo_elemento(' + pestalla + ')" class="btn btn-primary"><span>Nuevo</span></button>'
                readonly = ''
            }

            div_botones =div_botones +'<button type="button" onclick="cerrar_elemento(' + pestalla + ')" class="btn btn-danger"><span>Cerrar</span></button>'
            
            div_botones =div_botones +'</div></div></div>'

            $('#rr' + pestalla).append(div_botones);
            div_campos2 = ''
            div_campos = '<div class="card-block text-left"> <div class="row">'
            div_campos_arriba_izq= ''
            div_campos_arriba_der= ''
            div_campos_abajo_izq= ''
            div_campos_abajo_der= ''
            div_c_t =''
            for (x = 0; x < Response["campos_cab"].length; x++) { 
              
              if (tipo == 'Nuevo'){

                  if (Response["campos_cab"][x]["TablaCampo"] == "cmptxtsimple"){
                    valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorPredeterminado"]

                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsimple"){
                    valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"]

                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsecuencial"){
                    if (Response["campos_cab"][x]["TablaCampo"].substring(0,2) == "Pk"){
                      valor_campo = 0
                    }else{
                      valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorInicial"]
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpopcmultiple"){
                      valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Valor"]

                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpsistema"){

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                      valor_campo = "{{usuario}}"

                    }

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                      var now = new Date();
                      valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                    }


                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpformuladetalle"){
                     valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){
                    var now = new Date();
                    if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == "Y"){
                      valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                    }else{
                      valor_campo = now.format("Y-m-d");
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferencia"){
                    valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["predeterminado_valor"]
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                    valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpoperacion"){
                    valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpconsolidado"){
                    valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmparchivo"){
                    valor_campo = ""
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumeroaletras"){
                    valor_campo = ""
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpdecabecera"){
                    valor_campo = ""
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpelectronico"){
                    valor_campo = 0

                  }
                }else{
                  valor_campo = Response["valores_cab"][0][Response["campos_cab"][x]["Nombre"]] 

                  if(Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){

                    var now = new Date(Response["valores_cab"][0][Response["campos_cab"][x]["Nombre"]]);
                    if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == "Y"){
                      valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                    }else{
                      valor_campo = now.format("Y-m-d");
                    }
                    

                  }
              }

              ID_TAG = 'p' + Response["pestalla"] + 'zzz' + Response["campos_cab"][x]["Nombre"] + '';

              if (Response["campos_cab"][x]["Visible"] == "Y") {
  

                  div_c_t = Response["campos_cab"][x]["saltoweb"]
                  div_c_t = div_c_t + '<div class="col-sm-' + Response["campos_cab"][x]["largoweb"] + '">'
                  div_c_t = div_c_t + '<label class="control-label for="' + Response["campos_cab"][x]["Nombre"] + '" style="font-size: 11px;" >' + Response["campos_cab"][x]["Descripcion"] + '</label>'

                  if (Response["campos_cab"][x]["TablaCampo"] == "cmptxtsimple"){
                    readonly_int = ''
                    if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Modificable"] == "N"){readonly_int = 'readonly="readonly"'
                    }
                    if (tipo == 'Nuevo'){
                      valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorPredeterminado"]
                    }
                      if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Largo"] > 100){
                         div_c_t = div_c_t + '<textarea type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' '+ readonly_int +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 45px;font-size: 11px;">'+ valor_campo +'</textarea>'
                      }else{
                          div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' '+ readonly_int +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                      }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsimple"){

                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' min="'+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"] +'" max="'+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Mayor"] +'" onchange="guardar_calcular('+ ID_TAG +', 0 )" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'                    
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsecuencial"){

                    div_c_t = div_c_t + '<input type="number" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpopcmultiple"){
                    if (tipo != 'consulta'){
                      div_c_t = div_c_t + '<select class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" id="'+ ID_TAG + '" value="'+ valor_campo +'" onchange="guardar_calcular('+ ID_TAG +' , 0)" style="height: 25px;font-size: 11px;">'

                      for (z = 0; z < Response["func_cab"][Response["campos_cab"][x]["Nombre"]].length; z++) { 

                        if(valor_campo == Response["func_cab"][Response["campos_cab"][x]["Nombre"]][z]["Valor"] )
                          {
                              div_c_t = div_c_t + '<option selected>' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][z]["Valor"] + '</option>'
                          }else{
                              div_c_t = div_c_t + '<option>' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][z]["Valor"] + '</option>'
                          }
                      }
                      div_c_t = div_c_t + '</select>'                        
                    }else{
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpsistema"){
                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
                    }

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                      div_c_t = div_c_t + '<input type="datetime-local" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpformuladetalle"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular('+ ID_TAG +' , 0 )" style="text-align: right;height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){
                    tipodato = 'date'
                 
                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == 'Y'){
                            tipodato = 'datetime-local'}
                    div_c_t = div_c_t + '<input type="' + tipodato + '" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferencia"){
                    div_c_t = div_c_t + '<div>'
                    


                    if (tipo != 'consulta'){
            
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["pkmodulo_ingreso"] !=0){
                            div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + (Response["campos_cab"][x]["largoweb"]-1) + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="width: 70%;height: 25px;font-size: 11px;" onkeypress="return runScript(event, '+ ID_TAG +')" >'
                            div_c_t = div_c_t + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_cabecera('+ ID_TAG +' )"style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>'
                       
                            
                            div_c_t = div_c_t + '<button type="button" class="btn btn-primary"  onclick="registro('+Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["pkmodulo_ingreso"]+',0,0,-1,0)" style="height: 25px;padding: 3px 4px;"><i class="fa fa-plus"></i></button>'
                        }else{
                            div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + (Response["campos_cab"][x]["largoweb"]-1) + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="width: 75%;height: 25px;font-size: 11px;" onkeypress="return runScript(event, '+ ID_TAG +')" >'
                            div_c_t = div_c_t + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_cabecera('+ ID_TAG +' )"style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>'

                        }

                    }else{
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + (Response["campos_cab"][x]["largoweb"]-1) + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;" onkeypress="return runScript(event, '+ ID_TAG +')" >'
                    }
                    
                    div_c_t = div_c_t + '</div>'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Imagen'){
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +'  onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'

                    }
                    else{
                        Moddato = ''
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Modificable"] == 'N'){
                            Moddato = 'readonly="readonly"'}
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Texto'){

                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tamano"] == 'G'){

                         div_c_t = div_c_t + '<textarea type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' '+ Moddato +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 45px;font-size: 11px;">'+ valor_campo +'</textarea>'

                        }else{
                          div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                        }


                        }
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Numero'){
                            div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="text-align: right;" style="height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'

                        }
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Fecha'){
                     
                            div_c_t = div_c_t + '<input type="date" id="'+ ID_TAG + '"class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                          }
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Fecha Tiempo'){
                      
                            div_c_t = div_c_t + '<input type="datetime-local" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                          }

                         
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpoperacion"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' onchange="setTwoNumberDecimal('+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Decimales"] +')" readonly="readonly" onchange="guardar_calcular('+ ID_TAG +', 0 )" style="text-align: right;height: 25px;font-size: 11px;" >'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpconsolidado"){
              
                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" onchange="guardar_calcular('+ ID_TAG +', 0)" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmparchivo"){

                   //div_c_t = div_c_t + '<input type="file" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' style="height: 25px;font-size: 11px;">'
                    div_c_t = div_c_t + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+ID_TAG +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank" style="font-size: 11px;"><img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+ID_TAG +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

                    div_c_t = div_c_t + '<label for="'+ID_TAG +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                    div_c_t = div_c_t + '<input type="file" id="'+ID_TAG +'_img_file" onchange="cambiar_imagen('+ ID_TAG +'_img)" style="display: none"></div></div>'


                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumeroaletras"){
             
                   div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpdecabecera"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpelectronico"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                  }
                  div_c_t = div_c_t + '</div>'
           

                if (Response["campos_cab"][x]["posicionweb"] == "arriba_izq") {
                  div_campos_arriba_izq = div_campos_arriba_izq + div_c_t
                }
                if (Response["campos_cab"][x]["posicionweb"] == "arriba_der") {
                  div_campos_arriba_der = div_campos_arriba_der + div_c_t
                }
                if (Response["campos_cab"][x]["posicionweb"] == "abajo_izq") {
                  div_campos_abajo_izq = div_campos_abajo_izq + div_c_t
                }
                if (Response["campos_cab"][x]["posicionweb"] == "abajo_der") {
                  div_campos_abajo_der = div_campos_abajo_der + div_c_t
                }


              }else{ 
                  div_campos = div_campos + '<input type="hidden" id="'+ ID_TAG + '" value="'+ valor_campo +'" '+ readonly +'>'
              }

               
            }
            div_campos = div_campos + '<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_arriba_izq + '</div></div>'
            div_campos = div_campos + '<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_arriba_der + '</div></div>'
            
            div_campos_arriba_der
            $('#rr' + pestalla).append(div_campos);

            document.getElementById('id'+ pestalla).click();




            if(typeof(Response["campos_det"]) == "object"){
                    var largo_tabla= 0
                    for (x = 0; x < Response["campos_det"].length; x++) {
                      if (Response["campos_det"][x]["Visible"] == "Y") {
                        largo_tabla = largo_tabla + parseFloat(Response["campos_det"][x]["largo"])
                        
                      }
                    }

                if (tipo == 'consulta'){ 
                    div_campos = '<div id="divtabla' + Response["pestalla"] + '" style="overflow: auto;overflow-y: auto;padding-top: 20px;"><table id="tabla' + Response["pestalla"] + '" class="table table-striped" style="width: ' + parseInt(largo_tabla) +   'px;overflow-x:auto;font-size: 11px;"><thead><tr>'
                  }else{
                    div_campos = '<div id="divtabla' + Response["pestalla"] + '" style="overflow: auto;overflow-y: auto;padding-top: 20px;"><table id="tabla' + Response["pestalla"] + '" class="table table-striped" style="width: ' + parseInt(largo_tabla) +   'px;overflow-x:auto;font-size: 11px;"><thead><tr><th style="width: 10px;"></th>'
                }
                 

                for (x = 0; x < Response["campos_det"].length; x++) { 
                  if (Response["campos_det"][x]["Visible"] == "Y") {
                    //div_campos = div_campos + '<th class="col-md-' + Response["campos_det"][x]["largoweb"] + '" style="width: ' + Response["campos_det"][x]["largo"] + 'px;">' + Response["campos_det"][x]["Descripcion"] + '</th>'
                    div_campos = div_campos + '<th class="col-md-' + Response["campos_det"][x]["largoweb"] + '" style="padding-left: 0px;padding-right: 0px;">' + Response["campos_det"][x]["Descripcion"] + '</th>'
                  } 
                }
                div_campos = div_campos +'</tr></thead><tbody>'
                var i = 0;
                do {
                    if (tipo == 'consulta'){ 
                        div_campos = div_campos + '<tr id="f' + Response["pestalla"] + '-f'+ i +'">'     
                    }else{
                        div_campos = div_campos + '<tr id="f' + Response["pestalla"] + '-f'+ i +'"><td><div class="row"  style="padding-left: 10px;">'
                        div_campos = div_campos + '<button type="button" onclick="mas(' + Response["pestalla"]+')" class="btn btn-success" style="padding: 3px 4px;">+</button>'
                        div_campos = div_campos + '<button type="button" onclick="menos(' + Response["pestalla"]+',' + i + ', 0)" class="btn btn-danger" style="padding: 3px 6px;">-</button></div></td>'
                    }

                    altura_mini = 45

                    for (x = 0; x < Response["campos_det"].length; x++) {

                        valor_campo = 0;
                        if (tipo == 'Nuevo'){
                            
                          if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
                            valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorPredeterminado"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){
                            valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsecuencial"){
                            if (Response["campos_det"][x]["TablaCampo"].slice(0,2) == "Pk"){
                              valor_campo = 0
                            }else{
                              valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorInicial"]
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpopcmultiple"){
                              valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Valor"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpsistema"){
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                              valor_campo = "{{usuario}}"

                            }
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                              var now = new Date();
                              valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){
                             valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
                            var now = new Date();
                            addi = ' AM'
                            if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Tiempo"] == "Y"){
                               if(now.format("H") > 11){addi = ' PM' }
                              valor_campo = now + addi
                            }else{
                              valor_campo = now.format("Y-m-d");
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
                            valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["predeterminado_valor"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                            valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){
                            valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
                            valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){
                            valor_campo = ""
                          }
                          }else{
                            valor_campo = Response["valores_det"][i][Response["campos_det"][x]["Nombre"]] 
                        }
                        
                        id_tag_detalle = 'pd' + Response["pestalla"] +  'fff'+ i + 'ccc'+ Response["campos_det"][x]["Nombre"]

                        if (Response["campos_det"][x]["Visible"] == "Y") {
                          //div_campos = div_campos + '<td><div class="col-sm-' + Response["campos_det"][x]["largoweb"] + '" col-md-' + Response["campos_det"][x]["largoweb"] + '" col-lg-' + Response["campos_det"][x]["largoweb"] + '">'
                          div_campos = div_campos + '<td style="padding-left: 0px;padding-right: 0px;"><div style="width: ' + Response["campos_det"][x]["largo"] + 'px;">'

                          if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
                              readonly_int = ''

                              if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == "N"){
                                readonly_int = 'readonly="readonly"'
                              }
                              if (tipo == 'Nuevo'){
                                valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorPredeterminado"]
                              }
                              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Largo"] > 100){
                                 div_campos = div_campos + '<textarea type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" ' + readonly_int + ' style="height: '+altura_mini+'px;font-size: 11px;">'+ valor_campo +'</textarea>'
                              }else{
                               div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" '+ readonly_int + ' style="height: 25px;font-size: 11px;">'
                              }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){

                              div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" min="'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"] +'" max="'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Mayor"] +'" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsecuencial"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="text-align: right; height: 25px; font-size: 11px;" onkeypress="return solo_numero(event)">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpopcmultiple"){
                            if (tipo != 'consulta'){
                              div_campos = div_campos + '<select class="form-control" id="'+id_tag_detalle +'" value="'+ valor_campo +'" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                              for (z = 0; z < Response["func_det"][Response["campos_det"][x]["Nombre"]].length; z++) { 
                                if(valor_campo == Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] )
                                  {
                                      div_campos = div_campos + '<option selected>' + Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] + '</option>'
                                  }else{
                                      div_campos = div_campos + '<option>' + Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] + '</option>'
                                  }
                              }
                              div_campos = div_campos + '</select>'
                            }else{
                              div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;" >'
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpsistema"){
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                              div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
                            }
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"] == 'Fecha Actual'){
                              div_campos = div_campos + '<input type="datetime-local" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
                            tipodato = 'date'
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tiempo"] == 'Y'){
                                    tipodato = 'datetime-local'}
                            div_campos = div_campos + '<input type="' + tipodato + '" id="'+id_tag_detalle +'"  class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
                            
                            if (tipo == 'consulta'){ 
                              div_campos = div_campos + '<div class="input-group"><input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;" onkeypress="return runScript_detalle(event, '+ id_tag_detalle +')">'
                              div_campos = div_campos + '</div>'
                            }else{

                              div_campos = div_campos + '<div class="input-group"><input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="width: 70%;height: 25px;font-size: 11px;" onkeypress="return runScript_detalle(event, '+ id_tag_detalle +')">'
                              div_campos = div_campos + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_detalle('+ id_tag_detalle +' )" style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></button></div>'
                             }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Imagen'){

                              div_campos = div_campos + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+id_tag_detalle +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank"><img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+id_tag_detalle +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

                              altura_mini = 125

                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == 'N'){
                                    div_campos = div_campos + '</div></div>'

                                }else{
                                    div_campos = div_campos + '<label for="'+id_tag_detalle +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                                    div_campos = div_campos + '<input type="file" id="'+id_tag_detalle +'_img_file" onchange="cambiar_imagen('+ id_tag_detalle +'_img)" style="display: none"></div></div>'
                                }

                            }else{
                                Moddato = ''
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == 'N'){
                                    Moddato = 'readonly="readonly"'}
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Texto'){
                                  if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tamano"] == 'G'){
                                    div_campos = div_campos + '<textarea type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="font-size: 11px;height: '+ altura_mini +'px;">'+ valor_campo +'</textarea>'
                                  }else{
                                    div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                                  }
                                  
                                }
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Numero'){

                                    div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'
                                }
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Fecha'){

                                    div_campos = div_campos + '<input type="date" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                                  }
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Fecha Tiempo'){

                                    div_campos = div_campos + '<input type="datetime-local" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                                  }
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="setTwoNumberDecimal('+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Decimales"] +')" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;"> '
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
                      
                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmparchivo"){

                           //div_campos = div_campos + '<input type="file" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' style="height: 25px;font-size: 11px;">'
                           div_campos = div_campos + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+id_tag_detalle +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank" style="font-size: 11px;"><img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+id_tag_detalle +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

                            div_campos = div_campos + '<label for="'+id_tag +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                            div_campos = div_campos + '<input type="file" id="'+id_tag +'_img_file" onchange="cambiar_imagen('+ id_tag +'_img)" style="display: none"></div></div>'
                        
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumeroaletras"){
                     
                           div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpelectronico"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }

                          div_campos = div_campos + '</div></td>'

                        } else {
                          div_campos = div_campos + '<input type="hidden" id="'+id_tag_detalle +'" value="' +valor_campo+ '" '+ readonly +'>'
                        } 
                    }

                    div_campos = div_campos + '</tr>'
                    i++;
                }while (i < Response["valores_det"].length);
            
              cc_porPesta['p-'+pestalla] = (Response["valores_det"].length )
              div_campos = div_campos + '</tbody></table></div>'
                           

              $('#rr' + pestalla).append(div_campos);
              
              if(Response["valores_det"].length > 3){
                document.getElementById('divtabla' + Response["pestalla"]).style.height = "500px";

              }

              $('#rr' + pestalla).append('<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_abajo_izq + '</div></div>');
              $('#rr' + pestalla).append('<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_abajo_der + '</div></div>');
              

              document.getElementById('id'+ pestalla).click();
            }

            
            
            
            for (z2 = 0; z2 < Response["campos_cab"].length; z2++) { 
              if (tipo == 'Nuevo'){
                if(Response["campos_cab"][z2]["TablaCampo"] == "cmpreferencia"){
                  if(Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["predeterminado_valor"] != ''){
                    id_tag = 'p' + pestalla + 'zzz' + Response["campos_cab"][z2]["Nombre"]

                    if(Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["Tipo_Predeterminado"] == '1'){
                    id_tag_detalle_pret = 'p' + pestalla + 'zzz' + Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["predeterminado"] 
                      document.getElementById(id_tag).value = document.getElementById(id_tag_detalle_pret).value
                    }
                    buscar_referencia_cabecera_enter(document.getElementById(id_tag))
                  }
                }
              }
            }
             
            for (z2 = 0; z2 < Response["campos_det"].length; z2++) { 
              if (tipo == 'Nuevo'){
                if(Response["campos_det"][z2]["TablaCampo"] == "cmpreferencia"){
                  if(Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["predeterminado_valor"] != ''){
                    id_tag_detalle = 'pd' + Response["pestalla"] +  'fff'+ 0 + 'ccc'+ Response["campos_det"][z2]["Nombre"]
                    if(Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["Tipo_Predeterminado"] == '1'){
                      id_tag_detalle_pret = 'pd' + Response["pestalla"] +  'fff'+ 0 + 'ccc'+ Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["predeterminado"]
                      document.getElementById(id_tag_detalle).value = document.getElementById(id_tag_detalle_pret).value
                    }
                      buscar_referencia_detalle_enter(document.getElementById(id_tag_detalle))
                  }
                }
              }
            }

          }
        });     
}

function registro(pkmodulo, pkregistro, tipo, temp_pestalla, origen) {

        pestalla = pestalla +1;

        if(temp_pestalla == 'consulta'){
            $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">Consulta <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a></li>');


        }else{
            if (temp_pestalla == -1){
                $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">Nuevo <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a></li>');

            }else{

                if(dict_pestalla['p-'+temp_pestalla]["tabla_cab"] == undefined){
                    $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false">' + dict_pestalla['p-'+temp_pestalla]["tabla"][0]["Descripcion"] + ' <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i></a></li>');

                }else{

                    $("#myTab").prepend('<li role="presentation" class="" id="li' + pestalla + '" style="text-align: right;background: transparent;"><a href="#rr' + pestalla + '" id="id' + pestalla + '" role="tab" data-toggle="tab" aria-expanded="false" >' +  dict_pestalla['p-'+temp_pestalla]["tabla_cab"]["Descripcion"] + ' <i class="fa fa-times" style="color: red; background: transparent;cursor: pointer;" onclick="cerrar_elemento(' + pestalla +')"></i> </a></li>');
                }
            }


          
        }
        


        var id_tab = pkmodulo
        if(tipo == 0){tipo = 'Nuevo'}
        if(tipo == 1){tipo = 'modificar'}
        if(tipo == 2){tipo = 'consulta'}
        if(tipo == 3){tipo = 'consulta_nuevo'}

        $.ajax({
          type: 'POST',
          url: '/{{idioma}}/consulta',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'pkmodulo':pkmodulo, 'pestalla':pestalla,'pkregistro':pkregistro, 'tipo':tipo },
          beforeSend: function () {
              $("#myTabContent").prepend('<div role="tabpanel" class="tab-pane fade" id="rr' + pestalla + '" aria-labelledby="id' + pestalla + '"> Procesando </div>');
             },
          success: function(Response){


            $('#rr' + Response["dev_pestalla"]).html('');

            id_dic = 'p-' + Response["dev_pestalla"]
            dict_pestalla[id_dic] = Response
            cc_porPesta[id_dic] = 1

            div_botones = '<div class="row"><div class="col-md-12"><div class="row">'
            readonly = 'readonly="readonly"'
            if (tipo == 'consulta'){ 

                readonly = 'readonly="readonly"'
                //div_botones =div_botones +'<button type="button" onclick="cerrar_elemento(' + pestalla + ')" class="btn btn-primary"><span>Correo</span></button>'
                div_botones =div_botones +'<button type="button" onclick="pdf_elemento(' + Response["dev_pestalla"] + ')" class="btn btn-primary"><span>PDF</span></button>'
                //div_botones =div_botones +'<button type="button" onclick="excell_elemento(' + pestalla + ')" class="btn btn-primary"><span>Excell</span></button>'
                if (origen == '1'){
                  div_botones =div_botones + '<button class="btn btn-primary" onclick="registro(' + Response["tabla_cab"]["PkModulo"] +',0,0,' + Response["dev_pestalla"] +',0)">{{idioma_html.nuevo}}</span></button>'
                }


            }



              else{          
                if (tipo == 'Nuevo'){
                  disparador= 'Guardar Registro Nuevo'
                  div_botones =div_botones +'<button type="button" onclick="grabar_elemento(' + Response["dev_pestalla"] + ',0)" class="btn btn-success"><span>Grabar</span></button>'
                }else{
                  disparador= 'Modificar Registro'
                  div_botones =div_botones +'<button type="button" onclick="grabar_elemento(' + Response["dev_pestalla"] + ',1)" class="btn btn-success"><span>Grabar</span></button>'
                }
                div_botones =div_botones +'<button type="button" onclick="validar_registro(' + Response["dev_pestalla"] + ')" class="btn btn-warning"><span>Validar</span></button>'
                //div_botones =div_botones +'<button type="button" onclick="nuevo_elemento(' + Response["dev_pestalla"] + ')" class="btn btn-primary"><span>Nuevo</span></button>'
                readonly = ''
            }

            div_botones =div_botones +'<button type="button" onclick="cerrar_elemento(' + Response["dev_pestalla"] + ')" class="btn btn-danger"><span>Cerrar</span></button>'
            
            div_botones =div_botones +'</div></div></div>'

            $('#rr' + Response["dev_pestalla"]).append(div_botones);
            div_campos2 = ''
            div_campos = '<div class="card-block text-left"> <div class="row">'
            div_campos_arriba_izq= ''
            div_campos_arriba_der= ''
            div_campos_abajo_izq= ''
            div_campos_abajo_der= ''
            div_c_t =''
            for (x = 0; x < Response["campos_cab"].length; x++) { 
              
              if (tipo == 'Nuevo'){

                  if (Response["campos_cab"][x]["TablaCampo"] == "cmptxtsimple"){
                    valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorPredeterminado"]

                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsimple"){
                    valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"]

                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsecuencial"){
                    if (Response["campos_cab"][x]["TablaCampo"].substring(0,2) == "Pk"){
                      valor_campo = 0
                    }else{
                      valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorInicial"]
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpopcmultiple"){
                      valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Valor"]

                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpsistema"){

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                      valor_campo = "{{usuario}}"

                    }

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                      var now = new Date();
                      valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                    }


                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpformuladetalle"){
                     valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){
                    var now = new Date();
                    if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == "Y"){
                      valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                    }else{
                      valor_campo = now.format("Y-m-d");
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferencia"){
                    valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["predeterminado_valor"]
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                    valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpoperacion"){
                    valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpconsolidado"){
                    valor_campo = 0
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmparchivo"){
                    valor_campo = ""
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumeroaletras"){
                    valor_campo = ""
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpdecabecera"){
                    valor_campo = ""
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpelectronico"){
                    valor_campo = 0

                  }
                }else{
                  valor_campo = Response["valores_cab"][0][Response["campos_cab"][x]["Nombre"]] 

                  if(Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){

                    var now = new Date(Response["valores_cab"][0][Response["campos_cab"][x]["Nombre"]]);
                    if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == "Y"){
                      valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                    }else{
                      valor_campo = now.format("Y-m-d");
                    }
                    

                  }
              }

              ID_TAG = 'p' + Response["pestalla"] + 'zzz' + Response["campos_cab"][x]["Nombre"] + '';

              if (Response["campos_cab"][x]["Visible"] == "Y") {
  

                  div_c_t = Response["campos_cab"][x]["saltoweb"]
                  div_c_t = div_c_t + '<div class="col-sm-' + Response["campos_cab"][x]["largoweb"] + '">'
                  div_c_t = div_c_t + '<label class="control-label for="' + Response["campos_cab"][x]["Nombre"] + '" style="font-size: 11px;" >' + Response["campos_cab"][x]["Descripcion"] + '</label>'

                  if (Response["campos_cab"][x]["TablaCampo"] == "cmptxtsimple"){
                    readonly_int = ''
                    if (Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Modificable"] == "N"){readonly_int = 'readonly="readonly"'
                    }
                    if (tipo == 'Nuevo'){
                      valor_campo = Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["ValorPredeterminado"]
                    }
                      if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Largo"] > 100){
                         div_c_t = div_c_t + '<textarea type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' '+ readonly_int +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 45px;font-size: 11px;">'+ valor_campo +'</textarea>'
                      }else{
                          div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' '+ readonly_int +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                      }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsimple"){

                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' min="'+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Menor"] +'" max="'+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Mayor"] +'" onchange="guardar_calcular('+ ID_TAG +', 0 )" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'                    
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumsecuencial"){

                    div_c_t = div_c_t + '<input type="number" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpopcmultiple"){
                    if (tipo != 'consulta'){
                      div_c_t = div_c_t + '<select class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" id="'+ ID_TAG + '" value="'+ valor_campo +'" onchange="guardar_calcular('+ ID_TAG +' , 0)" style="height: 25px;font-size: 11px;">'

                      for (z = 0; z < Response["func_cab"][Response["campos_cab"][x]["Nombre"]].length; z++) { 

                        if(valor_campo == Response["func_cab"][Response["campos_cab"][x]["Nombre"]][z]["Valor"] )
                          {
                              div_c_t = div_c_t + '<option selected>' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][z]["Valor"] + '</option>'
                          }else{
                              div_c_t = div_c_t + '<option>' + Response["func_cab"][Response["campos_cab"][x]["Nombre"]][z]["Valor"] + '</option>'
                          }
                      }
                      div_c_t = div_c_t + '</select>'                        
                    }else{
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpsistema"){
                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
                    }

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                      div_c_t = div_c_t + '<input type="datetime-local" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpformuladetalle"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular('+ ID_TAG +' , 0 )" style="text-align: right;height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){
                    tipodato = 'date'
                 
                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tiempo"] == 'Y'){
                            tipodato = 'datetime-local'}
                    div_c_t = div_c_t + '<input type="' + tipodato + '" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferencia"){
                    div_c_t = div_c_t + '<div>'
                    


                    if (tipo != 'consulta'){
            
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["pkmodulo_ingreso"] !=0){
                            div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + (Response["campos_cab"][x]["largoweb"]-1) + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="width: 70%;height: 25px;font-size: 11px;" onkeypress="return runScript(event, '+ ID_TAG +')" >'
                            div_c_t = div_c_t + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_cabecera('+ ID_TAG +' )"style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>'
                       
                            
                            div_c_t = div_c_t + '<button type="button" class="btn btn-primary"  onclick="registro('+Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0][0]["pkmodulo_ingreso"]+',0,0,-1,0)" style="height: 25px;padding: 3px 4px;"><i class="fa fa-plus"></i></button>'
                        }else{
                            div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + (Response["campos_cab"][x]["largoweb"]-1) + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="width: 75%;height: 25px;font-size: 11px;" onkeypress="return runScript(event, '+ ID_TAG +')" >'
                            div_c_t = div_c_t + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_cabecera('+ ID_TAG +' )"style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>'

                        }

                    }else{
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + (Response["campos_cab"][x]["largoweb"]-1) + '" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;" onkeypress="return runScript(event, '+ ID_TAG +')" >'
                    }
                    
                    div_c_t = div_c_t + '</div>'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){

                    if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Imagen'){
                      div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +'  onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'

                    }
                    else{
                        Moddato = ''
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Modificable"] == 'N'){
                            Moddato = 'readonly="readonly"'}
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Texto'){

                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tamano"] == 'G'){

                         div_c_t = div_c_t + '<textarea type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' '+ Moddato +' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 45px;font-size: 11px;">'+ valor_campo +'</textarea>'

                        }else{
                          div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                        }


                        }
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Numero'){
                            div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="text-align: right;" style="height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'

                        }
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Fecha'){
                     
                            div_c_t = div_c_t + '<input type="date" id="'+ ID_TAG + '"class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                          }
                        if(Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Tipo"] == 'Fecha Tiempo'){
                      
                            div_c_t = div_c_t + '<input type="datetime-local" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular('+ ID_TAG +', 0 )" style="height: 25px;font-size: 11px;">'
                          }

                         
                    }
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpoperacion"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' onchange="setTwoNumberDecimal('+ Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Decimales"] +')" readonly="readonly" onchange="guardar_calcular('+ ID_TAG +', 0 )" style="text-align: right;height: 25px;font-size: 11px;" >'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpconsolidado"){
              
                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" onchange="guardar_calcular('+ ID_TAG +', 0)" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmparchivo"){

                   //div_c_t = div_c_t + '<input type="file" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' style="height: 25px;font-size: 11px;">'
                    div_c_t = div_c_t + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+ID_TAG +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank" style="font-size: 11px;"><img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+ID_TAG +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

                    div_c_t = div_c_t + '<label for="'+ID_TAG +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                    div_c_t = div_c_t + '<input type="file" id="'+ID_TAG +'_img_file" onchange="cambiar_imagen('+ ID_TAG +'_img)" style="display: none"></div></div>'


                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpnumeroaletras"){
             
                   div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpdecabecera"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                  }
                  if (Response["campos_cab"][x]["TablaCampo"] == "cmpelectronico"){

                    div_c_t = div_c_t + '<input type="text" id="'+ ID_TAG + '" class="form-control col-sm-' + Response["campos_cab"][x]["largoweb"] + '" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                  }
                  div_c_t = div_c_t + '</div>'
           

                if (Response["campos_cab"][x]["posicionweb"] == "arriba_izq") {
                  div_campos_arriba_izq = div_campos_arriba_izq + div_c_t
                }
                if (Response["campos_cab"][x]["posicionweb"] == "arriba_der") {
                  div_campos_arriba_der = div_campos_arriba_der + div_c_t
                }
                if (Response["campos_cab"][x]["posicionweb"] == "abajo_izq") {
                  div_campos_abajo_izq = div_campos_abajo_izq + div_c_t
                }
                if (Response["campos_cab"][x]["posicionweb"] == "abajo_der") {
                  div_campos_abajo_der = div_campos_abajo_der + div_c_t
                }


              }else{ 
                  div_campos = div_campos + '<input type="hidden" id="'+ ID_TAG + '" value="'+ valor_campo +'" '+ readonly +'>'
              }

               
            }
            div_campos = div_campos + '<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_arriba_izq + '</div></div>'
            div_campos = div_campos + '<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_arriba_der + '</div></div>'
            
            div_campos_arriba_der
            $('#rr' + Response["pestalla"]).append(div_campos);

            document.getElementById('id'+ Response["pestalla"]).click();




            if(typeof(Response["campos_det"]) == "object"){
                    var largo_tabla= 0
                    for (x = 0; x < Response["campos_det"].length; x++) {
                      if (Response["campos_det"][x]["Visible"] == "Y") {
                        largo_tabla = largo_tabla + parseFloat(Response["campos_det"][x]["largo"])
                        
                      }
                    }

                if (tipo == 'consulta'){ 
                    div_campos = '<div id="divtabla' + Response["pestalla"] + '" style="overflow: auto;overflow-y: auto;padding-top: 20px;"><table id="tabla' + Response["pestalla"] + '" class="table table-striped" style="width: ' + parseInt(largo_tabla) +   'px;overflow-x:auto;font-size: 11px;"><thead><tr>'
                  }else{
                    div_campos = '<div id="divtabla' + Response["pestalla"] + '" style="overflow: auto;overflow-y: auto;padding-top: 20px;"><table id="tabla' + Response["pestalla"] + '" class="table table-striped" style="width: ' + parseInt(largo_tabla) +   'px;overflow-x:auto;font-size: 11px;"><thead><tr><th style="width: 10px;"></th>'
                }
                 

                for (x = 0; x < Response["campos_det"].length; x++) { 
                  if (Response["campos_det"][x]["Visible"] == "Y") {
                    //div_campos = div_campos + '<th class="col-md-' + Response["campos_det"][x]["largoweb"] + '" style="width: ' + Response["campos_det"][x]["largo"] + 'px;">' + Response["campos_det"][x]["Descripcion"] + '</th>'
                    div_campos = div_campos + '<th class="col-md-' + Response["campos_det"][x]["largoweb"] + '" style="padding-left: 0px;padding-right: 0px;">' + Response["campos_det"][x]["Descripcion"] + '</th>'
                  } 
                }
                div_campos = div_campos +'</tr></thead><tbody>'
                var i = 0;
                do {
                    if (tipo == 'consulta'){ 
                        div_campos = div_campos + '<tr id="f' + Response["pestalla"] + '-f'+ i +'">'     
                    }else{
                        div_campos = div_campos + '<tr id="f' + Response["pestalla"] + '-f'+ i +'"><td><div class="row"  style="padding-left: 10px;">'
                        div_campos = div_campos + '<button type="button" onclick="mas(' + Response["pestalla"]+')" class="btn btn-success" style="padding: 3px 4px;">+</button>'
                        div_campos = div_campos + '<button type="button" onclick="menos(' + Response["pestalla"]+',' + i + ', 0)" class="btn btn-danger" style="padding: 3px 6px;">-</button></div></td>'
                    }

                    altura_mini = 45

                    for (x = 0; x < Response["campos_det"].length; x++) {

                        valor_campo = 0;
                        if (tipo == 'Nuevo'){
                            
                          if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
                            valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorPredeterminado"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){
                            valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsecuencial"){
                            if (Response["campos_det"][x]["TablaCampo"].slice(0,2) == "Pk"){
                              valor_campo = 0
                            }else{
                              valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorInicial"]
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpopcmultiple"){
                              valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Valor"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpsistema"){
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                              valor_campo = "{{usuario}}"

                            }
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
                              var now = new Date();
                              valor_campo = now.format("Y-m-d") + 'T' +  now.format("h:m:s")
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){
                             valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
                            var now = new Date();
                            addi = ' AM'
                            if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["Tiempo"] == "Y"){
                               if(now.format("H") > 11){addi = ' PM' }
                              valor_campo = now + addi
                            }else{
                              valor_campo = now.format("Y-m-d");
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
                            valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0][0]["predeterminado_valor"]
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                            valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){
                            valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
                            valor_campo = 0
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){
                            valor_campo = ""
                          }
                          }else{
                            valor_campo = Response["valores_det"][i][Response["campos_det"][x]["Nombre"]] 
                        }
                        
                        id_tag_detalle = 'pd' + Response["pestalla"] +  'fff'+ i + 'ccc'+ Response["campos_det"][x]["Nombre"]

                        if (Response["campos_det"][x]["Visible"] == "Y") {
                          //div_campos = div_campos + '<td><div class="col-sm-' + Response["campos_det"][x]["largoweb"] + '" col-md-' + Response["campos_det"][x]["largoweb"] + '" col-lg-' + Response["campos_det"][x]["largoweb"] + '">'
                          div_campos = div_campos + '<td style="padding-left: 0px;padding-right: 0px;"><div style="width: ' + Response["campos_det"][x]["largo"] + 'px;">'

                          if (Response["campos_det"][x]["TablaCampo"] == "cmptxtsimple"){
                              readonly_int = ''

                              if (Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == "N"){
                                readonly_int = 'readonly="readonly"'
                              }
                              if (tipo == 'Nuevo'){
                                valor_campo = Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["ValorPredeterminado"]
                              }
                              if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Largo"] > 100){
                                 div_campos = div_campos + '<textarea type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" ' + readonly_int + ' style="height: '+altura_mini+'px;font-size: 11px;">'+ valor_campo +'</textarea>'
                              }else{
                               div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" '+ readonly_int + ' style="height: 25px;font-size: 11px;">'
                              }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsimple"){

                              div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" min="'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Menor"] +'" max="'+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Mayor"] +'" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumsecuencial"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="text-align: right; height: 25px; font-size: 11px;" onkeypress="return solo_numero(event)">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpopcmultiple"){
                            if (tipo != 'consulta'){
                              div_campos = div_campos + '<select class="form-control" id="'+id_tag_detalle +'" value="'+ valor_campo +'" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                              for (z = 0; z < Response["func_det"][Response["campos_det"][x]["Nombre"]].length; z++) { 
                                if(valor_campo == Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] )
                                  {
                                      div_campos = div_campos + '<option selected>' + Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] + '</option>'
                                  }else{
                                      div_campos = div_campos + '<option>' + Response["func_det"][Response["campos_det"][x]["Nombre"]][z]["Valor"] + '</option>'
                                  }
                              }
                              div_campos = div_campos + '</select>'
                            }else{
                              div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;" >'
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpsistema"){
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Nombre"] == 'Usuario Actual'){
                              div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" style="height: 25px;font-size: 11px;">'
                            }
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["NumDecimales"] == 'Fecha Actual'){
                              div_campos = div_campos + '<input type="datetime-local" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpformuladetalle"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" readonly="readonly" onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpfecha"){
                            tipodato = 'date'
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tiempo"] == 'Y'){
                                    tipodato = 'datetime-local'}
                            div_campos = div_campos + '<input type="' + tipodato + '" id="'+id_tag_detalle +'"  class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferencia"){
                            
                            if (tipo == 'consulta'){ 
                              div_campos = div_campos + '<div class="input-group"><input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;" onkeypress="return runScript_detalle(event, '+ id_tag_detalle +')">'
                              div_campos = div_campos + '</div>'
                            }else{

                              div_campos = div_campos + '<div class="input-group"><input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="width: 70%;height: 25px;font-size: 11px;" onkeypress="return runScript_detalle(event, '+ id_tag_detalle +')">'
                              div_campos = div_campos + '<button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg" onclick="buscar_referencia_detalle('+ id_tag_detalle +' )" style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></button></div>'
                             }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                            if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Imagen'){

                              div_campos = div_campos + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+id_tag_detalle +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank"><img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+id_tag_detalle +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

                              altura_mini = 125

                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == 'N'){
                                    div_campos = div_campos + '</div></div>'

                                }else{
                                    div_campos = div_campos + '<label for="'+id_tag_detalle +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                                    div_campos = div_campos + '<input type="file" id="'+id_tag_detalle +'_img_file" onchange="cambiar_imagen('+ id_tag_detalle +'_img)" style="display: none"></div></div>'
                                }

                            }else{
                                Moddato = ''
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Modificable"] == 'N'){
                                    Moddato = 'readonly="readonly"'}
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Texto'){
                                  if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tamano"] == 'G'){
                                    div_campos = div_campos + '<textarea type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="font-size: 11px;height: '+ altura_mini +'px;">'+ valor_campo +'</textarea>'
                                  }else{
                                    div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                                  }
                                  
                                }
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Numero'){

                                    div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="text-align: right;height: 25px;font-size: 11px;" onkeypress="return solo_numero(event)">'
                                }
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Fecha'){

                                    div_campos = div_campos + '<input type="date" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                                  }
                                if(Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Fecha Tiempo'){

                                    div_campos = div_campos + '<input type="datetime-local" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' ' + Moddato + ' onchange="guardar_calcular_det('+ id_tag_detalle +')" style="height: 25px;font-size: 11px;">'
                                  }
                            }
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpoperacion"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' onchange="setTwoNumberDecimal('+ Response["func_det"][Response["campos_det"][x]["Nombre"]][0]["Decimales"] +')" readonly="readonly" style="text-align: right;height: 25px;font-size: 11px;"> '
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpconsolidado"){
                      
                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmparchivo"){

                           //div_campos = div_campos + '<input type="file" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' style="height: 25px;font-size: 11px;">'
                           div_campos = div_campos + '<div class="thumbnail" style="height: 125px;margin-bottom: 1px;"><div class="image view view-first"><a id="'+id_tag_detalle +'_label" href="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" target="_blank" style="font-size: 11px;"><img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+id_tag_detalle +'_img" src="/media/archivos/{{Id_empresa}}/'+ valor_campo +'" alt="image" value="'+ valor_campo +'">'+ valor_campo +'</a>'

                            div_campos = div_campos + '<label for="'+id_tag +'_img_file" class="btn btn-primary btn-block btn-outlined">Cambiar</label>'
                            div_campos = div_campos + '<input type="file" id="'+id_tag +'_img_file" onchange="cambiar_imagen('+ id_tag +'_img)" style="display: none"></div></div>'
                        
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpnumeroaletras"){
                     
                           div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpdecabecera"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }
                          if (Response["campos_det"][x]["TablaCampo"] == "cmpelectronico"){

                            div_campos = div_campos + '<input type="text" id="'+id_tag_detalle +'" class="form-control" value="'+ valor_campo +'" '+ readonly +' readonly="readonly" style="height: 25px;font-size: 11px;">'
                          }

                          div_campos = div_campos + '</div></td>'

                        } else {
                          div_campos = div_campos + '<input type="hidden" id="'+id_tag_detalle +'" value="' +valor_campo+ '" '+ readonly +'>'
                        } 
                    }

                    div_campos = div_campos + '</tr>'
                    i++;
                }while (i < Response["valores_det"].length);
            
              cc_porPesta['p-'+pestalla] = (Response["valores_det"].length )
              div_campos = div_campos + '</tbody></table></div>'
                           

              $('#rr' + pestalla).append(div_campos);
              
              if(Response["valores_det"].length > 3){
                document.getElementById('divtabla' + Response["pestalla"]).style.height = "500px";

              }

              $('#rr' + pestalla).append('<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_abajo_izq + '</div></div>');
              $('#rr' + pestalla).append('<div class="col-md-6 col-xs-12"> <div class="row">'+ div_campos_abajo_der + '</div></div>');
              

              document.getElementById('id'+ pestalla).click();
            }

            
            
            
            for (z2 = 0; z2 < Response["campos_cab"].length; z2++) { 
              if (tipo == 'Nuevo'){
                if(Response["campos_cab"][z2]["TablaCampo"] == "cmpreferencia"){
                  if(Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["predeterminado_valor"] != ''){
                    id_tag = 'p' + pestalla + 'zzz' + Response["campos_cab"][z2]["Nombre"]

                    if(Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["Tipo_Predeterminado"] == '1'){
                    id_tag_detalle_pret = 'p' + pestalla + 'zzz' + Response["func_cab"][Response["campos_cab"][z2]["Nombre"]][0][0]["predeterminado"] 
                      document.getElementById(id_tag).value = document.getElementById(id_tag_detalle_pret).value
                    }
                    buscar_referencia_cabecera_enter(document.getElementById(id_tag))
                  }
                }
              }
            }
             
            for (z2 = 0; z2 < Response["campos_det"].length; z2++) { 
              if (tipo == 'Nuevo'){
                if(Response["campos_det"][z2]["TablaCampo"] == "cmpreferencia"){
                  if(Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["predeterminado_valor"] != ''){
                    id_tag_detalle = 'pd' + Response["pestalla"] +  'fff'+ 0 + 'ccc'+ Response["campos_det"][z2]["Nombre"]
                    if(Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["Tipo_Predeterminado"] == '1'){
                      id_tag_detalle_pret = 'pd' + Response["pestalla"] +  'fff'+ 0 + 'ccc'+ Response["func_det"][Response["campos_det"][z2]["Nombre"]][0][0]["predeterminado"]
                      document.getElementById(id_tag_detalle).value = document.getElementById(id_tag_detalle_pret).value
                    }
                      buscar_referencia_detalle_enter(document.getElementById(id_tag_detalle))
                  }
                }
              }
            }

          }
        });     
}

function runScript_detalle(e, campo) {
    //See notes about 'which' and 'key'
    if (e.keyCode == 13) {
        buscar_referencia_detalle_enter(campo)
    }
    if (e.keyCode == 9) {
        buscar_referencia_detalle_enter(campo)
    }
    
}
function runScript(e, campo) {
    //See notes about 'which' and 'key'
    if (e.keyCode == 13) {
        buscar_referencia_cabecera_enter(campo)
    }
    if (e.keyCode == 9) {
        buscar_referencia_cabecera_enter(campo)
    }
    
}

function runScript_buscador_cab(e, id_campo_busc, pkcampo) {
    //See notes about 'which' and 'key'
    if (e.keyCode == 13) {
        filtrar_buscar(id_campo_busc, pkcampo)
    }
}


function runScript_buscador_rep(e, id_campo_busc, pkcampo) {
    //See notes about 'which' and 'key'
    if (e.keyCode == 13) {
        filtrar_buscar_rep(id_campo_busc, pkcampo)
    }
}

function runScript_buscador_det(e, id_campo_busc, pkcampo) {
    //See notes about 'which' and 'key'
    if (e.keyCode == 13) {
        filtrar_buscar_det(id_campo_busc, pkcampo)
    }
}

function buscar_referencia_cabecera_enter(campo){
  var cc_id = campo.id
  var res = cc_id.split("zzz");
  var cc_pesta = res[0].substring(1);
  var cc_nombre  = res[1]

  Response_int = dict_pestalla['p-'+cc_pesta]


  where = " "
  modo = Response_int["func_cab"][cc_nombre][0][0]["Modo"]
  columnas = Response_int["func_cab"][cc_nombre][0][0]["Columnas"]
  campo = Response_int["func_cab"][cc_nombre][0][0]["Sentencia"]
  dato = document.getElementById(cc_id).value
  tabla = Response_int["func_cab"][cc_nombre][0][0]["TablaOrigen"]
  orderby = " order by pk" + Response_int["func_cab"][cc_nombre][0][0]["TablaOrigen"] + " desc "


  for (x = 0; x <   Response_int["func_cab"][cc_nombre][1].length; x++) {   

    ElementoA = ""
    ElementoB = ""
    
    if(Response_int["func_cab"][cc_nombre][1][x]["TipoA"] == "R"){
      id_ext = 'p' + cc_pesta + 'zzz' + Response_int["func_cab"][cc_nombre][1][x]["ElementoA"] 
      ElementoA = "'" + document.getElementById(id_ext).value + "'"
    }
    if(Response_int["func_cab"][cc_nombre][1][x]["TipoA"] == "V"){
      ElementoA = "'" +Response_int["func_cab"][cc_nombre][1][x]["ElementoA"] + "'"
    }
    if(Response_int["func_cab"][cc_nombre][1][x]["TipoA"] == "C"){
      ElementoA = Response_int["func_cab"][cc_nombre][1][x]["ElementoA"]
    }

    if(Response_int["func_cab"][cc_nombre][1][x]["TipoB"] == "R"){
      id_ext = 'p' + cc_pesta + 'zzz' + Response_int["func_cab"][cc_nombre][1][x]["ElementoB"] 
      ElementoB = "'" + document.getElementById(id_ext).value + "'"
    }
    if(Response_int["func_cab"][cc_nombre][1][x]["TipoB"] == "V"){
      ElementoB = "'" + Response_int["func_cab"][cc_nombre][1][x]["ElementoB"] + "'"
    }
    if(Response_int["func_cab"][cc_nombre][1][x]["TipoB"] == "C"){
      ElementoB = Response_int["func_cab"][cc_nombre][1][x]["ElementoB"]
    }

    where = where + ElementoA + ' ' + Response_int["func_cab"][cc_nombre][1][x]["Operador"]  + ' ' + ElementoB +  ' and '
  }
  if (where == " "){where = ""}else{where = ' and ' + where.slice(0,-4)}

    cmpsenten = 'select ' + columnas + ' from ' + tabla + ' where ' + campo + ' like "' + dato + '%"' + where



        $.ajax({
          type: 'POST',
          url: '/buscador_auto_enter',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': cmpsenten, 'usuario':'{{usuario}}','cc_pesta':cc_pesta,'cc_nombre':cc_nombre,'cc_fila':0},
          success: function(Response_int){
   
            if(Response_int['cmpvalor'].length > 0){ 
              ID_TAG = 'p' + Response_int['cc_pesta'] + 'zzz' + Response_int['cc_nombre']

              document.getElementById(ID_TAG).value =  Response_int['cmpvalor'][0][dict_pestalla["p-"+Response_int['cc_pesta']]["func_cab"][Response_int['cc_nombre']][0][0]['Sentencia']]

              

              for (x = 0; x < dict_pestalla["p-"+Response_int['cc_pesta']]["campos_cab"].length; x++) {  
                if(dict_pestalla["p-"+Response_int['cc_pesta']]["campos_cab"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                  if(dict_pestalla["p-"+Response_int['cc_pesta']]["func_cab"][dict_pestalla["p-"+Response_int['cc_pesta']]["campos_cab"][x]["Nombre"]][0]["CampoReferencia"] == Response_int['cc_nombre']){

                    ID_TAG = 'p' + Response_int['cc_pesta'] + 'zzz' + dict_pestalla["p-"+Response_int['cc_pesta']]["campos_cab"][x]["Nombre"]


                    document.getElementById(ID_TAG).value = Response_int['cmpvalor'][0][dict_pestalla["p-"+Response_int['cc_pesta']]["func_cab"][dict_pestalla["p-"+Response_int['cc_pesta']]["campos_cab"][x]["Nombre"]][0]["Sentencia"]]



                  }
                }
              }
            }
            calcular_0(Response_int['cc_pesta'])

            var cc_id = 'p' + Response_int['cc_pesta'] + 'zzz' + Response_int['cc_nombre']
            var cc_pesta = Response_int['cc_pesta']
            var cc_nombre  =  Response_int['cc_nombre']

            //document.getElementById(campo.id).value = document.getElementById("vfinal_bus_2").value

            Response = dict_pestalla['p-'+cc_pesta]

            if(Response["func_cab"][cc_nombre][2].length > 0){
                if(Response["func_cab"][cc_nombre][2][0]["Adicionar_registros"] == "Si"){
                    if(Response["func_cab"][cc_nombre][2].length > 0){
                        if(Response["func_cab"][cc_nombre][2][0]["Adicionar_registros"] == "Si"){

      A_Select = "Select "
      A_From = "From "
      A_Where = "Where "
      A_Group = "Group by "
      A_GroupWhere = "Group by "
      sentencia = ""
      A_extra = ""
      FaltaDato = false

      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][0].length; x++) {
        A_extra = " " + Response["func_cab"][cc_nombre][3][0][0][x]["Elemento"] + " "
      }
      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][1].length; x++) {
        A_From = A_From + " " + Response["func_cab"][cc_nombre][3][0][1][x]["Tabla"] + " as " + Response["func_cab"][cc_nombre][3][0][1][x]["Nombre"] + ", "      
      }
      if(A_From == "From "){A_From = ""}else{A_From = A_From.slice(0,-2)}
      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][2].length; x++) {
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Valor"){
          A_Where = A_Where + " '" + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + "' "
        }
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Operacion"){
          A_Where = A_Where + " " + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + " "
        }
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Registro"){
          ID_TAG_where = 'p' + cc_pesta + 'zzz' + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"]
          if(document.getElementById(ID_TAG_where).value == ""){FaltaDato = true}
          A_Where = A_Where + " '" + document.getElementById(ID_TAG_where).value + "' "
        }
        if(Response["func_cab"][cc_nombre][3][0][2][x]["Tipo"] == "Campo"){
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="" ){
            A_Where = A_Where + " " + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + " "
          }
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="Suma" ){
            A_Where = A_Where + " Sum(" + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + ") "
            A_GroupWhere = A_GroupWhere + Response["func_cab"][cc_nombre][3][0][2][x]["Grupo"] + ", "
          }
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="Promedio" ){
            A_Where = A_Where + "Avg(" + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + ") "
            A_GroupWhere = A_GroupWhere + Response["func_cab"][cc_nombre][3][0][2][x]["Grupo"] + ", "
          }
          if(Response["func_cab"][cc_nombre][3][0][2][x]["Funcion"] =="Contar" ){
            A_Where = A_Where + "Count(" + Response["func_cab"][cc_nombre][3][0][2][x]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][2][x]["Elemento"] + ") "
            A_GroupWhere = A_GroupWhere + Response["func_cab"][cc_nombre][3][0][2][x]["Grupo"] + ", "
          }
        }
      }


      for (x = 0; x < Response["func_cab"][cc_nombre][3][0][3].length; x++) {

        A_Select = A_Select + "CAST( "
        for (x2 = 0; x2 < Response["func_cab"][cc_nombre][3][0][4][x].length; x2++) {
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Valor"){
            A_Select = A_Select + " '" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + "' "
          } 
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Operacion"){
            A_Select = A_Select + " " + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + " "
          } 
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Registro"){
            ID_TAG_selec = 'p' + cc_pesta + 'zzz' + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"]
            if(document.getElementById(ID_TAG_where).value == ""){FaltaDato = true}
            A_Select = A_Select + " '" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + "' "
          } 
          if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Tipo"] == "Campo"){
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == ""){
              A_Select = A_Select + " " + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + " "
            } 
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == "Suma"){
              A_Select = A_Select + " Sum(" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + ") "    
              if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] != ""){
                A_Group = A_Group + Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] + ", "
              }     
            } 
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == "Promedio"){
              A_Select = A_Select + " Avg(" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + ") "
              if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] != ""){
                A_Group = A_Group + Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] + ", "
              }
            } 
            if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["Funcion"] == "Contar"){
              A_Select = A_Select + " Count(" + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Origen"] + "." + Response["func_cab"][cc_nombre][3][0][4][x][x2]["Elemento"] + ") "
              if(Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] != ""){
                A_Group = A_Group + Response["func_cab"][cc_nombre][3][0][4][x][x2]["groupby"] + ", "
              }
            } 
          } 
        }
        A_Select = A_Select + " as char) as '" + Response["func_cab"][cc_nombre][3][0][3][x]["Nombre"] +  "', "
      }
      A_Select = A_Select.slice(0,-2)
      if(A_Group != "Group by "){
        A_Group = A_Group.slice(0,-2)
      }

      if(A_Group == "Group by "){
        if(A_GroupWhere == "Group by "){
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where
          }
        }else{
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From + " " + A_GroupWhere
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_GroupWhere
          }
        }
      }else{
        if(A_GroupWhere == "Group by "){
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From + " " + A_Group
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where + " " + A_Group
          }
        }else{
          if(A_Where == "Where "){
            sentencia = A_Select + " " + A_From + " " +  A_Group + ", " + A_GroupWhere.slice(8).ToString
          }else{
            sentencia = A_Select + " " + A_From + " " + A_Where + " " +  A_Group + ", " + A_GroupWhere.slice(8).ToString
          }
        }
      }



      $.ajax({
        type: 'POST',
        url: '/consolidado',
        data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': 'qC5JZVaMRSvI4W9QvAbw6lYxGQGceyzO3Ljxd16zxWGK1ujFu8JyTxMqz2KJpA04', 'Id_empresa':'mega','cmpsenten': sentencia,  'tag1': 'tag1', 'tag2': 'tag2', 'usuario':'Admin'},
        success: function(Response){

        if(Response["cmpvalor"].length > 0){

              for (xq = 0; xq < (cc_porPesta["p-" + cc_pesta]+2); xq++) {
                menos(cc_pesta, xq, 1)
              }
              linea_inicial = cc_porPesta["p-" + cc_pesta]

              for (xq = 0; xq < Response["cmpvalor"].length; xq++) {
                mas(cc_pesta)
                for (xq2 = 0; xq2 < Object.keys(Response['cmpvalor'][xq]).length; xq2++) {
                  id_tag_det = 'pd' + cc_pesta + 'fff' + cc_porPesta["p-" + cc_pesta] + 'ccc' + Object.keys(Response['cmpvalor'][xq])[xq2]     
                  if(dict_pestalla['p-' +cc_pesta]["func_det"][ Object.keys(Response['cmpvalor'][xq])[xq2]][0]["Tipo"] == "Imagen"){

                            inerhtml = '<img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+id_tag_det+'_img" src="/media/archivos/mega/'+ Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]+'" alt="image" value="0">' + Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]

                          document.getElementById(id_tag_det + "_label").innerHTML =  inerhtml  
                          document.getElementById(id_tag_det + "_label").href = '/media/archivos/mega/'+ Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]   
                        
                          document.getElementById(id_tag_det + "_img").src = '/media/archivos/mega/'+ Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]   




                  }else{
                    document.getElementById(id_tag_det).value  = Response['cmpvalor'][xq][Object.keys(Response['cmpvalor'][xq])[xq2]]   
                  }
                }
              }
            calcular_0(cc_pesta)
             for (xq = linea_inicial; xq < (cc_porPesta["p-" + cc_pesta]); xq++) {
                calcular_detalle(cc_pesta, xq+1)
              }
            calcular_0(cc_pesta)

        }


        } 
      });






                        }
                    }
                }
            }

          }
        });
}

function buscar_referencia_detalle_enter(campo){
  var cc_id = campo.id
  var res = cc_id.split("fff");
  var res2 = res[1].split("ccc");

  var cc_pesta = res[0].substring(2);
  var cc_fila = res2[0]
  var cc_nombre  = res2[1]
  calcular_detalle(cc_pesta, cc_fila)

  Response = dict_pestalla['p-'+cc_pesta]


  where = " "
  modo = Response["func_det"][cc_nombre][0][0]["Modo"]
  columnas = Response["func_det"][cc_nombre][0][0]["Columnas"]
  campo = Response["func_det"][cc_nombre][0][0]["Sentencia"]
  dato = document.getElementById(cc_id).value
  tabla = Response["func_det"][cc_nombre][0][0]["TablaOrigen"]
  orderby = " order by pk" + Response["func_det"][cc_nombre][0][0]["TablaOrigen"] + " desc "


  for (x = 0; x <   Response["func_det"][cc_nombre][1].length; x++) {   

    ElementoA = ""
    ElementoB = ""
    
    if(Response["func_det"][cc_nombre][1][x]["TipoA"] == "R"){
      id_ext = 'pd' + cc_pesta + 'fff' + cc_fila + 'ccc' + Response["func_det"][cc_nombre][1][x]["ElementoA"] 
      ElementoA = " '" + document.getElementById(id_ext).value + "' "
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoA"] == "V"){
      ElementoA = " '" +Response["func_det"][cc_nombre][1][x]["ElementoA"] + "' "
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoA"] == "C"){
      ElementoA = Response["func_det"][cc_nombre][1][x]["ElementoA"]
    }

    if(Response["func_det"][cc_nombre][1][x]["TipoB"] == "R"){
      id_ext = 'pd' + cc_pesta + 'fff' + cc_fila + 'ccc' + Response["func_det"][cc_nombre][1][x]["ElementoB"] 
      ElementoB = " '" + document.getElementById(id_ext).value + "' "
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoB"] == "V"){
      ElementoB = " '" + Response["func_det"][cc_nombre][1][x]["ElementoB"] + "' "
    }
    if(Response["func_det"][cc_nombre][1][x]["TipoB"] == "C"){
      ElementoB = Response["func_det"][cc_nombre][1][x]["ElementoB"]
    }

    where = where + ElementoA + ' ' + Response["func_det"][cc_nombre][1][x]["Operador"]  + ' ' + ElementoB +  ' and '
  }
  if (where == " "){where = ""}else{where = ' and ' + where.slice(0,-4)}

    cmpsenten = 'select ' + columnas + ' from ' + tabla + ' where ' + campo + ' like "' + dato + '%"' + where

        $.ajax({
          type: 'POST',
          url: '/buscador_auto_enter',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','cmpsenten': cmpsenten, 'usuario':'{{usuario}}','cc_pesta':cc_pesta,'cc_nombre':cc_nombre,'cc_fila':cc_fila},
          success: function(Response_int){

            if(Response_int['cmpvalor'].length > 0){ 

              temp_int = dict_pestalla["p-"+Response_int['cc_pesta']]

              ID_TAG = 'pd' + Response_int['cc_pesta'] + 'fff' + Response_int['cc_fila'] + 'ccc' + Response_int['cc_nombre']

              document.getElementById(ID_TAG).value =  Response_int['cmpvalor'][0][temp_int["func_det"][Response_int['cc_nombre']][0][0]['Sentencia']]

                anexosbt = []

              for (x = 0; x < temp_int["campos_det"].length; x++) {  
                if(temp_int["campos_det"][x]["TablaCampo"] == "cmpreferenciaadjunto"){
                  if(temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["CampoReferencia"] == cc_nombre){

                    ID_TAG = 'pd' + Response_int['cc_pesta'] + 'fff' + Response_int['cc_fila'] + 'ccc' + temp_int["campos_det"][x]["Nombre"]

                    if(temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["Tipo"] == 'Imagen'){

                        inn_html = '<img style="width: 100%;height: 60%;margin-left: auto;margin-right: auto; display: block;" id="'+ID_TAG+'_img" src="/media/archivos/{{Id_empresa}}/'+Response_int['cmpvalor'][0][temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["Sentencia"]]+'" alt="image" value="0">' + Response_int['cmpvalor'][0][temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["Sentencia"]]


                      document.getElementById(ID_TAG + "_label").innerHTML = inn_html
                      document.getElementById(ID_TAG + "_label").href = '/media/archivos/{{Id_empresa}}/'+ Response_int['cmpvalor'][0][temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["Sentencia"]] 
                    
                      document.getElementById(ID_TAG + "_img").src = '/media/archivos/{{Id_empresa}}/'+ Response_int['cmpvalor'][0][temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["Sentencia"]]

                    }else{
                      document.getElementById(ID_TAG).value = Response_int['cmpvalor'][0][temp_int["func_det"][temp_int["campos_det"][x]["Nombre"]][0]["Sentencia"]]
                      
                      

                    for (z2 = 0; z2 < temp_int["campos_det"].length; z2++) { 
                      if(temp_int["campos_det"][z2]["TablaCampo"] == "cmpreferencia"){
                        if(temp_int["func_det"][temp_int["campos_det"][z2]["Nombre"]][0][0]["predeterminado_valor"] == temp_int["campos_det"][x]["Nombre"]){
                          document.getElementById('pd' + Response_int['cc_pesta'] +  'fff'+ Response_int['cc_fila'] + 'ccc'+ Response["campos_det"][z2]["Nombre"]).value = document.getElementById(ID_TAG).value
                          anexosbt.push('pd' + Response_int['cc_pesta'] +  'fff'+ Response_int['cc_fila'] + 'ccc'+ Response["campos_det"][z2]["Nombre"])
                        }
                      }
                    }



                
                    }

                  }
                }
              } 
              calcular_detalle(Response_int['cc_pesta'], Response_int['cc_fila'])

              for (zt = 0; zt < anexosbt.length; zt++) {  
                 buscar_referencia_detalle_enter(document.getElementById(anexosbt[zt]))
              }


            }

          } 
        });
}

//function filtrar(PkModulo, eliminar, modifica, pestana_int, tablaDescripcion) {

function filtrar(pestana_int) {

        Response = dict_pestalla['p-' + pestana_int]

        v_where_valor= document.getElementById('valor' + pestana_int).value;
        v_top= document.getElementById('top' + pestana_int).value;
        v_campo= document.getElementById('campo' + pestana_int).value;


        $.ajax({
          type: 'POST',
          url: '/menu_filtro',
          data: {'fuente': 'filtro', 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'tablaDescripcion': Response["tabla"][0]["Descripcion"], 'pestana_int':pestana_int, 'PkModulo':Response["tabla"][0]["PkModulo"], 'v_tabla':Response["tabla"][0]["Nombre"], 'v_where_valor':v_where_valor, 'eliminar':Response["eliminar"], 'modifica':Response["modifica"], 'v_top':v_top, 'v_campo':v_campo, 'campos':JSON.stringify(Response["names"])},
          success: function(Response){
            ResFijo = dict_pestalla['p-' + Response["pestana_int"]]

            largo_tablaPX = 0
              for (x = 0; x < Response["dbdatos"][0].length; x++) {
                largo_tablaPX = largo_tablaPX + 150 
              }


            new_tab = '<table id="datatable-checkbox" width="100%" class="table table-striped table-bordered bulk_action" style="overflow-x:auto;width: '+ largo_tablaPX +'px; font-size: 11px;"><thead><tr><th style="width: 80px;">{{idioma_html.Acciones}}</th>'

 
            for (x = 1; x < Response["dbdatos"][0].length; x++) { 

              new_tab = new_tab +'<th>'+Response["dbdatos"][0][x][0]+'</th>'

            }
            new_tab = new_tab +'</tr></thead><tbody>'

            for (x = 0; x < Response["dbdatos"][1].length; x++) { 

              new_tab = new_tab +'<tr id="f'+ResFijo["tabla"][0]["PkModulo"] +'-f'+Response["dbdatos"][1][x][0]+'"><td><div class="row">'
              if(ResFijo["modifica"] == "Si"){   
                new_tab = new_tab +'<a class="btn btn-success" onclick="registro('+ResFijo["tabla"][0]["PkModulo"] +','+Response["dbdatos"][1][x][0]+',1, '+Response["pestana_int"]+',0)" style="padding: 2px 2px; margin-right: 0px; margin-left: 5px;"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a>'
              }
              if(ResFijo["eliminar"] == "Si"){
                new_tab = new_tab +'<a class="btn btn-danger" onclick="eliminar('+ResFijo["tabla"][0]["PkModulo"] +','+Response["dbdatos"][1][x][0]+')" style="padding: 2px 2px; margin-right: 0px; margin-left: 0px;"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></a>'
              }

              new_tab = new_tab +'<button class="btn btn-primary" onclick="registro('+ResFijo["tabla"][0]["PkModulo"] +','+Response["dbdatos"][1][x][0]+',2,'+Response["pestana_int"]+',0)" style="padding: 2px 2px; margin-right: 0px; margin-left: 0px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button></div></td>'
             
              for (x2 = 1; x2 < Response["dbdatos"][0].length; x2++) { 

                //new_tab = new_tab +'<td>'+Response["dbdatos"][1][x][x2]+'</td>'

            modifica_campo = 'No'
                 if(ResFijo["modifica"] == "Si"){
              for (x3 = 1; x3 < ResFijo["estru"].length; x3++) { 
                if(ResFijo["estru"][x3]["Nombre"] == Response["dbdatos"][0][x2][0]){
                    if(ResFijo["estru"][x3]["Modificable"] == 'Si'){
                        modifica_campo = 'Si'
                    }
                }
              }

                if(modifica_campo == 'Si' && '{{Es_admin}}' == 'Y' ){
                    id_tag_int = 'md'+ ResFijo["pestalla"] +'zzz'+Response["dbdatos"][0][x2][0]+'jjj'+Response["dbdatos"][1][x][0]
                        new_tab = new_tab + '<td><input type="text" id="'+ id_tag_int +'" class="form-control" value="' + Response["dbdatos"][1][x][x2] +'" onkeypress="return runScript_modi_fast(event, ' + id_tag_int +')" style="font-size: 11px; height: 25px;"></td>'
                }else{
                  id_tag_int = 'md'+ ResFijo["pestalla"] +'zzz'+Response["dbdatos"][0][x2][0]+'jjj'+Response["dbdatos"][1][x][0]
                        new_tab = new_tab +'<td>'+Response["dbdatos"][1][x][x2]+'</td>'

                }

                    
                


                  }else{
                    new_tab = new_tab +'<td>'+Response["dbdatos"][1][x][x2]+'</td>'
                  }
 
              }

              new_tab = new_tab +'</tr>'

            }
              new_tab = new_tab +'</tbody></table>'


            $('#tabla' + Response["pestana_int"]).html(new_tab);

          }
          });
}

function verificar_validar_registro(pestana_int) {
    calcular_0(pestana_int)

  Response = dict_pestalla['p-' + pestana_int]
  valio = false
  valiodet = false
  
  if(Response["validaciones"].length >0){
    for (x = 0; x < Response["validaciones"][0].length; x++) {
      valorA = 0 
      ValorB = 0
      if(Response["validaciones"][0][x]["EstadoA"] == "C"){
        valorA = document.getElementById('p' + pestana_int + 'zzz' + Response["validaciones"][0][x]["ElementoA"]).value
      }else{
        valorA = Response["validaciones"][0][x]["ElementoA"]
      }
      if(Response["validaciones"][0][x]["EstadoB"] == "C"){
        valorB = document.getElementById('p' + pestana_int + 'zzz' + Response["validaciones"][0][x]["ElementoB"]).value
      }else{
        valorB = Response["validaciones"][0][x]["ElementoB"]
      }      
      if(Response["validaciones"][0][x]["Operador"] == "="){if(valorA != valorB){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}
      if(Response["validaciones"][0][x]["Operador"] == ">"){if(parseFloat(valorA) <= parseFloat(valorB)){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}
      if(Response["validaciones"][0][x]["Operador"] == "<"){if(parseFloat(valorA) >= parseFloat(valorB)){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}
      if(Response["validaciones"][0][x]["Operador"] == "=>"){if(parseFloat(valorA) < parseFloat(valorB)){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}
      if(Response["validaciones"][0][x]["Operador"] == "=<"){if(parseFloat(valorA) > parseFloat(valorB)){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}
      if(Response["validaciones"][0][x]["Operador"] == "Igual"){
        if(valorB =="Obligatorio"){
          if(valorA.length == 0){
            valio = true
            alert(Response["validaciones"][0][x]["Mensaje"])            
          }
        }else{
          if(valorA != valorB){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}
        }
      }
      if(Response["validaciones"][0][x]["Operador"] == "!="){if(valorA == valorB){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}
      if(Response["validaciones"][0][x]["Operador"] == "No Igual"){if(valorA == valorB){
        valio = true
        alert(Response["validaciones"][0][x]["Mensaje"])}}

    }
  }

  if(Response["validaciones"].length >1){

    for (x = 0; x < Response["validaciones"][1].length; x++) {
      for (x2 = 0; x2 < (cc_porPesta['p-' + pestana_int] + 1 ); x2++) { 
        tagA = 'pd' + pestana_int + 'fff'+ x2 +'ccc' + Response["validaciones"][1][x]["ElementoA"]
        tagB = 'pd' + pestana_int + 'fff'+ x2 +'ccc' + Response["validaciones"][1][x]["ElementoB"]
        tagver = 'pd' + pestana_int + 'fff'+ x2 +'ccc' + Response["campos_det"][1]["Nombre"]
        if (document.getElementById(tagver) != null){
          valorA = 0 
          valorB = 0
          if(Response["validaciones"][1][x]["EstadoA"] == "C"){

            valorA = document.getElementById(tagA).value
          }else{
            valorA = Response["validaciones"][1][x]["ElementoA"]
          }
          if(Response["validaciones"][1][x]["EstadoB"] == "C"){
            valorB = document.getElementById(tagB).value
          }else{
            valorB = Response["validaciones"][1][x]["ElementoB"]
          }
          if(Response["validaciones"][1][x]["Operador"] == "="){
                if(valorB == 'unico'){
                    contador_A =0
                  for (z2 = 0; z2 < (cc_porPesta['p-' + pestana_int] + 1 ); z2++) {
                    tagX = 'pd' + pestana_int + 'fff'+ z2 +'ccc' + Response["validaciones"][1][x]["ElementoA"]
                    if(document.getElementById(tagX) != null){
                        if(valorA == document.getElementById(tagX).value){contador_A = contador_A +1 }
                    }
                  }
                    if (contador_A >1){
                        valiodet = true
                        alert(Response["validaciones"][1][x]["Mensaje"])
                    } 
                }else{
                    if(valorA != valorB){
                    valiodet = true
                    alert(Response["validaciones"][1][x]["Mensaje"])}
                }

            }
          if(Response["validaciones"][1][x]["Operador"] == ">"){if(parseFloat(valorA) <= parseFloat(valorB)){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
          if(Response["validaciones"][1][x]["Operador"] == "<"){if(parseFloat(valorA) >= parseFloat(valorB)){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
          if(Response["validaciones"][1][x]["Operador"] == ">="){if(parseFloat(valorA) < parseFloat(valorB)){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
          if(Response["validaciones"][1][x]["Operador"] == "<="){if(parseFloat(valorA) > parseFloat(valorB)){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
          if(Response["validaciones"][1][x]["Operador"] == "Igual"){if(valorA != valorB){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
          if(Response["validaciones"][1][x]["Operador"] == "!="){if(valorA == valorB){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
          if(Response["validaciones"][1][x]["Operador"] == "No Igual"){if(valorA == valorB){
            valiodet = true
            alert(Response["validaciones"][1][x]["Mensaje"])}}
        }
      }
    }    
  } 
  if(valiodet == false && valio == false){    
    return true
  }else{
    return false 
  }
}

function validar_registro(pestana_int){
    calcular_0(pestana_int)
    if(verificar_validar_registro(pestana_int) == true ){
        alert("Validado")
    }
}

function grabar_elemento(pestana_int, disparador){
    calcular_0(pestana_int)

  if(verificar_validar_registro(pestana_int) == true ){
    Response = dict_pestalla['p-' + pestana_int]
    disparador_real = ""
    if(disparador == 0){disparador_real = "Guardar Registro Nuevo"}
    if(disparador == 1){disparador_real = "Modificar Registro"}

    envio_archi = []
    envio_datset = {}
    array_cab = []
    array_det= []
    array_subdet = []
    autorizacion = [0,0]
    ingreso_cab = {}
    tiene_detalle = 'Si'
    electro = ''

    for (x = 0; x < Response["campos_cab"].length; x++) {
      tag_campo = "p" + pestana_int + "zzz" + Response["campos_cab"][x]["Nombre"]
    
        if(document.getElementById(tag_campo) == null){
              ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  ''
      }else{
              ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  document.getElementById(tag_campo).value
      }
        if(Response["campos_cab"][x]["TablaCampo"] == "cmpfecha"){
        var d = new Date(document.getElementById(tag_campo).value),
            month = '' + (d.format('m')),
            day = '' + d.format('d'),
            year = d.format('Y');
        ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  [year, month, day].join('-');
        }
        if(Response["campos_cab"][x]["TablaCampo"] == "cmpsistema" && Response["func_cab"][Response["campos_cab"][x]["Nombre"]][0]["Nombre"] == 'Fecha Actual'){
            var d = new Date(document.getElementById(tag_campo).value)
            month = '' + (d.format('m'))
            day = '' + d.format('d')
            year = d.format('Y')
            hora = d.getHours()
            minutos = d.getMinutes()
            segundos = d.getSeconds()

            

            if (hora.length < 2) hora = '0' + hora
            if (minutos.length < 2) minutos = '0' + minutos
            if (segundos.length < 2) segundos = '0' + segundos

            ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  year + '-' + month+ '-' + day + ' ' + hora + ':' + minutos+ ':' + segundos

        ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  [year, month, day].join('-');
        }
        if(Response["campos_cab"][x]["TablaCampo"] == "cmparchivo"){
          tag_campo = "p" + pestana_int + "zzz" + Response["campos_cab"][x]["Nombre"] + "_img_file"
          if(document.getElementById(tag_campo).value != null){
            if(document.getElementById(tag_campo).value != ""){
                envio_archi.push(tag_campo)
                ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  document.getElementById(tag_campo).files[0].name
            }else{
            tag_campo_img = "p" + pestana_int + "zzz" + Response["campos_cab"][x]["Nombre"] + "_img"

            ingreso_cab[Response["campos_cab"][x]["Nombre"]] =  document.getElementById(tag_campo_img).getAttribute("value")
          }
          }
        }
        if(Response["campos_cab"][x]["TablaCampo"] == "cmpelectronico"){
        electro =  Response["campos_cab"][x]["Nombre"]
        //ingreso_cab[Response["campos_cab"][x]["Nombre"]] = devolver_clave_acceso(pestana_int, electro, array_cab, array_det)
        }

    }
    array_cab.push(ingreso_cab)
    envio_datset[Response["tabla_cab"]["Nombre"]] = array_cab 
    if(Response["tabla_det"] != 0){
      for (x = 0; x < (cc_porPesta['p-' + pestana_int] + 1 ); x++) { 
        ingreso_det= {}
        if(document.getElementById("pd" + pestana_int + "fff"+ x +"ccc" + Response["campos_det"][0]["Nombre"]) != null)
        {
          for (x2 = 0; x2 < Response["campos_det"].length; x2++) {

            if(Response["campos_det"][x2]["TablaCampo"] == "cmparchivo"){
              tag_campo = "pd" + pestana_int + "fff"+ x +"ccc" + Response["campos_det"][x2]["Nombre"]
              ingreso_det[Response["campos_det"][x2]["Nombre"]] =  document.getElementById(tag_campo).value
            
              envio_archi.push(tag_campo)
            }else{
              if(Response["campos_det"][x2]["TablaCampo"] == "cmpreferenciaadjunto" && Response["func_det"][Response["campos_det"][x2]["Nombre"]][0]["Tipo"] == 'Imagen' ){
                tag_campo = "pd" + pestana_int + "fff"+ x +"ccc" + Response["campos_det"][x2]["Nombre"] + '_label'
                tag_campo_file = "pd" + pestana_int + "fff"+ x +"ccc" + Response["campos_det"][x2]["Nombre"] + '_img_file'
                var cc_1 = document.getElementById(tag_campo)
                var cc_2 = document.getElementById(tag_campo_file)
                if(cc_2.files.length > 0 ){
                    if(cc_1.innerHTML == cc_2.files[0].name){
                        ingreso_det[Response["campos_det"][x2]["Nombre"]] =  cc_1.text
                    }else{
                        ingreso_det[Response["campos_det"][x2]["Nombre"]] =  cc_2.files[0].name
                        envio_archi.push(tag_campo_file)
                    }
                }else{
                        ingreso_det[Response["campos_det"][x2]["Nombre"]] =  cc_1.text                    
                }




              }else{
                tag_campo = "pd" + pestana_int + "fff"+ x +"ccc" + Response["campos_det"][x2]["Nombre"]
                ingreso_det[Response["campos_det"][x2]["Nombre"]] =  document.getElementById(tag_campo).value
            
              }

           
            }
          }
        array_det.push(ingreso_det)
        }
      }
      envio_datset[Response["tabla_det"]["Nombre"]] = array_det 
    }else{
      tiene_detalle = 'No'
      ingreso_det = 0
    }

    ingreso_subdet = {}
    if(Response["tabla_subdet"] != 0){ingreso_subdet = 0}else{ingreso_subdet = 0}
    pestana_pasa_grabar = pestana_int


    for (x2 = 0; x2 < envio_archi.length; x2++) {
        

          const files = document.getElementById(envio_archi[x2]).files
          const formData = new FormData()
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')
            formData.append('Id_empresa','{{Id_empresa}}')
            formData.append('id_archivo',envio_archi[x2])

          for (let i = 0; i < files.length; i++) {
            let file = files[i]

            formData.append('files', file)
          }

          fetch('/archi_carg', {method: 'POST',body: formData,}).then(response => {
            console.log(response)

        })
    }
    



    if(electro!=''){
        //document.getElementById('btn_grabar').click();
        //autorizacion = firma_electronica(pestana_int, electro, array_cab, array_det)
    }
    div_grab = document.getElementById("div_grabador")
    div_grab.innerHTML = ''
    $.ajax({
      type: 'POST',
      url: '/regis_guardar',
      data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'tiene_detalle':tiene_detalle, 'Id_empresa':'{{Id_empresa}}','nom_tabla':Response["tabla_cab"]["Nombre"], 'disparador':disparador_real, 'pkmodulo':Response["tabla_cab"]["PkModulo"], 'array_cab': JSON.stringify(array_cab),'array_det': JSON.stringify(array_det),'array_subdet': JSON.stringify(array_subdet), 'usuario':'{{usuario}}', 'campos_cab':JSON.stringify(Response["campos_cab"]), 'campos_det':JSON.stringify(Response["campos_det"]), 'campos_subdet':JSON.stringify(Response["campos_subdet"]), 'envio_datset':JSON.stringify(envio_datset),'pestalla':pestana_int, 'autorizacion':autorizacion[0], 'clave_acc':autorizacion[1], 'tablaDatos':JSON.stringify(Response["tabla_cab"])},
      success: function(Response){
   
        if(Response["grabo"] == true){
          registro(Response["pkmodulo"], Response["pkregistro"],2, Response["pestalla"],1)
          cerrar_elemento( Response["pestalla"])
          document.getElementById('id'+ pestalla).click();
          document.getElementById('cerrar_grabar').click();


        }else{
            mensaje = ''
            for (x2 = 0; x2 < Object.keys(Response["msg"]).length; x2++) {
                mensaje = mensaje + '-'+ Object.keys(Response["msg"])[x2] +': ' + Response["msg"][Object.keys(Response["msg"])[x2]] + '<br>'
            }
            div_grab = document.getElementById("div_grabador")
            div_grab.innerHTML = mensaje
        }
      }
    });
  }
}


function eliminar(pkmodulo,pkregistro ) {
    var mensaje;
    var opcion = confirm("{{idioma_html.msg_eliminar}}");
    if (opcion == true) {
        mensaje = "{{idioma_html.eliminado}}";
        $('#f' +pkmodulo + '-f'+ pkregistro ).remove();

        $.ajax({
          type: 'POST',
          url: '/menu_eliminar',
          data: {'fuente': $(this).attr("value"), 'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}','pkregistro': pkregistro, 'pkmodulo':pkmodulo, 'usuario':'{{usuario}}'},
          success: function(Response){}
        });
    }else {
        mensaje = "{{idioma_html.cancelado}}";
    }
}


function pdf_elemento(pestana_int){
    Response = dict_pestalla['p-' + pestana_int]

    if(Response["plantilla_pdf"]["plantillasMain"].length == 0){

    }else{
      if(Response["plantilla_pdf"]["plantillasMain"].length == 1){
        ind_pla = 0
      }
      ind_pla = 0
      var doc = new jsPDF('p', 'cm', [parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Largo"]), parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Ancho"])]);

      doc.setFontSize(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Letra"]);
    }
      
    var Vpkplantilla = Response["plantilla_pdf"]["plantillasMain"][ind_pla]["PkPlantilla"]


    for (z = 0; z < Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla].length; z++){ 
      if(Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla][z]["Tipo"] == "Cabecera"){
        seg_cab = Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla][z]
      }    
      if(Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla][z]["Tipo"] == "Detalle"){
        seg_det = Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla][z]
      }    
      if(Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla][z]["Tipo"] == "Pie"){
        seg_pie = Response["plantilla_pdf"]["plantillassegmentos"][Vpkplantilla][z]
      }    
    }
     

    //cab
    //etiquetas
    var altura_ini = seg_cab["AlturaInicial"]

    for (z = 0; z < Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]].length; z++) {
      if(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["TipoLetra"] == "Logo"){


              imagen = document.getElementById("logo_cia")
              tipo = imagen.attributes["value"]["value"].split('.')
              tamano = Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Tamano"].split(',')
              var imgData = getBase64Image(imagen,tamano[0] * 37,tamano[1] * 37)
              try {
                doc.addImage(imgData, tipo[1].toUpperCase(), parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Y"]), parseFloat(tamano[0]) , parseFloat(tamano[1]) )                }
                catch(error) {
                  console.error(error);
                  // expected output: ReferenceError: nonExistentFunction is not defined
                  // Note - error messages will vary depending on browser
                }

              


      }else{
        if(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["TipoLetra"] == "grafico"){

              tamano = Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Tamano"].split(',')
              datos  = Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Nombre"].split(',')
                
              if (datos[0]=="cuadrado"){

            
              doc.setDrawColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))
              doc.setFillColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))

              p_x=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["X"])
              p_y=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Y"])

                doc.rect(p_x ,p_y ,  parseFloat(tamano[1]) , parseFloat(tamano[0]) , 'F')

              }
             if (datos[0]=="cuadrado_cir"){

                  doc.setDrawColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))
                  doc.setFillColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))

                  p_x=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["X"])
                  p_y=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Y"])

                 
                  doc.roundedRect(p_x ,p_y ,  parseFloat(tamano[1]) , parseFloat(tamano[0]) ,0.3,0.3, 'FD')

                }
      
              doc.setDrawColor(0, 0, 0)
              doc.setFillColor(0, 0, 0)


        }else{
          doc.setFontSize(parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Tamano"]))
          doc.setFont("helvetica");
          doc.setFontStyle(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["TipoLetra"]);

          doc.text(parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Y"]) + parseFloat(altura_ini), Response["plantilla_pdf"]["plantillasetiquetas"][seg_cab["PkSegmento"]][z]["Nombre"]);
        }
      }
    }  
    for (z = 0; z < Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]].length; z++) { 
      var valor = Response["valores_cab"][0][Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Campo"]].toString()
     
      valor = devolver_valor_imp(valor, Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Tipo"], Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Ext"])

      if(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Tipo"] == 'Derecha'){
        doc.text(parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Y"]) + parseFloat(altura_ini), valor.toString() , 'right');
      }else{
        if(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Tipo"] == 'Color'){
          datos_forma = Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Ext"].split(',')
          doc.setTextColor(parseFloat(datos_forma[0]), parseFloat(datos_forma[1]), parseFloat(datos_forma[2]));
          doc.setFontSize(parseFloat(datos_forma[3]))

          doc.text(parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Y"]) + parseFloat(altura_ini), valor.toString() );

          doc.setTextColor(0, 0, 0);
          doc.setFontSize(10);


        }else{
          doc.setFontSize(10);
          doc.setFontStyle("normal");

            var lines =doc.splitTextToSize(valor.toString(), (parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["limite"])*0.2));
            //var lines =doc.splitTextToSize(valor, 2);
            //doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), linea , lines)
            var new_lines = []
            for (cv = 0; cv < lines.length; cv++) {
                if(lines[cv] != ''){
                    new_lines.push(lines[cv])
                } 
            }


          doc.text(parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_cab["PkSegmento"]][z]["Y"]) + parseFloat(altura_ini), new_lines );
        }
      }
    }  





    var linea = parseFloat(seg_det["AlturaInicial"])

    //detallecab

      //doc.setDrawColor(192, 192, 192)
      //doc.setFillColor(192, 192, 192)
      //doc.roundedRect(5, 20, 10, 10, 4, 4, 'FD')
      
      
      //doc.roundedRect(0.5 ,linea-0.5, parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Ancho"])-1.5 ,0.7,0.3,0.3, 'FD')
      doc.setDrawColor(0, 0, 0)

    for (z = 0; z < Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]].length; z++) { 
      doc.setFontStyle("bold");
      if(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Tipo"] == 'Derecha'){
        doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), linea, Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Cabecera"], 'right')
      }else{
        doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), linea, Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Cabecera"])
      }
    }
        doc.setFillColor(0, 0, 0)

      doc.setFont("helvetica");
      doc.setFontStyle("normal");
      doc.setFontSize(9);

    //detalle datos
    var line_add = 0
    for (z2 = 0; z2 < Response["valores_det"].length; z2++) { 
      linea = linea + 1 + line_add
      line_add =0

      if(linea > ( parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Largo"]) - 3)){
        doc.addPage('p', 'cm', [parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Largo"]), parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Ancho"])]);
        linea = 2
      }
      for (z = 0; z < Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]].length; z++) { 
        var txt = Response["valores_det"][z2][Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Campo"]]

        var valor =  txt.toString()   
        valor = devolver_valor_imp(valor, Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Tipo"], Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"])

        if(valor.length > parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Limite"]) && Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Tipo"] != 'Imagen'){
//          valor = devolver_str_limte(valor, parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Limite"]))
//          for (s = 0; s < valor.length; s++) {
//            doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), linea + (0.5 * s), valor[s])
//          }
//          if(valor.length * 0.5 > line_add){
//            line_add = (valor.length * 0.5)
//          }

            var lines =doc.splitTextToSize(valor, (parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Limite"])*0.2));
            //var lines =doc.splitTextToSize(valor, 2);
            doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), linea , lines)

            if(lines.length * 0.4 > line_add){
                line_add = (lines.length * 0.4)
            }



        }else{
          if(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Tipo"] == 'Derecha'){
            
            doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"])+ (parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Limite"]) * 0.02), linea, valor, 'right')
          }else{
          if(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Tipo"] == 'Imagen'){
   
              var tag = 'pd'+pestana_int+'fff'+ z2 +'ccc'+ Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Campo"] +'_img'
              imagen = document.getElementById(tag)

              tipo = imagen.attributes["value"]["value"].split('.')

              var imgData = getBase64Image(imagen,parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"]) * 37,parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"]) * 37)
                      

                try {
                    doc.addImage(imgData, tipo[1].toUpperCase(), parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), parseFloat(linea-0.5), parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"]), parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"]) )
                }
                catch(error) {
                  console.error(error);
                  // expected output: ReferenceError: nonExistentFunction is not defined
                  // Note - error messages will vary depending on browser
                }


              if(line_add < parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"]) ){

                line_add = parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["Ext"]  )  //2
              }
            }else{
            doc.text(parseFloat(Response["plantilla_pdf"]["plantillascampos"][seg_det["PkSegmento"]][z]["X"]), linea, valor)
          }
        }
      }
    }
  }

        linea = linea + 1 + line_add

    //pie
    if(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["AutoImpreso"] == 'Si'){

        ultima_y = 0
    for (z = 0; z < Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]].length; z++) {
        if(ultima_y < parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Y"])){
            ultima_y = parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Y"])
        }
    }

        if((linea + ultima_y ) > parseInt(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Largo"]) ){
            doc.addPage('p', 'cm', [parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Largo"]), parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Ancho"])]);
            linea = 2
        }
    }else{    
        if(linea >= parseFloat(seg_pie["AlturaInicial"])){
        doc.addPage('p', 'cm', [parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Largo"]), parseFloat(Response["plantilla_pdf"]["plantillasMain"][ind_pla]["Ancho"])]);
        }
        linea = parseFloat(seg_pie["AlturaInicial"])
    }




    for (z = 0; z < Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]].length; z++) { 
      //doc.text(parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea), Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Nombre"]);
    

            if(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["TipoLetra"] == "grafico"){

                  tamano = Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Tamano"].split(',')
                  datos  = Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Nombre"].split(',')
                    
                  if (datos[0]=="cuadrado"){

                    doc.setDrawColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))
                    doc.setFillColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))

                    p_x=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["X"])
                    p_y=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea)

                    doc.rect(p_x ,p_y ,  parseFloat(tamano[1]) , parseFloat(tamano[0]) , 'F')

                  }
                  if (datos[0]=="cuadrado_cir"){

                    doc.setDrawColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))
                    doc.setFillColor(parseFloat(datos[1]), parseFloat(datos[2]), parseFloat(datos[3]))

                    p_x=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["X"])
                    p_y=parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea)

                   
                    doc.roundedRect(p_x ,p_y ,  parseFloat(tamano[1]) , parseFloat(tamano[0]) ,0.3,0.3, 'FD')

                  }
          
                  doc.setDrawColor(0, 0, 0)
                  doc.setFillColor(0, 0, 0)


            }else{
              doc.setFontSize(parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Tamano"]))
              doc.setFont("helvetica");
              doc.setFontStyle(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["TipoLetra"]);

              doc.text(parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea), Response["plantilla_pdf"]["plantillasetiquetas"][seg_pie["PkSegmento"]][z]["Nombre"]);
            }

        
    }  

    for (z = 0; z < Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]].length; z++) { 

        var valor = Response["valores_cab"][0][Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Campo"]].toString()
             
        valor = devolver_valor_imp(valor, Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Tipo"], Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Ext"])

        if(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Tipo"] == 'Derecha'){
          doc.text(parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea), valor.toString() , 'right');
        }else{

           if(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Tipo"] == 'Imagen'){
            var tag = 'pd'+pestana_int+'fff'+ z +'ccc'+ Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Campo"] +'_img'
            var imgData = getBase64Image(document.getElementById(tag), document.getElementById(tag).width, document.getElementById(tag).height )

            try {
                doc.addImage(imgData, 'JPEG', parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea), Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Ext"], Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Ext"])
            }
                catch(error) {
                console.error(error);
            // expected output: ReferenceError: nonExistentFunction is not defined
            // Note - error messages will vary depending on browser
            }




           }else{
            if(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Ext"] == 'center'){
              doc.text(parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea), valor.toString() , 'center');
            }else{
              doc.text(parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["X"]), parseFloat(Response["plantilla_pdf"]["plantillascamposcabecera"][seg_pie["PkSegmento"]][z]["Y"]) + parseFloat(linea), valor.toString() );
            }
              
           }
        }
    }  



    var date = new Date()

    doc.save(Response["tabla_cab"]["Nombre"] + '_' + date.toLocaleDateString() + " " + date.toLocaleTimeString() + '.pdf');

}



function devolver_str_limte(txt, limite) {
var devolver = []
  do {

    devolver.push(txt.substring(0,limite))
    txt = txt.substring(limite,txt.length-1)
  }
  while (txt.length >= limite);
  devolver.push(txt)
  return devolver
}


function getBase64Image(img, t_w, t_h) {
    // Create an empty canvas element
    var canvas = document.createElement("canvas");
    canvas.width = t_w;
    canvas.height = t_h;
    //canvas.width = img.width;
    //canvas.height = img.height;

    // Copy the image contents to the canvas
    var ctx = canvas.getContext("2d");
    //ctx.drawImage(img, 0, 0);

    try {
        ctx.drawImage(img,0,0,img.naturalWidth,img.naturalHeight,0,0,canvas.width,canvas.height);
            // Get the data-URL formatted image
        // Firefox supports PNG and JPEG. You could check img.src to
        // guess the original format, but be aware the using "image/jpg"
        // will re-encode the image.
        var dataURL = canvas.toDataURL("image/png");
        return dataURL
        //return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
    }
    catch(error) {
      console.error(error);
      return 0
      // expected output: ReferenceError: nonExistentFunction is not defined
      // Note - error messages will vary depending on browser
    }


}

function devolver_valor_imp( valor, tipo, ext){
  switch(tipo) {
    case "Color":
      return valor.toString()
    case "Imagen":
      return valor.toString()
    case "Normal":
      return valor.toString()
    case "Fecha":
      var date = new Date(valor)
      switch(ext){
        case "Dia":
          return date.format('d')
        case "Mes":
          return date.format('m')
        case "Anio":
          return date.format('Y')
        case "Letras":
          switch(date.format('m')) {
            case '01':
              return date.format('Y') + " Enero " + date.format('d')
            case '02':
              return date.format('Y') + " Febrero " + date.format('d')
            case '03':
              return date.format('Y') + " Marzo " + date.format('d')
            case '04':
              return date.format('Y') + " Abril " + date.format('d')
            case '05':
              return date.format('Y') + " Mayo " + date.format('d')
            case '06':
              return date.format('Y') + " Junio " + date.format('d')
            case '07':
              return date.format('Y') + " Julio " + date.format('d')
            case '08':
              return date.format('Y') + " Agosto " + date.format('d')
            case '09':
              return date.format('Y') + " Septiembre " + date.format('d')
            case '10':
              return date.format('Y') + " Octubre " + date.format('d')
            case '11':
              return date.format('Y') + " Noviembre " + date.format('d')
            case '12':
              return date.format('Y') + " Diciembre " + date.format('d')
          }
        case "Normal":
          return valor.toString()
        case "DDMMAAAA":
          return date.format('d') + date.format('m') + date.format('Y')
        case "LetrasMayusculas":
          switch(date.format('m')) {
            case 1:
              return date.format('Y') + " ENERO " + date.format('d')
            case 2:
              return date.format('Y') + " FEBRERO " + date.format('d')
            case 3:
              return date.format('Y') + " MARZO " + date.format('d')
            case 4:
              return date.format('Y') + " ABRIL " + date.format('d')
            case 5:
              return date.format('Y') + " MAYO " + date.format('d')
            case 6:
              return date.format('Y') + " JUNIO " + date.format('d')
            case 7:
              return date.format('Y') + " JULIO " + date.format('d')
            case 8:
              return date.format('Y') + " AGOSTO " + date.format('d')
            case 9:
              return date.format('Y') + " SEPTIEMBRE " + date.format('d')
            case 10:
              return date.format('Y') + " OCTUBRE " + date.format('d')
            case 11:
              return date.format('Y') + " NOVIEMBRE " + date.format('d')
            case 12:
              return date.format('Y') + " DICIEMBRE " + date.format('d')
          }
        case "Cheque":
              return date.format('d') + "/" +  date.format('m') + "/" +  date.format('Y')
        default:
          return valor.toString()
      }
    case "Derecha":
      var num = parseFloat(valor)
      switch(ext){  
        case "Normal":
          return num.toString()
        case "Numero":
          return num.toString()
        case "Miles":
          return formatMoney(num, ",", ".");
        case "Dolar":
          return '$ '+ formatMoney(num, ",", ".");
        case "Euro":
          return 'â¬ '+ formatMoney(num, ".", ",");
        case "Porcentaje":
          return  (num /100) + '%'
        case "Porcentaje_full":
          return  (num) + '%'
        default:
          return num.toString()
      }
    case "Numero":
      var num = parseFloat(valor)
      switch(ext){  
        case "Numero":
          return num.toString()
        case "Miles":  
          return formatMoney(num, ",", ".");
        case "Dolar":
          return '$ '+ formatMoney(num, ",", ".");
        case "Euro":
          return 'â¬ '+ formatMoney(num, ".", ",");
        case "Porcentaje":
          return  (num /100) + '%'
        case "Porcentaje_full":
          return  (num) + '%'

        default:
          return num.toString()
      }
    case "CerosFijos":
      return valor.toString()
    default:
  }
}

function formatMoney(n, c, d, t) {
  var c = isNaN(c = Math.abs(c)) ? 2 : c,
    d = d == undefined ? "." : d,
    t = t == undefined ? "," : t,
    s = n < 0 ? "-" : "",
    i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))),
    j = (j = i.length) > 3 ? j % 3 : 0;

  return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
}


function cambiar_imagen(id){

    var reader = new FileReader();

    reader.onload = function (e) {
        document.getElementById(id.id).src = e.target.result
        $(id.id).attr('src', e.target.result);
        window.cambio_img = 1
        tt_id = id.id
        tt_id =tt_id.replace('_img','_label') 
        label = document.getElementById(tt_id)

        label.innerHTML = '<a href="/media/archivos/{{Id_empresa}}/' + document.getElementById(id.id + '_file').files[0].name + '" target="_blank"><img id="' + id.id + '" style="width: 80%;height: 60%;margin-left: auto;margin-right: auto; display: block;" src="/media/archivos/{{Id_empresa}}/' + document.getElementById(id.id + '_file').files[0].name + '" alt="image">' + document.getElementById(id.id + '_file').files[0].name + '</a>'


          //const files = document.getElementById(envio_archi[x2]).files
          const files = document.getElementById(id.id + '_file').files
          const formData = new FormData()
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')
            formData.append('Id_empresa','{{Id_empresa}}')
            formData.append('id_archivo',document.getElementById(id.id + '_file').files[0].name)

          for (let i = 0; i < files.length; i++) {
            let file = files[i]

            formData.append('files', file)
          }

          fetch('/archi_carg', {method: 'POST',body: formData,}).then(response => {
            console.log(response)
            const ele_imagen = document.getElementById(id.id + '_file').files
            ele_imagen.attr('src', '/media/archivos/{{Id_empresa}}/' + document.getElementById(id.id + '_file').files[0].name);


        })


    }

    reader.readAsDataURL(document.getElementById(id.id + '_file').files[0]);

}

calendario_val = {}


function calendario() {
    calendario_val = {}
    z_campos = document.getElementById("calendar_date")
    var v_fecha = new Date(z_campos.value);
    var v_fecha_mov = new Date(z_campos.value);
    var v_fecha_movA = new Date(z_campos.value);
    var v_fecha_act = new Date(z_campos.value);
    ajuste = 0
    if(v_fecha.getDate() != v_fecha.getDaysInMonth()){
        v_fecha_mov.addDays(((v_fecha.format('d')-1) *-1))
        v_fecha_movA.addDays(((v_fecha.format('d')-1) *-1))
    }


    //para atras  getDay()
    dia = v_fecha_mov.getDay()
    diaA = v_fecha_movA.getDay()
    dia_sele = ''
    for (ee = 0; ee <= 34; ee++) { 
        tap = document.getElementById("cal-" + ee)
        tap.innerHTML = ''

    }

    aa = 0
    if(diaA == 0){diaA = 7}
    for (ee = (diaA); ee > 1; ee--) { 
        try {
            v_fecha_movA.addDays(-1)
            tap = document.getElementById("cal-" + (ee-2))
            tap.innerHTML = '<div>' + v_fecha_movA.format('d') + '</div><div style="overflow: auto;text-align: left;height: 60px;" id="in-' + tap.id + '"></div>'
            tap.style.backgroundColor = "cornsilk"
            calendario_val[v_fecha_mov.format('Y-m-d')]= tap.id

                  }
        catch(error) {
          console.error(error);
          // expected output: ReferenceError: nonExistentFunction is not defined
          // Note - error messages will vary depending on browser
        }




    }
    if(dia == 0){dia = 7}
    
    v_fecha_act.addDays(1)
    aa = 0
    for (ee = 0; ee <= (v_fecha.getDaysInMonth()-1); ee++) { 
        if ((ee + dia-1) < 35){
            tap = document.getElementById("cal-" + (ee + dia-1))
            tap.innerHTML = '<div>' + v_fecha_mov.format('d') + '</div><div style="overflow: auto;text-align: left;height: 60px;" id="in-' + tap.id + '"></div>'
            if(v_fecha_mov.format('d') == v_fecha_act.format('d')){
                tap.style.backgroundColor = "aqua"
            }else{
                tap.style.backgroundColor = "aliceblue"
            }
            calendario_val[v_fecha_mov.format('Y-m-d')]= tap.id
            //if(v_fecha_mov.format('d') == v_fecha.getDaysInMonth()){
            //    tap.style.backgroundColor = "cornsilk"
            //}

            v_fecha_mov.addDays(1)           
               
        
          // expected output: ReferenceError: nonExistentFunction is not defined
          // Note - error messages will vary depending on browser
        

        }


    }
    for (ee = v_fecha.getDaysInMonth(); ee <= (34 - dia+1); ee++) { 

            tap = document.getElementById("cal-" + (ee + dia-1))
            tap.innerHTML = '<div>' + v_fecha_mov.format('d') + '</div><div style="overflow: auto;text-align: left;height: 60px;" id="in-' + tap.id + '"></div>'
            tap.style.backgroundColor = "cornsilk"
            calendario_val[v_fecha_mov.format('Y-m-d')]= tap.id
            if(v_fecha_mov.format('d') == v_fecha.getDaysInMonth()){
                if(v_fecha_mov.format('d') == v_fecha_act.format('d')){
                    tap.style.backgroundColor = "aqua"
                }else{
                    tap.style.backgroundColor = "aliceblue"
                }
            }
            v_fecha_mov.addDays(1)
                  
       
          // expected output: ReferenceError: nonExistentFunction is not defined
          // Note - error messages will vary depending on browser
        

        
    }

    tap = document.getElementById("cal-" + (ee + dia-1))

    Poner_calendario()
}
respuesta_calendario = {}

function abir_calen(calen, fila) {
    nom_calen = respuesta_calendario["calendarios"][calen]["nombre"]

    respuesta_calendario["cal_valores"][nom_calen][fila]

    data_cal = '<table class="table table-bordered"><thead><tr style="align-content: center;">'

    for (ee = 0; ee <= (Object.keys(respuesta_calendario["cal_valores"][nom_calen][fila]).length-1); ee++){
      data_cal  = data_cal + '<th style="text-align: center;">'+ Object.keys(respuesta_calendario["cal_valores"][nom_calen][fila])[ee] + '</th>'
    }

    data_cal = data_cal + '</tr></thead><tbody><tr>'


    for (ee = 0; ee <= (Object.keys(respuesta_calendario["cal_valores"][nom_calen][fila]).length-1); ee++){
      data_cal  = data_cal + '<td>'+ respuesta_calendario["cal_valores"][nom_calen][fila][Object.keys(respuesta_calendario["cal_valores"][nom_calen][fila])[ee]] + '</td>'
    }
    data_cal = data_cal + '</tr></tbody></table>'

    cal = document.getElementById("calen_resul")
    cal.innerHTML = data_cal
}

function Poner_calendario() {
        z_campos = document.getElementById("calendar_date")
        var v_fecha = new Date(z_campos.value);
        $.ajax({
            type: "POST",
            url: '/calendar',
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}', 'fecha':v_fecha.format('Y-m-d')},
            success: function(data)
            {   
                respuesta_calendario = data
                for (ee = 0; ee <= (data["calendarios"].length-1); ee++) { 
                    for (ee2 = 0; ee2 <= (data["cal_valores"][data["calendarios"][ee]["nombre"]].length-1); ee2++) { 
                        limite = Object.keys(calendario_val).length-1
                        for (ss = 0; ss <=limite; ss++) {
                            var fec_A = Object.keys(calendario_val)[ss]
                            var fec_B = new Date(data["cal_valores"][data["calendarios"][ee]["nombre"]][ee2][data["calendarios"][ee]["fecha_vin"]]);
                            if(data["calendarios"][ee]["fecha_lapso"] == 0){
                                if(fec_A == fec_B.format('Y-m-d')){
                                    div_int = document.getElementById("in-"+calendario_val[Object.keys(calendario_val)[ss]])
                                    div_int.innerHTML = div_int.innerHTML  + '<p onclick="abir_calen('+ ee +', '+ ee2 +')" style="cursor: pointer;text-align: left;background: '+data["calendarios"][ee]["color"]+';"><i class="'+data["calendarios"][ee]["icono"]+'" style="text-align: left;"></i><b> '+ data["cal_valores"][data["calendarios"][ee]["nombre"]][ee2][data["calendarios"][ee]["display"]] +'</b></p>' 
                                }
                            }
                            else{
                                var fec_c = new Date(data["cal_valores"][data["calendarios"][ee]["nombre"]][ee2][data["calendarios"][ee]["fecha_lapso"]]);

                                if(fec_A >= fec_B.format('Y-m-d') && fec_A <= fec_c.format('Y-m-d') ){
                                    div_int = document.getElementById("in-"+calendario_val[Object.keys(calendario_val)[ss]])
                                    div_int.innerHTML = div_int.innerHTML  + '<p onclick="abir_calen('+ ee +', '+ ee2 +')" style="cursor: pointer;text-align: left;background: '+data["calendarios"][ee]["color"]+';"><i class="'+data["calendarios"][ee]["icono"]+'" style="text-align: left;"></i> <b>'+ data["cal_valores"][data["calendarios"][ee]["nombre"]][ee2][data["calendarios"][ee]["display"]] +'</b></p>' 
                                }

                            }

                        } 


                    }
                }

            }
         });

}


function cerrar_elemento_todo() {
    for (ss = 0; ss <=pestalla; ss++) {
        cerrar_elemento(ss)

    }

}


function traer_alertas() {
    
         $.ajax({
            type: "POST",
            url: '/alertas',
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'Id_empresa':'{{Id_empresa}}', 'usuario':'{{usuario}}', 'idioma':'{{ idioma }}'},
            success: function(data)
            {   
                conta_todo = 0
                html_alertas = ''
                for (aa = 0; aa <= data["alertas"].length-1; aa++) {
                    for (aa2 = 0; aa2 <= data["alertas"][aa]["val"].length-1; aa2++) {
                        html_alertas = html_alertas + '<li onclick="ver_alertas(' + data["alertas"][aa]['val'][aa2]["a_pkmodulo"] + ', ' + data["alertas"][aa]['val'][aa2]["a_pkregistro"] + ')"><a><span><i class="' + data["alertas"][aa]["acc"]["logo"] + '"></i> </span><span> ' + data["alertas"][aa]["acc"]["t_campo"] + '</span><span class="time">'+ data["alertas"][aa]['val'][aa2][data["alertas"][aa]["acc"]["t_campo"]] +'</span><span class="message" style="text-align: center;">' + data["alertas"][aa]['val'][aa2][data["alertas"][aa]["acc"]["val_msg"]] + '</span></a></li>'
                        conta_todo = conta_todo + 1
                    }
                }
                html_alertas = html_alertas + '<li><div class="text-center"><a onclick="traer_alertas()"><strong><i class="fa fa-retweet"></i> Actualizar</strong></a></div></li>'

            var dd = document.getElementById('menu1')

            dd.innerHTML = html_alertas

            var dd = document.getElementById('val_alerta')
            dd.innerHTML = conta_todo

            setTimeout(traer_alertas, 1800000);
            }
            });

}

function ver_alertas(a_pkmodulo, a_pkregistro) {
    if(a_pkmodulo != 0){
        registro(a_pkmodulo, a_pkregistro, 2, 'consulta',0)        
    }

}
function solo_numero(e) {
    //See notes about 'which' and 'key'
    if(event.keyCode > 47 && event.keyCode < 58 || event.keyCode == 46){

    }else{             
        if(event.keyCode != 13){
            event.keyCode=0;
            return false;
        }         
    }

}
 

</script>


  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <p class="site_title"><i class="fa fa-bar-chart" style="border: 0px;"></i> <span>{{Id_empresa}}</span></p>
              <img style="display: none;" id="logo_cia" src="/media/archivos/{{Id_empresa}}/logo.png" alt="image"  value="logo.png">
            </div>


            <div class="clearfix"></div>

            <br />
          <!-- <form name="Reportes" method="post"> -->
          {% csrf_token %}

            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>Menu</h3>
                <ul class="nav side-menu">

              {% for id in menu %}
                  <li><a><i class="{{ id.icono }}"></i> {{ id.Nombre }} <span class="fa fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                    {% for pkmodulo in modulos %}{% if id.PkModGen == pkmodulo.PkModGen %}{% if pkmodulo.formtipo == "Registro" %}<li><a class="dropdown-item" id="{{ pkmodulo.id }}" value="registro" result="{{ pkmodulo.mdesc }}">{{ pkmodulo.mdesc }}</a></li>{% endif %}{% if pkmodulo.formtipo == "Reporte" %}  
                          <li><a>{{ pkmodulo.mdesc }}<span class="fa fa-chevron-down"></span></a><ul class="nav child_menu">{% for repor in reportes %}{% if repor.Pkmodulo == pkmodulo.PkModulo %}
                                <li><a class="dropdown-item" id="{{ repor.PkReporte }}" value="reporte" result="{{ repor.diplay }}">{{ repor.diplay }}</a></li>{% endif %}{% endfor %}</ul></li>{% endif %}{% endif %}{% endfor %}</ul>{% endfor %}                               
                  </li>
                </ul>
              </div>
              <div class="menu_section">
              </div>

            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons 
            <div class="sidebar-footer hidden-small">
              <a data-toggle="tooltip" data-placement="top" title="Settings">
                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
              </a>
              <a data-toggle="tooltip" data-placement="top" title="FullScreen">
                <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
              </a>
              <a data-toggle="tooltip" data-placement="top" title="Lock">
                <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
              </a>
              <a data-toggle="tooltip" data-placement="top" title="Logout" href="login.html">
                <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
              </a>
            </div>-->
            <!-- /menu footer buttons -->
          </div>
        </div>


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav>
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>

              <ul class="nav navbar-nav navbar-right">
                <li class="">
                  <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <img src="images/img.jpg" alt=""><i class="fa fa-user"></i> Herramientas 
                    <span class=" fa fa-angle-down"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-usermenu pull-right">
                    <li>
                        <div class="input-group">
                        Validar Ruc <input type="text" id="val_ruc" class="form-control col-sm-2" style="height: 25px;font-size: 11px;"> 

                        <button type="button" class="btn btn-primary" onclick="pre_ejecutados()" style="height: 25px;padding: 3px 4px;"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>

                        </div>
                    </li>
                    <li>
                        <div class="input-group">
                            <a href="/{{Id_empresa}}/eshop/lista" target="_blank">Lista de precios</a>
                        </div>
                    </li>
                    <li><a onclick="cerrar_elemento_todo()">Cerrar Todo</a></li>
                  </ul>
                  
                </li>

                <li class="">
                  <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <img src="images/img.jpg" alt=""><i class="fa fa-user"></i> {{usuario}} 
                    <span class=" fa fa-angle-down"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-usermenu pull-right">
                    <li><a>{{datos_user.0.Apellido}}, {{datos_user.0.Nombre}}</a></li>
                    <li><a>{{datos_user.0.Cargo}}</a></li>

                   
                    <li><a href="/{{idioma}}/log"><i class="fa fa-sign-out pull-right"></i> Salir </a></li>
                  </ul>

                </li>

                <li role="presentation" class="dropdown">
                  <a href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-envelope-o"></i>
                    <span class="badge bg-green" id="val_alerta">0</span>
                  </a>
                  <ul id="menu1" class="dropdown-menu list-unstyled msg_list" role="menu">
                    <li>
                      <div class="text-center">
                        <a onclick="traer_alertas()"><strong><i class="fa fa-retweet"></i> Actualizar</strong><i class="fa fa-angle-right"></i>
                        </a>
                      </div>
                    </li>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
                   
                  <div class="x_content">

                    <div class="" role="tabpanel" data-example-id="togglable-tabs">
                      <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#tab_content1" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true">{{idioma_html.inicio}}</a>
                        </li>
                        <li role="presentation" class=""><a href="#tab_content2" id="calendar-tab" role="tab" data-toggle="tab" aria-expanded="false">Calendario</a>
                        </li>
                      </ul>

                      <div id="myTabContent" class="tab-content">
                        <div role="tabpanel" class="tab-pane fade active in" id="tab_content1" aria-labelledby="home-tab">

                            <div class="row" role="main">
                                <div id="panel_cemaforo" class="row" style="padding-top: 15px;">
                                    <div class="col-md-12">
                                      <div class="col-middle">
                                          <div class="text-center text-center">
                                              <h1 class="error-number"></h1>
                                              <h2>{{idioma_html.espere}}</h2>
                                              <p>{{idioma_html.carga}}.</p>
                                                <div class="weather-icon">
                                                    <span><canvas height="84" width="84" id="partly-cloudy-day"></canvas></span>
                                                </div>
                                          </div>
                                      </div>
                                    </div>
                                </div>
                            </div>
        
                        </div>
<div role="tabpanel" class="tab-pane fade active in" id="tab_content2" aria-labelledby="home-tab">
    <div class="row" role="main">
        <div id="panel_calendario" class="row" style="padding-top: 15px;">
            <div class="col-md-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>Calendario</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content" style="text-align: center;">
                        <div class="row">
                        <input type="date" id="calendar_date" onchange="calendario()"> 
                        </div>
                        <div class="row">
                            <table class="table table-bordered">
                                <thead>
                                <tr style="align-content: center;"> 
                                  <th style="text-align: center;">Lunes</th>
                                  <th style="text-align: center;">Martes</th>
                                  <th style="text-align: center;">Miercoles</th>
                                  <th style="text-align: center;">Jueves</th>
                                  <th style="text-align: center;">Viernes</th>
                                  <th style="text-align: center;">Sabado</th> 
                                <th style="text-align: center;">Domingo</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td id="cal-0"></td>
                                    <td id="cal-1"></td>
                                    <td id="cal-2"></td>
                                    <td id="cal-3"></td>
                                    <td id="cal-4"></td>
                                    <td id="cal-5"></td>
                                    <td id="cal-6"></td>
                                </tr>
                                <tr>   
                                    <td id="cal-7"></td>
                                    <td id="cal-8"></td>
                                    <td id="cal-9"></td>
                                    <td id="cal-10"></td>
                                    <td id="cal-11"></td>
                                    <td id="cal-12"></td>
                                    <td id="cal-13"></td>
                                </tr>
                                <tr>
                                    <td id="cal-14"></td>
                                    <td id="cal-15"></td>
                                    <td id="cal-16"></td>
                                    <td id="cal-17"></td>
                                    <td id="cal-18"></td>
                                    <td id="cal-19"></td>
                                    <td id="cal-20"></td>
                                </tr>
                                <tr>
                                    <td id="cal-21"></td>
                                    <td id="cal-22"></td>
                                    <td id="cal-23"></td>
                                    <td id="cal-24"></td>
                                    <td id="cal-25"></td>
                                    <td id="cal-26"></td>
                                    <td id="cal-27"></td>
                                </tr>
                                <tr>
                                    <td id="cal-28"></td>
                                    <td id="cal-29"></td>
                                    <td id="cal-30"></td>
                                    <td id="cal-31"></td>
                                    <td id="cal-32"></td>
                                    <td id="cal-33"></td>
                                    <td id="cal-34"></td>
                                </tr>
                            </tbody>
                            </table>
                            <div class="row">
                                <div id="calen_resul"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                </div>
                </div>
                </div>

                <div class="x_content">
                </div>
                </div>
                </div>


                  <div class="modal fade bs-example-modal-md" tabindex="-1" role="dialog" aria-hidden="true" id="modal3">
                    <div class="modal-dialog modal-md">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="utton" class="close" data-dismiss="modal"><span aria-hidden="true">Ã</span>
                          </button>
                          <h4 class="modal-title" id="myModalLabel">{{idioma_html.detalle}}</h4>
                        </div>
                        <div class="modal-body">
                          <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                              <input type="hidden" id="vfinal_bus_2" class="form-control col-md-7 col-xs-12">
                            </div>
                          </div>
                          <div id="intreportemodal">
                          </div>  
                        </div>
                      </div>
                    </div>
                  </div>

                <div class="modal fade bs-example-modal-xs" tabindex="-1" role="dialog" aria-hidden="true" id="modal4">
                    <div class="modal-dialog modal-xs">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="utton" id='cerrar_grabar' class="close" data-dismiss="modal"><span aria-hidden="true">Ã</span>
                          </button>
                          <h4 class="modal-title" id="myModalLabel">{{idioma_html.detalle}}</h4>
                        </div>
                        <div class="modal-body">
                          <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                              <input type="hidden" id="vfinal_bus_2" class="form-control col-md-7 col-xs-12">
                            </div>
                          </div>
                            <div class="text-center text-center">
                              <h1 class="error-number"></h1>
                              <h2>{{idioma_html.espere}}</h2>
                              <p>{{idioma_html.carga}}.</p>
                              <div class="weather-icon">
                                <span>
                                    <canvas height="32" width="32" id="wind"></canvas>
                                </span>
                                <div id="div_grabador"> </div>
                              </div>
                            </div>
                        </div>
                      </div>
                    </div>
                  </div>
                

                  <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true" id="modal1">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã</span>
                          </button>
                          <h4 class="modal-title" id="myModalLabel">{{idioma_html.Buscador}}</h4>
                        </div>
                        <div class="modal-body">
                          <div class="form-group">
                            
                            <div class="col-md-6 col-sm-6 col-xs-12">
                              <input type="hidden" id="vfinal_bus_2" class="form-control col-md-7 col-xs-12">
                            </div>
                          </div>
                          <input type="hidden" id="vfinal_bus" name="vfinal_bus" value=""> 
                          <input type="hidden" id="buscador_senten" name="buscador_senten" value=""> 

                          <div id="intbuscador">
                          </div>  
                        </div>
                      </div>
                    </div>
                  </div>

                <div class="modal fade bs-example-modal-sm"  tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-sm" > <!--style="width: 800px;" -->
                      <div class="modal-content">

                        <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã</span>
                          </button>
                        <div id="intnotaCab">

                        </div>


                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">{{idioma_html.eliminar_txt}}</span>    </button>

                        mover a <select class="nota_tarea_txt" id="nota_tarea_cbx" onchange="movernota()">
                        {% for list in estados %}<option>{{list.nombre}}</option>{% endfor %}
                          </select>
                    </div>
                <div>

                <div class="x_panel">
                  <div class="x_content">
                    <div class="" role="tabpanel" data-example-id="togglable-tabs">
                      <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">

                        <li role="presentation" class="active"><a href="#nota_txt" id="nota-tab" role="tab" data-toggle="tab" aria-expanded="true">{{idioma_html.texto}}</a>
                        </li>
                        <li role="presentation" class=""><a href="#nota_adj" role="tab" id="nota-tab2" data-toggle="tab" aria-expanded="false">{{idioma_html.adjunto}}</a>
                        </li>
                        <li role="presentation" class=""><a href="#nota_tarea" role="tab" id="nota-tab3" data-toggle="tab" aria-expanded="false">{{idioma_html.tarea}}</a>
                        </li>
                        <li role="presentation" class=""><a href="#nota_doc" role="tab" id="nota-tab4" data-toggle="tab" aria-expanded="false">{{idioma_html.documento}}</a>
                        </li>

                      </ul>
                      <input type="hidden" id="vpk_nota" name="vpk_nota" value=""> 

                      <div id="myTabContent" class="tab-content">
                        <div role="tabpanel" class="tab-pane fade active in" id="nota_txt" aria-labelledby="home-tab">
                            <textarea id="vpk_nota_txt" required="required" class="form-control" name="vpk_nota_txt" data-parsley-trigger="keyup" data-parsley-minlength="20" data-parsley-maxlength="100" data-parsley-minlength-message="Come on! You need to enter at least a 20 caracters long comment.." data-parsley-validation-threshold="10"></textarea>
                            <button type="button" class="btn btn-primary" onclick="nota_texto()"><span class="fa fa-comment" aria-hidden="true">{{idioma_html.add}}</span></button>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="nota_adj" aria-labelledby="profile-tab">
                          
                           <div class="x_content">
                            <p>{{idioma_html.adjunto_des}}</p>


                            <form method="post" enctype="multipart/form-data" id="form_nota">
                              {% csrf_token %}
                              <input type="file" name="myfile_nota" id="myfile_nota">
                              <input type="hidden" name="Id_empresa" value="{{Id_empresa}}" >
                              <button type="submit">Upload</button>

                              <button onclick="subir_archivo_nota2();" type="button" class="btn btn-primary">{{idioma_html.subir}}</button>
                            </form>


                            <!--<input type="file" name="files[]" id="input_files" />
                            <button onclick="subir_archivo_nota();" type="button" class="btn btn-primary">{{idioma_html.subir}}</button>-->
                            <div id="div_update_file" > </div>
                          </div>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="nota_tarea" aria-labelledby="profile-tab">
                          <p>{{idioma_html.tarea_des}}</p>
                          <input type="text" class="form-control" id="vpk_nota_tarea" name="nota_tarea_txt" value="" placeholder="{{idioma_html.ing_tarea}}"> 
                          <input type="text" id="vpk_nota_responsable"class="form-control" readonly="readonly" placeholder="{{idioma_html.responsable}}">
                          <select class="nota_tarea_txt" id="nota_tarea_cbx">
                                                {% for usuario in list_user %}
                                                <option>{{usuario.usuario}}</option>
                                                {% endfor %}
                          </select>
                          <button type="button" class="btn btn-primary" onclick="incrementar_resp()"><span>{{idioma_html.add}}</span></button>
                          <button type="button" class="btn btn-primary" onclick="crear_resp()"><span>{{idioma_html.crear_add}}</span></button>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="nota_doc" aria-labelledby="profile-tab">
                          <p>{{idioma_html.documento_des}}</p>


                          
                          <select class="nota_tarea_txt" id="nota_doc_menu_cbx" onchange="nota_doc_filtrar()">
                           {% for id in menu %}<option>{{ id.Nombre }}</option>{% endfor %}
                                                
                                                
                          </select>
                          <select class="nota_tarea_txt" id="nota_doc_proceso_cbx" onchange="nota_doc_buscar()">
                                           
                          </select>
                         

                          <br>
                          <label>Identificador: </label> 
                          <select class="nota_tarea_txt" id="nota_doc_proceso_campoiden" onchange="limpiarnota_doc_buscar()">                 
                          </select>
                          <input type="text" readonly="readonly" id="nota_doc_proceso_valoriden">
                          <input type="hidden" id="nota_doc_proceso_pk" value="">
                          <button class="btn btn-primary" onclick="nota_doc_grabar()" ><span class="fa fa-save" aria-hidden="true"></button>

                          

                          <div id="divbusca_nota_doc" style="overflow: auto;"></div>

                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
                        <!--<div style="width: 800px; background: whitesmoke;" id="intnota"> -->
                        <div style="width: 800px; background: whitesmoke;" id="intnota">

                        </div>
                        

                      </div>
                    </div>
                  </div>


        <!-- /page content -->

        <!-- footer content -->
        <footer>
          <div class="pull-right">
          <div class="clearfix">
       

          </div>
        </footer>
        <input type="file" id="archivo_p12" accept="data:application/x-pkcs12" style="display: none;">
        <button type="button" id='btn_grabar' data-toggle="modal" data-target=".bs-example-modal-xs" style="display: none;"></button>
     </div>
    </div>

     <script type="text/javascript">
     nota_doc_filtrar()

       </script>

  <!-- jQuery -->
    <script src="/static/vendors/bootstrap-wysiwyg/js/bootstrap-wysiwyg.min.js"></script>


    <script src="/static/vendors/jquery.hotkeys/jquery.hotkeys.js"></script>
    <script src="/static/vendors/google-code-prettify/src/prettify.js"></script>
    <!-- jQuery Tags Input -->
    <script src="/static/vendors/jquery.tagsinput/src/jquery.tagsinput.js"></script>
    <!-- Switchery -->
    <script src="/static/vendors/switchery/dist/switchery.min.js"></script>
    <!-- Select2 -->
    <script src="/static/vendors/select2/dist/js/select2.full.min.js"></script>
    <!-- Parsley -->
    <script src="/static/vendors/parsleyjs/dist/parsley.min.js"></script>
    <!-- Autosize -->
    <script src="/static/vendors/autosize/dist/autosize.min.js"></script>
    <!-- jQuery autocomplete -->
    <script src="/static/vendors/devbridge-autocomplete/dist/jquery.autocomplete.min.js"></script>
    <!-- starrr -->
    <script src="/static/vendors/starrr/dist/starrr.js"></script>
    <!-- Custom Theme Scripts -->

    <!-- jQuery -->
    <script src="/static/vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="/static/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="/static/vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="/static/vendors/nprogress/nprogress.js"></script>
    <!-- Chart.js -->
    <script src="/static/vendors/Chart.js/dist/Chart.min.js"></script>
    <!-- gauge.js -->
    <script src="/static/vendors/gauge.js/dist/gauge.min.js"></script>
    <!-- bootstrap-progressbar -->
    <script src="/static/vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
    <!-- iCheck -->
    <script src="/static/vendors/iCheck/icheck.min.js"></script>
    <!-- Skycons -->
    <script src="/static/vendors/skycons/skycons.js"></script>
    <!-- Flot -->
    <script src="/static/vendors/Flot/jquery.flot.js"></script>
    <script src="/static/vendors/Flot/jquery.flot.pie.js"></script>
    <script src="/static/vendors/Flot/jquery.flot.time.js"></script>
    <script src="/static/vendors/Flot/jquery.flot.stack.js"></script>
    <script src="/static/vendors/Flot/jquery.flot.resize.js"></script>
    <!-- Flot plugins -->
    <script src="/static/vendors/flot.orderbars/js/jquery.flot.orderBars.js"></script>
    <script src="/static/vendors/flot-spline/js/jquery.flot.spline.min.js"></script>
    <script src="/static/vendors/flot.curvedlines/curvedLines.js"></script>
    <!-- DateJS -->
    <script src="/static/vendors/DateJS/build/date.js"></script>
    <!-- JQVMap -->
    <script src="/static/vendors/jqvmap/dist/jquery.vmap.js"></script>
    <script src="/static/vendors/jqvmap/dist/maps/jquery.vmap.world.js"></script>
    <script src="/static/vendors/jqvmap/examples/js/jquery.vmap.sampledata.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="/static/vendors/moment/min/moment.min.js"></script>
    <script src="/static/vendors/bootstrap-daterangepicker/daterangepicker.js"></script>

    <!-- Custom Theme Scripts -->
    <script src="/static/build/js/custom.min.js"></script>
	

    <script src="/static/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/static/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="/static/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/static/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="/static/vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/static/vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/static/vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/static/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="/static/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="/static/vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="/static/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="/static/vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="/static/vendors/dropzone/dist/min/dropzone.min.js"></script>


    <script src="/static/vendors/jquery.tagsinput/src/jquery.tagsinput.js"></script>

    <script src="/static/raphael-2.1.4.min.js"></script>
    <script src="/static/justgage.js"></script>
  </body>
</html>
<!--       _
       .__(.)< (MEOW)
        \___)   
 ~~~~~~~~~~~~~~~~~~-->

